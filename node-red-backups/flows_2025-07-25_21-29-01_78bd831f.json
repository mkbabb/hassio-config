[{"id":"4f871e90.29a61","type":"tab","label":"Cache Home ðŸ¡","disabled":false,"info":""},{"id":"fbed070118aafd67","type":"tab","label":"Is Home ðŸ”","disabled":false,"info":"","env":[]},{"id":"a807a4834abd67fa","type":"tab","label":"Day ðŸŒž/Night ðŸŒš","disabled":false,"info":"","env":[]},{"id":"88965fe6e95d05d9","type":"tab","label":"Thermostat Time of Use","disabled":true,"info":"","env":[]},{"id":"e921812388e8a474","type":"tab","label":"Plants ðŸŒ±","disabled":false,"info":"","env":[]},{"id":"4b8fb0bd081363a3","type":"tab","label":"Blinds ðŸ•¶ï¸","disabled":false,"info":"","env":[]},{"id":"2c89cfc34655fd37","type":"tab","label":"Bathroom Fans ðŸš½","disabled":false,"info":"","env":[]},{"id":"f5468ca00e94e761","type":"tab","label":"Presence","disabled":false,"info":"","env":[]},{"id":"e05fae85092ccf96","type":"tab","label":"Batteries","disabled":false,"info":"","env":[]},{"id":"f8ef387edcc58dc1","type":"tab","label":"Piano ðŸŽ¹","disabled":false,"info":"","env":[]},{"id":"6337f535d7b8e1f2","type":"tab","label":"Remote Entities","disabled":false,"info":"","env":[]},{"id":"dc6c7d82059d5798","type":"subflow","name":"Cache House States Away","info":"","category":"","in":[{"x":780,"y":300,"wires":[{"id":"56f025da62a8d8d2"}]}],"out":[{"x":2600,"y":200,"wires":[{"id":"b2ddf5f85a905ce5","port":0},{"id":"1a5c3203a07c6ee2","port":0}]},{"x":2600,"y":400,"wires":[{"id":"21c1a8c17bfc6589","port":0},{"id":"7e5af03335f043f5","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"e920ad5e223ac1b7","type":"subflow","name":"Get Domain Entities","info":"","category":"","in":[{"x":60,"y":320,"wires":[{"id":"8977e9e20795950e"}]}],"out":[{"x":2220,"y":440,"wires":[{"id":"fe549fb394a9227a","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"c15b1459ec3be250","type":"subflow","name":"Set Unavailable","info":"","category":"","in":[{"x":20,"y":260,"wires":[{"id":"9d3b8f61955a9bcb"}]}],"out":[{"x":680,"y":260,"wires":[{"id":"f7044577138e7cbf","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"173c5faccfb73051","type":"subflow","name":"Presence Subflow","info":"","category":"","in":[{"x":200,"y":660,"wires":[{"id":"5cc3e854cdde0e1c"}]}],"out":[],"env":[],"meta":{},"color":"#DDAA99"},{"id":"b0e3e1c3c40d9540","type":"subflow","name":"Get Area Entities","info":"","category":"","in":[{"x":880,"y":520,"wires":[{"id":"5279b8dcf7ae15f1"}]}],"out":[{"x":2140,"y":360,"wires":[{"id":"627b25edecfe582e","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"bfb9a6c8a64bb052","type":"subflow","name":"Set Null User","info":"","category":"","in":[{"x":80,"y":280,"wires":[{"id":"60083ad5e2e0f3ca"}]}],"out":[{"x":860,"y":280,"wires":[{"id":"abe85fa98c6de34f","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"8021f5177f6126d9","type":"subflow","name":"Action Node with Check","info":"","category":"","in":[{"x":60,"y":200,"wires":[{"id":"34bb6d2d5ed5afb9"}]}],"out":[{"x":1440,"y":200,"wires":[{"id":"4af6c987e04e44bc","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"685bfaf1e94471c7","type":"subflow","name":"Force Set State","info":"","category":"","in":[{"x":60,"y":320,"wires":[{"id":"198f6f354b3b8fe4"}]}],"out":[{"x":900,"y":320,"wires":[{"id":"03c9f469b8580746","port":0}]}],"env":[],"meta":{},"color":"#DDAA99"},{"id":"79544c2b.6ccc64","type":"server","name":"Home Assistant","version":5,"addon":true,"rejectUnauthorizedCerts":true,"ha_boolean":"y|yes|true|on|home|open","connectionDelay":true,"cacheJson":true,"heartbeat":false,"heartbeatInterval":30,"areaSelector":"friendlyName","deviceSelector":"friendlyName","entitySelector":"friendlyName","statusSeparator":"at: ","statusYear":"hidden","statusMonth":"short","statusDay":"numeric","statusHourCycle":"h23","statusTimeFormat":"h:m","enableGlobalContextStore":true},{"id":"eed41b44.0c507","type":"ui_base","theme":{"name":"theme-light","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#0094CE","value":"#0094CE","edited":false},"page-titlebar-backgroundColor":{"value":"#0094CE","edited":false},"page-backgroundColor":{"value":"#fafafa","edited":false},"page-sidebar-backgroundColor":{"value":"#ffffff","edited":false},"group-textColor":{"value":"#1bbfff","edited":false},"group-borderColor":{"value":"#ffffff","edited":false},"group-backgroundColor":{"value":"#ffffff","edited":false},"widget-textColor":{"value":"#111111","edited":false},"widget-backgroundColor":{"value":"#0094ce","edited":false},"widget-borderColor":{"value":"#ffffff","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey"}},"site":{"name":"Node-RED Dashboard","hideToolbar":"false","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"8c5c5002.bcdab","type":"server","d":true,"name":"hassio","version":5,"addon":true,"rejectUnauthorizedCerts":true,"ha_boolean":"y|yes|true|on|home|open","connectionDelay":true,"cacheJson":true,"heartbeat":false,"heartbeatInterval":"30","areaSelector":"friendlyName","deviceSelector":"friendlyName","entitySelector":"friendlyName","statusSeparator":"at: ","statusYear":"hidden","statusMonth":"short","statusDay":"numeric","statusHourCycle":"h23","statusTimeFormat":"h:m","enableGlobalContextStore":true},{"id":"cf1a8b1e.5bfb5","type":"server","d":true,"name":"hassio","version":5,"addon":true,"rejectUnauthorizedCerts":true,"ha_boolean":"y|yes|true|on|home|open","connectionDelay":true,"cacheJson":true,"heartbeat":false,"heartbeatInterval":"30","areaSelector":"friendlyName","deviceSelector":"friendlyName","entitySelector":"friendlyName","statusSeparator":"at: ","statusYear":"hidden","statusMonth":"short","statusDay":"numeric","statusHourCycle":"h23","statusTimeFormat":"h:m","enableGlobalContextStore":true},{"id":"214b25c1.8d3f0a","type":"server","d":true,"name":"hassio","version":5,"addon":true,"rejectUnauthorizedCerts":true,"ha_boolean":"y|yes|true|on|home|open","connectionDelay":true,"cacheJson":true,"heartbeat":false,"heartbeatInterval":"30","areaSelector":"friendlyName","deviceSelector":"friendlyName","entitySelector":"friendlyName","statusSeparator":"at: ","statusYear":"hidden","statusMonth":"short","statusDay":"numeric","statusHourCycle":"h23","statusTimeFormat":"h:m","enableGlobalContextStore":true},{"id":"cc2ae6f9.bf95f","type":"server","d":true,"name":"hassio","version":5,"addon":true,"rejectUnauthorizedCerts":true,"ha_boolean":"y|yes|true|on|home|open","connectionDelay":true,"cacheJson":true,"heartbeat":false,"heartbeatInterval":"30","areaSelector":"friendlyName","deviceSelector":"friendlyName","entitySelector":"friendlyName","statusSeparator":"at: ","statusYear":"hidden","statusMonth":"short","statusDay":"numeric","statusHourCycle":"h23","statusTimeFormat":"h:m","enableGlobalContextStore":true},{"id":"11b1a6e9.59fe11","type":"server","d":true,"name":"Home Assistant","version":5,"addon":true,"rejectUnauthorizedCerts":true,"ha_boolean":"y|yes|true|on|home|open","connectionDelay":true,"cacheJson":true,"heartbeat":false,"heartbeatInterval":"30","areaSelector":"friendlyName","deviceSelector":"friendlyName","entitySelector":"friendlyName","statusSeparator":"at: ","statusYear":"hidden","statusMonth":"short","statusDay":"numeric","statusHourCycle":"h23","statusTimeFormat":"h:m","enableGlobalContextStore":true},{"id":"0f0bd6e74f18a17d","type":"chronos-config","name":"Home","timezone":"","sunPositions":[]},{"id":"8ac3cd7f.58d3e","type":"server","d":true,"name":"Home Assistant","addon":false,"rejectUnauthorizedCerts":true,"ha_boolean":"","connectionDelay":false,"cacheJson":false,"heartbeat":false,"heartbeatInterval":"","statusSeparator":"","enableGlobalContextStore":false},{"id":"f15392eec802b2cd","type":"change","z":"dc6c7d82059d5798","name":"get cached states","rules":[{"t":"set","p":"payload","pt":"msg","to":"cachedStates","tot":"global"},{"t":"set","p":"cachedStates","pt":"global","to":"[]","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":1310,"y":200,"wires":[["5cd5c7a97cbfb2a5"]]},{"id":"b7edbc05c9fcc553","type":"split","z":"dc6c7d82059d5798","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1730,"y":200,"wires":[["b04a9bf4ba7404e5","1a5c3203a07c6ee2"]]},{"id":"aa91137ac6961ac9","type":"split","z":"dc6c7d82059d5798","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1730,"y":400,"wires":[["b04a9bf4ba7404e5","7e5af03335f043f5"]]},{"id":"7e5af03335f043f5","type":"api-call-service","z":"dc6c7d82059d5798","name":"set away payload","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"","floorId":[],"areaId":[],"deviceId":[],"entityId":[],"labelId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"results"}],"queue":"all","blockInputOverrides":false,"domain":"","service":"","x":2230,"y":460,"wires":[[]]},{"id":"1a5c3203a07c6ee2","type":"api-call-service","z":"dc6c7d82059d5798","name":"set home payload","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"","floorId":[],"areaId":[],"deviceId":[],"entityId":[],"labelId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"results"}],"queue":"all","blockInputOverrides":false,"domain":"","service":"","x":2230,"y":140,"wires":[[]]},{"id":"f3b79458ccde0628","type":"change","z":"dc6c7d82059d5798","name":"","rules":[{"t":"set","p":"cachedStates","pt":"global","to":"cachedStates","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":1550,"y":320,"wires":[[]]},{"id":"56f025da62a8d8d2","type":"state-machine","z":"dc6c7d82059d5798","name":"","triggerProperty":"action","triggerPropertyType":"msg","stateProperty":"state","statePropertyType":"msg","initialDelay":"0","persistOnReload":true,"outputStateChangeOnly":true,"throwException":false,"states":["start","home","away"],"transitions":[{"name":"home","from":"away","to":"home"},{"name":"away","from":"home","to":"away"},{"name":"home","from":"start","to":"home"},{"name":"away","from":"start","to":"away"}],"x":920,"y":300,"wires":[["ec499816d4d9d2fb"]]},{"id":"5cd5c7a97cbfb2a5","type":"function","z":"dc6c7d82059d5798","name":"states to actions","func":"\"use strict\";\nconst serviceToActionCall = (call) => {\n    if ((call == null ? void 0 : call.action) != null) {\n        return call;\n    }\n    const serviceCall = call;\n    const out = {\n        ...serviceCall,\n        action: `${serviceCall.domain}.${serviceCall.service}`,\n        target: {\n            entity_id: serviceCall.data.entity_id\n        }\n    };\n    delete out.domain;\n    delete out.service;\n    return out;\n};\nconst groupActions = (actions2) => {\n    const grouped = actions2.reduce((acc, cur) => {\n        const { action, data, target } = cur;\n        const dataCopy = { ...data };\n        delete dataCopy.entity_id;\n        const key = `${action}-${JSON.stringify(dataCopy)}`;\n        if (!acc[key]) {\n            acc[key] = {\n                action,\n                data: dataCopy,\n                target: {\n                    entity_id: /* @__PURE__ */ new Set([target.entity_id])\n                }\n            };\n        } else {\n            acc[key].target.entity_id.add(target.entity_id);\n        }\n        return acc;\n    }, {});\n    return Object.values(grouped).map((x) => {\n        x.target.entity_id = Array.from(x.target.entity_id);\n        return x;\n    });\n};\nconst states = msg.payload;\nconst actions = groupActions(states.map(serviceToActionCall));\nmsg.payload = actions;\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1520,"y":200,"wires":[["b7edbc05c9fcc553"]]},{"id":"fd875b9553cf1720","type":"function","z":"dc6c7d82059d5798","name":"cache house state","func":"\"use strict\";\nfunction getEntityDomain(entityId) {\n    const match = entityId.match(/^(.*)\\..*$/);\n    return match ? match[1] : entityId;\n}\nconst setIfExists = (to, from, key) => {\n    const value = from[key];\n    if (value != null) {\n        to[key] = value;\n        return true;\n    } else {\n        return false;\n    }\n};\nconst lightAttributes = [\"brightness\"];\nconst fanAttributes = [\"percentage\"];\nconst climateAttributes = [\"preset_mode\"];\nconst domains = [\"light\", \"switch\", \"fan\", \"climate\", \"lock\", \"cover\", \"media_player\"];\nconst filterAttributes = function (domain, service, attributes) {\n    let data = {};\n    switch (domain) {\n        case \"light\": {\n            const colorMode = attributes[\"color_mode\"];\n            if (attributes[colorMode] != void 0) {\n                data[colorMode] = attributes[colorMode];\n            }\n            const colorModeColor = `${colorMode}_color`;\n            if (attributes[colorModeColor] != void 0) {\n                data[colorModeColor] = attributes[colorModeColor];\n            }\n            if (service === \"turn_off\") {\n                break;\n            }\n            lightAttributes.forEach((x) => setIfExists(data, attributes, x));\n            break;\n        }\n        case \"fan\": {\n            if (service === \"turn_off\") {\n                break;\n            }\n            fanAttributes.forEach((x) => setIfExists(data, attributes, x));\n            break;\n        }\n        case \"climate\": {\n            climateAttributes.forEach((x) => setIfExists(data, attributes, x));\n            break;\n        }\n    }\n    return data;\n};\nconst mapDomainToService = function (entity, domain) {\n    switch (domain) {\n        case \"switch\":\n        case \"light\":\n        case \"fan\": {\n            return `turn_${entity.state}`;\n        }\n        case \"media_player\": {\n            switch (entity.state) {\n                case \"standby\":\n                case \"off\":\n                    return \"turn_off\";\n                case \"on\":\n                    return \"turn_on\";\n                case \"playing\":\n                    return \"media_play\";\n                case \"paused\":\n                    return \"media_pause\";\n                default:\n                    return \"turn_off\";\n            }\n        }\n        case \"lock\": {\n            switch (entity.state) {\n                case \"locked\":\n                    return \"lock\";\n                case \"unlocked\":\n                    return \"unlock\";\n            }\n            break;\n        }\n        case \"cover\": {\n            switch (entity.state) {\n                case \"open\":\n                    return \"open_cover\";\n                case \"closed\":\n                    return \"close_cover\";\n            }\n            break;\n        }\n        case \"climate\": {\n            return \"set_preset_mode\";\n        }\n    }\n    return void 0;\n};\nconst createServiceCall = (entity) => {\n    const domain = getEntityDomain(entity.entity_id);\n    const service = mapDomainToService(entity, domain);\n    if (!domains.includes(domain) || service === void 0) {\n        return void 0;\n    }\n    return {\n        domain,\n        service,\n        data: {\n            entity_id: entity.entity_id,\n            // state: entity.state,\n            ...filterAttributes(domain, service, entity.attributes)\n        }\n    };\n};\nconst groupActions = (actions) => {\n    const grouped = actions.reduce((acc, cur) => {\n        const { action, data, target } = cur;\n        const dataCopy = { ...data };\n        delete dataCopy.entity_id;\n        const key = `${action}-${JSON.stringify(dataCopy)}`;\n        if (!acc[key]) {\n            acc[key] = {\n                action,\n                data: dataCopy,\n                target: {\n                    entity_id: /* @__PURE__ */ new Set([target.entity_id])\n                }\n            };\n        } else {\n            acc[key].target.entity_id.add(target.entity_id);\n        }\n        return acc;\n    }, {});\n    return Object.values(grouped).map((x) => {\n        x.target.entity_id = Array.from(x.target.entity_id);\n        return x;\n    });\n};\nconst message = msg;\nconst entities = message.payload.filter((e) => {\n    const { entity_id, state } = e;\n    return state !== \"unavailable\";\n}).reduce((acc, e) => {\n    acc[e.entity_id] = e;\n    return acc;\n}, {});\nconst cachedStates = Object.values(entities).map(createServiceCall).filter((x) => x !== void 0);\nconst awayPayload = cachedStates.map((serviceCall) => {\n    const {\n        domain,\n        data: { entity_id }\n    } = serviceCall;\n    const payload = { domain, data: { entity_id } };\n    switch (domain) {\n        case \"switch\":\n        case \"light\": {\n            payload[\"service\"] = \"turn_off\";\n            break;\n        }\n        case \"fan\": {\n            payload[\"service\"] = \"turn_on\";\n            payload.data[\"percentage\"] = 100 / 3;\n            break;\n        }\n        case \"climate\": {\n            payload[\"service\"] = \"set_preset_mode\";\n            payload.data[\"preset_mode\"] = \"away\";\n            break;\n        }\n        case \"lock\": {\n            payload[\"service\"] = \"lock\";\n            break;\n        }\n        case \"cover\": {\n            payload[\"service\"] = \"close_cover\";\n            break;\n        }\n        case \"media_player\": {\n            payload[\"service\"] = \"turn_off\";\n            break;\n        }\n    }\n    payload[\"action\"] = `${payload.domain}.${payload.service}`;\n    payload[\"target\"] = {\n        entity_id\n    };\n    return payload;\n}).flat().filter(Boolean);\nmessage.entities = entities;\nmessage.cachedStates = cachedStates;\nmessage.payload = groupActions(awayPayload);\nmsg = message;\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1290,"y":400,"wires":[["aa91137ac6961ac9","f3b79458ccde0628"]]},{"id":"ec499816d4d9d2fb","type":"switch","z":"dc6c7d82059d5798","name":"","property":"state","propertyType":"msg","rules":[{"t":"eq","v":"home","vt":"str"},{"t":"eq","v":"away","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1090,"y":300,"wires":[["f15392eec802b2cd"],["fd875b9553cf1720"]]},{"id":"d0b7c73f2016e5ed","type":"delay","z":"dc6c7d82059d5798","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1580,"y":100,"wires":[["6884b8121b912de1"]]},{"id":"3bbb7c5484019d93","type":"delay","z":"dc6c7d82059d5798","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1560,"y":480,"wires":[["8df8d35e3eeb6902"]]},{"id":"21c1a8c17bfc6589","type":"subflow:8021f5177f6126d9","z":"dc6c7d82059d5798","name":"","x":2250,"y":400,"wires":[["ce2b2ba8abe846ad"]]},{"id":"b2ddf5f85a905ce5","type":"subflow:8021f5177f6126d9","z":"dc6c7d82059d5798","name":"","x":2250,"y":200,"wires":[["ce2b2ba8abe846ad"]]},{"id":"3537cb05135bae20","type":"delay","z":"dc6c7d82059d5798","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1560,"y":520,"wires":[["8df8d35e3eeb6902"]]},{"id":"b04a9bf4ba7404e5","type":"debug","z":"dc6c7d82059d5798","name":"debug 2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1840,"y":300,"wires":[]},{"id":"ce2b2ba8abe846ad","type":"debug","z":"dc6c7d82059d5798","name":"debug 4","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2460,"y":300,"wires":[]},{"id":"8df8d35e3eeb6902","type":"api-current-state","z":"dc6c7d82059d5798","name":"still away?","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"away","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_select.home_status","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1710,"y":500,"wires":[["aa91137ac6961ac9"],[]]},{"id":"6884b8121b912de1","type":"api-current-state","z":"dc6c7d82059d5798","name":"still home?","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"home","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_select.home_status","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1710,"y":100,"wires":[["b7edbc05c9fcc553"],[]]},{"id":"cd277d40138514b6","type":"ha-api","z":"e920ad5e223ac1b7","name":"get all areas","server":"79544c2b.6ccc64","version":1,"debugenabled":false,"protocol":"websocket","method":"get","path":"","data":"{\t   \"type\": \"config/area_registry/list\"\t}\t","dataType":"jsonata","responseType":"json","outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"results"}],"x":490,"y":460,"wires":[["cb13146898b60708"]]},{"id":"464bc921abc81bcb","type":"ha-api","z":"e920ad5e223ac1b7","name":"get entities in area","server":"79544c2b.6ccc64","version":1,"debugenabled":false,"protocol":"websocket","method":"get","path":"","data":"{\t   \"type\":\"search/related\",\t   \"item_type\":\"area\",\t   \"item_id\":payload.area_id\t}","dataType":"jsonata","responseType":"json","outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"results"}],"x":1050,"y":460,"wires":[["80018fe715669c83"]]},{"id":"420bdf56a9545130","type":"function","z":"e920ad5e223ac1b7","name":"filter hidden entities and domains","func":"// The payload is an array of entities, each entity is of the form (example data):\n/*\n{\n    \"area_id\": null,\n    \"categories\": {},\n    \"config_entry_id\": \"ec5a8dbb37234640aafc133fcf9145d3\",\n    \"device_id\": \"1bd27e814ff907a27f4c4b3513eebfe0\",\n    \"disabled_by\": null,\n    \"entity_category\": null,\n    \"entity_id\": \"weather.home\",\n    \"has_entity_name\": true,\n    \"hidden_by\": null,\n    \"icon\": null,\n    \"id\": \"cb7943781184ca831a473e57300c79ec\",\n    \"labels\": [],\n    \"name\": null,\n    \"options\": {\n        \"conversation\": { \"should_expose\": false },\n        \"cloud.alexa\": { \"should_expose\": false },\n        \"cloud.google_assistant\": { \"should_expose\": false }\n    },\n    \"original_name\": \"Home\",\n    \"platform\": \"met\",\n    \"translation_key\": null,\n    \"unique_id\": \"home\"\n}\n*/\n\nconst payload = msg.payload;\nconst domains = flow.get(\"domains\");\n\n// We want to extract the entity_id from each entity only if \"hidden_by\" is null:\nconst entities = payload\n    .filter(entity => entity.hidden_by === null)\n    // filter out the domain\n    .filter(entity => {\n        const domain = entity.entity_id.split(\".\")[0];\n        return domains.includes(domain);\n    })\n\nmsg.payload = entities;\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":720,"y":320,"wires":[["b9bb2396c68c2808"]]},{"id":"b87b4b7790bd9a57","type":"ha-api","z":"e920ad5e223ac1b7","name":"get all entities","server":"79544c2b.6ccc64","version":1,"debugenabled":false,"protocol":"websocket","method":"get","path":"","data":"{ \"type\": \"config/entity_registry/list\" }\t","dataType":"jsonata","responseType":"json","outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"results"}],"x":500,"y":320,"wires":[["420bdf56a9545130"]]},{"id":"b9bb2396c68c2808","type":"change","z":"e920ad5e223ac1b7","name":"","rules":[{"t":"set","p":"entities","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":940,"y":320,"wires":[["cd277d40138514b6"]]},{"id":"cb13146898b60708","type":"split","z":"e920ad5e223ac1b7","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":610,"y":460,"wires":[["ca2881af04fe059e"]]},{"id":"7f119f8a38274069","type":"join","z":"e920ad5e223ac1b7","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":1570,"y":460,"wires":[["58d12266f02b7691"]]},{"id":"58d12266f02b7691","type":"change","z":"e920ad5e223ac1b7","name":"","rules":[{"t":"set","p":"areaEntities","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1780,"y":460,"wires":[["f3f79edb0a0bc587"]]},{"id":"f3f79edb0a0bc587","type":"function","z":"e920ad5e223ac1b7","name":"reconcile entities","func":"// src/get-domain-entities/reconcile.ts\nvar entities = flow.get(\"entities\");\nvar areaEntities = flow.get(\"areaEntities\");\nvar entityToAreaMap = {};\nareaEntities.forEach((areaEntity, index) => {\n    const areaId = areaEntity?.area_id;\n    areaEntity?.entity?.forEach((entityId) => {\n        entityToAreaMap[entityId] = {\n            area_id: areaId,\n            floor: areaEntity?.floor ?? []\n        };\n    });\n});\nvar areaEntitiesInArea = entities.filter((entity) => entityToAreaMap[entity.entity_id]).map((entity) => {\n    const areaInfo = entityToAreaMap[entity.entity_id];\n    return {\n        ...entity,\n        floor: areaInfo.floor,\n        area_id: areaInfo.area_id\n    };\n});\nmsg.payload = areaEntitiesInArea;\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":640,"wires":[["7d1b0e2b3cfa5cf5"]]},{"id":"cf02ab45a21ca2c4","type":"api-current-state","z":"e920ad5e223ac1b7","name":"","server":"79544c2b.6ccc64","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"{{payload.entity_id}}","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entity"},{"property":"state","propertyType":"msg","value":"","valueType":"entityState"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1100,"y":640,"wires":[["7aa2b33747117988"]]},{"id":"7d1b0e2b3cfa5cf5","type":"split","z":"e920ad5e223ac1b7","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":650,"y":640,"wires":[["d9b036f71ddb098e"]]},{"id":"293cfeb962cd0b72","type":"join","z":"e920ad5e223ac1b7","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","useparts":true,"accumulate":true,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1650,"y":640,"wires":[["fe549fb394a9227a"]]},{"id":"8977e9e20795950e","type":"change","z":"e920ad5e223ac1b7","name":"","rules":[{"t":"set","p":"domains","pt":"flow","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":250,"y":320,"wires":[["b87b4b7790bd9a57"]]},{"id":"fe549fb394a9227a","type":"function","z":"e920ad5e223ac1b7","name":"filter entities","func":"// src/get-domain-entities/filter-entites.ts\nvar payload = msg.payload;\nvar ESPPRESENCE_RE = /^.*\\.espresense.*/;\nvar entities = payload.filter(\n    (entity) => (\n        // Filter out null states, \"unknown\", and \"unavailable\"\n        !(entity.state === null || entity.state === \"unknown\" || entity.state === \"unavailable\") && // Filter out \"*.espresense*\" entities\n        !(entity.entity_id != null && entity.entity_id.match(ESPPRESENCE_RE))\n    )\n);\nvar isGroupEntity = (entity) => {\n    return (\n        // @ts-ignore\n        entity.attributes?.entity_id != null && // @ts-ignore\n        Array.isArray(entity.attributes?.entity_id) && // @ts-ignore\n        entity.attributes.entity_id.length > 1\n    );\n};\nvar groupEntities = entities.filter(isGroupEntity);\nvar singularEntities = entities.filter((entity) => !isGroupEntity(entity));\nvar filteredEntities = singularEntities.filter(\n    (entity) => !groupEntities.some(\n        (groupEntity) => (\n            // @ts-ignore\n            groupEntity.attributes.entity_id.includes(entity.entity_id)\n        )\n    )\n);\nvar finalEntities = [...filteredEntities, ...groupEntities];\nmsg.payload = finalEntities;\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1770,"y":640,"wires":[[]]},{"id":"d9b036f71ddb098e","type":"change","z":"e920ad5e223ac1b7","name":"","rules":[{"t":"set","p":"entity","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":820,"y":640,"wires":[["cf02ab45a21ca2c4"]]},{"id":"7aa2b33747117988","type":"change","z":"e920ad5e223ac1b7","name":"","rules":[{"t":"set","p":"payload.area_id","pt":"msg","to":"entity.area_id","tot":"msg"},{"t":"set","p":"payload.floor","pt":"msg","to":"entity.floor","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1380,"y":640,"wires":[["293cfeb962cd0b72"]]},{"id":"ca2881af04fe059e","type":"change","z":"e920ad5e223ac1b7","name":"","rules":[{"t":"set","p":"area_id","pt":"msg","to":"payload.area_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":820,"y":460,"wires":[["464bc921abc81bcb"]]},{"id":"80018fe715669c83","type":"change","z":"e920ad5e223ac1b7","name":"","rules":[{"t":"set","p":"payload.area_id","pt":"msg","to":"area_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1330,"y":460,"wires":[["7f119f8a38274069"]]},{"id":"477dba19ecf39512","type":"change","z":"c15b1459ec3be250","name":"set unavailable","rules":[{"t":"set","p":"payload.state","pt":"msg","to":"unavailable","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":340,"y":260,"wires":[["f7044577138e7cbf"]]},{"id":"9d3b8f61955a9bcb","type":"ha-api","z":"c15b1459ec3be250","name":"get state","server":"79544c2b.6ccc64","version":1,"debugenabled":false,"protocol":"http","method":"get","path":"/api/states/{{payload}}","data":"","dataType":"jsonata","responseType":"json","outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"results"}],"x":160,"y":260,"wires":[["477dba19ecf39512"]]},{"id":"f7044577138e7cbf","type":"ha-api","z":"c15b1459ec3be250","name":"set unavailable","server":"79544c2b.6ccc64","version":1,"debugenabled":false,"protocol":"http","method":"post","path":"/api/states/{{payload.entity_id}}","data":"payload","dataType":"jsonata","responseType":"json","outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"results"}],"x":540,"y":260,"wires":[[]]},{"id":"5cc3e854cdde0e1c","type":"split","z":"173c5faccfb73051","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","property":"entities","x":310,"y":660,"wires":[["84fb4875e846f886"]]},{"id":"f23dd18061e97c71","type":"ha-get-entities","z":"173c5faccfb73051","name":"","server":"79544c2b.6ccc64","version":1,"rules":[{"condition":"state_object","property":"entity_id","logic":"is","value":"entities","valueType":"jsonata"}],"outputType":"random","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"entities","outputResultsCount":1,"x":630,"y":600,"wires":[["ce42b741b07c1210"]]},{"id":"ce42b741b07c1210","type":"join","z":"173c5faccfb73051","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","useparts":true,"accumulate":true,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":810,"y":660,"wires":[["f633b8e8b3205bc1"]]},{"id":"f633b8e8b3205bc1","type":"function","z":"173c5faccfb73051","name":"presence","func":"// src/utils/utils.ts\nfunction getEntityDomain(entityId) {\n    const match = entityId.match(/^(.*)\\..*$/);\n    return match ? match[1] : entityId;\n}\nvar normalizeIncludes = (s1, s2) => {\n    return s1.toLowerCase().includes(s2.toLowerCase());\n};\nvar isBlacklisted = (entity_id, blacklisted) => {\n    return blacklisted.some((blacklistItem) => {\n        if (typeof blacklistItem === \"string\") {\n            return normalizeIncludes(entity_id, blacklistItem);\n        } else {\n            return blacklistItem.test(entity_id);\n        }\n    });\n};\nvar BLACKLISTED_ENTITIES = [\n    // car\n    \"son_of_toast\",\n    // grow lights\n    /.*grow.*/i,\n    // blinds\n    /.*blinds.*/i,\n    // air purifiers\n    /.*air_purifier.*/i,\n    // garage door\n    /switch.ratgdov25i_4b1c3b.*/i,\n    \"lock.ratgdov25i_4b1c3b_lock_remotes\",\n    // sonos\n    /.*sonos_beam.*/i,\n    // washer/dryer\n    \"washer_power\",\n    \"dryer_power\",\n    // water pump\n    \"switch.plant_water_pump_switch\",\n    // ESPresnce:\n    /espresense_.*/i\n];\nvar filterBlacklistedEntity = (e, blacklist = BLACKLISTED_ENTITIES) => {\n    let entity_id;\n    let state;\n    if (typeof e === \"string\") {\n        entity_id = e;\n        state = void 0;\n    } else {\n        entity_id = e.entity_id;\n        state = e.state;\n    }\n    const whitelisted = !isBlacklisted(entity_id, blacklist);\n    const inDomain = domains ? domains.includes(getEntityDomain(entity_id)) : true;\n    const isUnavailable = state === \"unavailable\" || state === \"unknown\";\n    return whitelisted && inDomain && !isUnavailable;\n};\nvar domains = [\"light\", \"switch\", \"fan\", \"climate\", \"lock\", \"cover\", \"media_player\"];\nvar groupActions = (actions) => {\n    const grouped = actions.reduce((acc, cur) => {\n        const { action, data: data2, target } = cur;\n        const dataCopy = { ...data2 };\n        delete dataCopy.entity_id;\n        const key = `${action}-${JSON.stringify(dataCopy)}`;\n        if (!acc[key]) {\n            acc[key] = {\n                action,\n                data: dataCopy,\n                target: {\n                    entity_id: /* @__PURE__ */ new Set([target.entity_id])\n                }\n            };\n        } else {\n            acc[key].target.entity_id.add(target.entity_id);\n        }\n        return acc;\n    }, {});\n    return Object.values(grouped).map((x) => {\n        x.target.entity_id = Array.from(x.target.entity_id);\n        return x;\n    });\n};\n\n// src/presence/presence.ts\nvar MAX_COOL_DOWN = 30 * 60;\nvar DEFAULT_COOL_DOWN = 10 * 60;\nvar createPayload = (entities2, action) => {\n    const actions = entities2.map((e) => ({\n        action: `homeassistant.${action}`,\n        target: { entity_id: e.entity_id }\n    }));\n    return groupActions(actions);\n};\nvar calculateCoolDown = (dwellTimeMs, baseCoolDown) => {\n    const minutesDwelled = Math.floor(dwellTimeMs / 6e4);\n    const additionalDelay = Math.sqrt(minutesDwelled) * 120;\n    return Math.min(MAX_COOL_DOWN, baseCoolDown + additionalDelay);\n};\nvar isInCoolDownPeriod = (flowInfo2) => {\n    if (!flowInfo2.delay || !flowInfo2.lastOff) {\n        return false;\n    }\n    const timeSinceLastOff = Date.now() - flowInfo2.lastOff;\n    return timeSinceLastOff < flowInfo2.delay;\n};\nvar determinePresenceState = (sensorStates) => {\n    if (sensorStates.some((state) => state === \"unknown\" || state === \"unavailable\" || !state)) {\n        return \"unknown\" /* UNKNOWN */;\n    }\n    if (sensorStates.some((state) => state === \"on\")) {\n        return \"on\" /* ON */;\n    }\n    return \"off\" /* OFF */;\n};\nvar message = msg;\nvar payload = message.payload;\nvar data = message.data;\nvar dataEntityId = data.entity_id;\nvar topic = message.topic ?? dataEntityId;\nvar coolDown = message.coolDown ?? DEFAULT_COOL_DOWN;\nvar entities = Array.isArray(message.entities) ? message.entities : [message.entities];\nvar filteredEntities = entities.filter((e) => filterBlacklistedEntity(e));\nvar presenceStatesKey = `presenceStates.${topic}`;\nvar flowInfoKey = `flowInfo.${topic}`;\nvar debounceKey = `debounce.${topic}`;\nvar presenceStates = flow.get(presenceStatesKey) || {};\nflow.set(presenceStatesKey, presenceStates);\nvar flowInfo = flow.get(flowInfoKey) || {\n    state: \"off\" /* OFF */,\n    lastOn: null,\n    lastOff: null,\n    delay: 0\n};\nvar debounceInfo = flow.get(debounceKey) || {\n    lastUpdate: 0,\n    pendingState: null\n};\nvar normalizedPayload = payload === \"on\" || payload === \"off\" ? payload : \"unknown\";\nvar DEBOUNCE_TIME = 2e3;\nvar now = Date.now();\nvar timeSinceLastUpdate = now - debounceInfo.lastUpdate;\nif (timeSinceLastUpdate < DEBOUNCE_TIME && presenceStates[dataEntityId] !== normalizedPayload) {\n    debounceInfo.pendingState = normalizedPayload;\n    debounceInfo.lastUpdate = now;\n    flow.set(debounceKey, debounceInfo);\n    msg.payload = null;\n    msg.delay = 1;\n} else {\n    presenceStates[dataEntityId] = normalizedPayload;\n    debounceInfo.lastUpdate = now;\n    debounceInfo.pendingState = null;\n    const presenceStatesValues = Object.values(presenceStates);\n    const aggregateState = determinePresenceState(presenceStatesValues);\n    const prevState = flowInfo.state;\n    const inCoolDown = isInCoolDownPeriod(flowInfo);\n    let actualState = aggregateState;\n    if (aggregateState === \"off\" /* OFF */ && inCoolDown) {\n        actualState = \"pending_off\" /* PENDING_OFF */;\n    }\n    msg.delay = 1;\n    msg.payload = null;\n    switch (actualState) {\n        case \"on\" /* ON */:\n            if (prevState === \"off\" /* OFF */) {\n                flowInfo.lastOn = Date.now();\n                flowInfo.lastOff = null;\n                flowInfo.state = \"on\" /* ON */;\n                flowInfo.delay = 0;\n                msg.payload = createPayload(filteredEntities, \"turn_on\");\n            } else if (prevState === \"pending_off\" /* PENDING_OFF */) {\n                flowInfo.state = \"on\" /* ON */;\n                flowInfo.lastOff = null;\n                flowInfo.delay = 0;\n            } else if (prevState === \"unknown\" /* UNKNOWN */) {\n                flowInfo.state = \"on\" /* ON */;\n                if (!flowInfo.lastOn) {\n                    flowInfo.lastOn = Date.now();\n                }\n                msg.payload = createPayload(filteredEntities, \"turn_on\");\n            }\n            break;\n        case \"off\" /* OFF */:\n            if (prevState === \"on\" /* ON */) {\n                const dwellTime = flowInfo.lastOn ? Date.now() - flowInfo.lastOn : 0;\n                const delaySeconds = calculateCoolDown(dwellTime, coolDown);\n                const delayMs = delaySeconds * 1e3;\n                flowInfo.lastOff = Date.now();\n                flowInfo.state = \"pending_off\" /* PENDING_OFF */;\n                flowInfo.delay = delayMs;\n                msg.delay = delayMs;\n                msg.payload = createPayload(filteredEntities, \"turn_off\");\n            } else if (prevState === \"unknown\" /* UNKNOWN */ && !inCoolDown) {\n                flowInfo.state = \"off\" /* OFF */;\n                flowInfo.lastOff = Date.now();\n                flowInfo.lastOn = null;\n                msg.payload = createPayload(filteredEntities, \"turn_off\");\n            }\n            break;\n        case \"pending_off\" /* PENDING_OFF */:\n            flowInfo.state = \"pending_off\" /* PENDING_OFF */;\n            break;\n        case \"unknown\" /* UNKNOWN */:\n            flowInfo.state = \"unknown\" /* UNKNOWN */;\n            break;\n    }\n    flow.set(flowInfoKey, flowInfo);\n    flow.set(presenceStatesKey, presenceStates);\n    flow.set(debounceKey, debounceInfo);\n    msg.presenceStates = presenceStates;\n    msg.presenceState = flowInfo.state;\n    msg.flowInfo = flowInfo;\n    msg.aggregateState = aggregateState;\n    msg.inCoolDown = inCoolDown;\n}\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":960,"y":660,"wires":[["e0a5888091e1d0a9"]]},{"id":"e9078c37e21a56bb","type":"api-call-service","z":"173c5faccfb73051","name":"","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"","floorId":[],"areaId":[],"deviceId":[],"entityId":[],"labelId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":false,"domain":"","service":"","x":1990,"y":640,"wires":[[]]},{"id":"2972e66152da7eed","type":"split","z":"173c5faccfb73051","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","property":"payload","x":1830,"y":640,"wires":[["e9078c37e21a56bb"]]},{"id":"84fb4875e846f886","type":"switch","z":"173c5faccfb73051","name":"","property":"entities","propertyType":"msg","rules":[{"t":"istype","v":"string","vt":"string"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":490,"y":660,"wires":[["f23dd18061e97c71"],["ce42b741b07c1210"]]},{"id":"f0fb3d2dd90354a6","type":"switch","z":"173c5faccfb73051","name":"","property":"presenceState","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"},{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1250,"y":660,"wires":[["2972e66152da7eed","e9ac5cb2f1c2eb4d"],["3b6d7623a809d27a"]]},{"id":"85189e1b07ba7a5e","type":"switch","z":"173c5faccfb73051","name":"","property":"data.state","propertyType":"msg","rules":[{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1710,"y":840,"wires":[["2972e66152da7eed","67deec472b0c488c"]]},{"id":"f59de909516cb178","type":"function","z":"173c5faccfb73051","name":"get flow info","func":"// src/presence/get-flow-info.ts\nvar message = msg;\nvar data = message.data;\nvar dataEntityId = data.entity_id;\nvar topic = message.topic ?? dataEntityId;\nvar flowInfoKey = `flowInfo.${topic}`;\n\nmsg.data = flow.get(flowInfoKey) ?? {};\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1550,"y":840,"wires":[["85189e1b07ba7a5e"]]},{"id":"3b6d7623a809d27a","type":"trigger","z":"173c5faccfb73051","name":"","op1":"","op2":"","op1type":"nul","op2type":"payl","duration":"1","extend":true,"overrideDelay":true,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":1380,"y":840,"wires":[["f59de909516cb178"]]},{"id":"e0a5888091e1d0a9","type":"switch","z":"173c5faccfb73051","name":"","property":"payload","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":1110,"y":660,"wires":[["f0fb3d2dd90354a6"]]},{"id":"e9ac5cb2f1c2eb4d","type":"debug","z":"173c5faccfb73051","name":"debug 14","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1380,"y":560,"wires":[]},{"id":"67deec472b0c488c","type":"debug","z":"173c5faccfb73051","name":"debug 10","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1920,"y":840,"wires":[]},{"id":"5279b8dcf7ae15f1","type":"ha-api","z":"b0e3e1c3c40d9540","name":"","server":"79544c2b.6ccc64","version":1,"debugenabled":false,"protocol":"websocket","method":"get","path":"","data":"{\t   \"type\":\"search/related\",\t    \"item_type\": payload.item_type,\t    \"item_id\": payload.area\t}","dataType":"jsonata","responseType":"json","outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"results"}],"x":1070,"y":520,"wires":[["1d1db4b4f9fa698a"]]},{"id":"1d1db4b4f9fa698a","type":"change","z":"b0e3e1c3c40d9540","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.entity","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1330,"y":420,"wires":[["627b25edecfe582e"]]},{"id":"627b25edecfe582e","type":"function","z":"b0e3e1c3c40d9540","name":"filter blacklisted entities","func":"\"use strict\";\nfunction getEntityDomain(entityId) {\n    const match = entityId.match(/^(.*)\\..*$/);\n    return match ? match[1] : entityId;\n}\nconst normalizeIncludes = (s1, s2) => {\n    return s1.toLowerCase().includes(s2.toLowerCase());\n};\nconst isBlacklisted = (entity_id, blacklisted) => {\n    return blacklisted.some((blacklistItem) => {\n        if (typeof blacklistItem === \"string\") {\n            return normalizeIncludes(entity_id, blacklistItem);\n        } else {\n            return blacklistItem.test(entity_id);\n        }\n    });\n};\nconst blacklistedEntities = [\n    // car\n    \"son_of_toast\",\n    // grow lights\n    /.*grow.*/i,\n    // blinds\n    /.*blinds.*/i,\n    // air purifiers\n    /.*air_purifier.*/i,\n    // garage door\n    /switch.ratgdov25i_4b1c3b.*/i,\n    \"lock.ratgdov25i_4b1c3b_lock_remotes\",\n    // sonos\n    /.*sonos_beam.*/i,\n    // washer/dryer\n    \"washer_power\",\n    \"dryer_power\",\n    // water pump\n    \"switch.plant_water_pump_switch\",\n    // ESPresnce:\n    /espresense_.*/i\n];\nconst message = msg;\nconst payload = Array.isArray(message.payload) ? message.payload : [message.payload];\nconst blacklist = msg.blacklist ?? blacklistedEntities;\nconst domains = msg.domains ?? void 0;\nconst filterEntity = (e) => {\n    let entity_id;\n    let state;\n    if (typeof e === \"string\") {\n        entity_id = e;\n        state = void 0;\n    } else {\n        entity_id = e.entity_id;\n        state = e.state;\n    }\n    const whitelisted = !isBlacklisted(entity_id, blacklist);\n    const inDomain = domains ? domains.includes(getEntityDomain(entity_id)) : true;\n    const isUnavailable = state === \"unavailable\" || state === \"unknown\";\n    return whitelisted && inDomain && !isUnavailable;\n};\nconst entities = payload.filter(filterEntity);\nmsg.payload = entities;\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1670,"y":420,"wires":[[]]},{"id":"9c2c9a3d7193d0ab","type":"join","z":"b0e3e1c3c40d9540","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","useparts":true,"accumulate":true,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1810,"y":200,"wires":[[]]},{"id":"302a6c0c2a74f0ed","type":"ha-get-entities","z":"b0e3e1c3c40d9540","name":"","server":"79544c2b.6ccc64","version":1,"rules":[{"condition":"state_object","property":"entity_id","logic":"is","value":"payload","valueType":"msg"}],"outputType":"random","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"payload","outputResultsCount":1,"x":1610,"y":120,"wires":[[]]},{"id":"508c788c801c4ede","type":"split","z":"b0e3e1c3c40d9540","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1490,"y":120,"wires":[["302a6c0c2a74f0ed"]]},{"id":"0469280f2fcf4c7c","type":"change","z":"b0e3e1c3c40d9540","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1870,"y":120,"wires":[[]]},{"id":"02236a5128e611c4","type":"change","z":"bfb9a6c8a64bb052","name":"set unavailable","rules":[{"t":"set","p":"tmp_state","pt":"msg","to":"payload","tot":"msg","dc":true},{"t":"set","p":"payload.context.user_id","pt":"msg","to":"null","tot":"json"},{"t":"set","p":"payload.state","pt":"msg","to":"off","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":420,"y":280,"wires":[["cf02d02ae593d1d7"]]},{"id":"60083ad5e2e0f3ca","type":"ha-api","z":"bfb9a6c8a64bb052","name":"get state","server":"79544c2b.6ccc64","version":1,"debugenabled":false,"protocol":"http","method":"get","path":"/api/states/{{payload}}","data":"","dataType":"jsonata","responseType":"json","outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"results"}],"x":240,"y":280,"wires":[["02236a5128e611c4"]]},{"id":"cf02d02ae593d1d7","type":"ha-api","z":"bfb9a6c8a64bb052","name":"set null","server":"79544c2b.6ccc64","version":1,"debugenabled":false,"protocol":"http","method":"post","path":"/api/states/{{payload.entity_id}}","data":"payload","dataType":"jsonata","responseType":"json","outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"results"}],"x":600,"y":280,"wires":[["abe85fa98c6de34f"]]},{"id":"abe85fa98c6de34f","type":"ha-api","z":"bfb9a6c8a64bb052","name":"set null","server":"79544c2b.6ccc64","version":1,"debugenabled":false,"protocol":"http","method":"post","path":"/api/states/{{tmp_state.entity_id}}","data":"tmp_state","dataType":"jsonata","responseType":"json","outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"results"}],"x":760,"y":280,"wires":[[]]},{"id":"c04368f701cd604d","type":"function","z":"8021f5177f6126d9","name":"action node","func":"\"use strict\";\nvar _a;\nconst deepEqual = (a, b) => {\n    if (a === b) {\n        return true;\n    }\n    if (typeof a !== \"object\" || typeof b !== \"object\") {\n        return false;\n    }\n    if (Object.keys(a).length !== Object.keys(b).length) {\n        return false;\n    }\n    for (const key in a) {\n        if (!(key in b)) {\n            return false;\n        }\n        if (!deepEqual(a[key], b[key])) {\n            return false;\n        }\n    }\n    return true;\n};\nconst domainToService = function (entity, domain) {\n    switch (domain) {\n        case \"switch\":\n        case \"light\":\n        case \"fan\": {\n            return `turn_${entity.state}`;\n        }\n        case \"media_player\": {\n            switch (entity.state) {\n                case \"standby\":\n                case \"off\":\n                    return \"turn_off\";\n                case \"on\":\n                    return \"turn_on\";\n                case \"playing\":\n                    return \"media_play\";\n                case \"paused\":\n                    return \"media_pause\";\n                default:\n                    return \"turn_off\";\n            }\n        }\n        case \"lock\": {\n            switch (entity.state) {\n                case \"locked\":\n                    return \"lock\";\n                case \"unlocked\":\n                    return \"unlock\";\n            }\n            break;\n        }\n        case \"cover\": {\n            switch (entity.state) {\n                case \"open\":\n                    return \"open_cover\";\n                case \"closed\":\n                    return \"close_cover\";\n            }\n            break;\n        }\n        case \"climate\": {\n            return \"set_preset_mode\";\n        }\n    }\n    return void 0;\n};\nconst originalMsg = msg.originalPayload;\nconst currentStates = msg.target;\nconst currentStatesMap = currentStates.reduce((acc, state) => {\n    acc[state.entity_id] = state;\n    return acc;\n}, {});\nconst action = originalMsg.action;\nconst targetEntities = ((_a = originalMsg == null ? void 0 : originalMsg.target) == null ? void 0 : _a.entity_id) || [];\nconst actionData = (originalMsg == null ? void 0 : originalMsg.data) || {};\nconst [actionDomain, actionService] = action.split(\".\");\nconst changedEntities = [];\nfor (const entityId of targetEntities) {\n    const currentState = currentStatesMap[entityId];\n    if (!currentState) {\n        changedEntities.push(entityId);\n        node.status({ shape: \"ring\", fill: \"yellow\", text: `Unknown: ${entityId}` });\n        continue;\n    }\n    const currentService = domainToService(currentState, actionDomain);\n    let needsUpdate = false;\n    if (currentService !== actionService) {\n        needsUpdate = true;\n    }\n    if (!needsUpdate && Object.keys(actionData).length > 0) {\n        const currentAttributes = currentState.attributes || {};\n        needsUpdate = Object.keys(actionData).some((key) => {\n            if (key in currentAttributes) {\n                return !deepEqual(currentAttributes[key], actionData[key]);\n            }\n            return true;\n        });\n    }\n    if (needsUpdate) {\n        changedEntities.push(entityId);\n        node.status({ fill: \"green\", shape: \"dot\", text: `Change: ${entityId}` });\n    }\n}\nif (changedEntities.length === 0) {\n    node.status({ fill: \"grey\", shape: \"dot\", text: \"No changes needed\" });\n    msg.payload = null;\n} else {\n    msg = {\n        payload: {\n            action,\n            target: {\n                entity_id: changedEntities\n            },\n            data: actionData\n        }\n    };\n    node.status({\n        fill: \"green\",\n        shape: \"dot\",\n        text: `Updating ${changedEntities.length} entities`\n    });\n}\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1030,"y":200,"wires":[["6db7230ba42be68f"]]},{"id":"6d005e805f9ac454","type":"api-current-state","z":"8021f5177f6126d9","name":"","server":"79544c2b.6ccc64","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"{{target}}","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"target","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":650,"y":200,"wires":[["a2f95d9f502d7c4b"]]},{"id":"dfd343ec25476540","type":"split","z":"8021f5177f6126d9","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","property":"target","x":430,"y":200,"wires":[["6d005e805f9ac454"]]},{"id":"34bb6d2d5ed5afb9","type":"change","z":"8021f5177f6126d9","name":"","rules":[{"t":"set","p":"target","pt":"msg","to":"$type(payload.target.entity_id) = \"array\" ? \t  payload.target.entity_id : \t  $type(payload.target.entity_id) = \"string\" ? \t    [payload.target.entity_id] : \t    []","tot":"jsonata"},{"t":"set","p":"originalPayload","pt":"msg","to":"payload","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":220,"y":200,"wires":[["dfd343ec25476540"]]},{"id":"a2f95d9f502d7c4b","type":"join","z":"8021f5177f6126d9","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","useparts":false,"accumulate":true,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":850,"y":200,"wires":[["c04368f701cd604d"]]},{"id":"4af6c987e04e44bc","type":"api-call-service","z":"8021f5177f6126d9","name":"","server":"79544c2b.6ccc64","version":7,"debugenabled":true,"action":"","floorId":[],"areaId":[],"deviceId":[],"entityId":[],"labelId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"all","blockInputOverrides":false,"domain":"","service":"","x":1330,"y":200,"wires":[["367f358db357e130"]]},{"id":"6db7230ba42be68f","type":"switch","z":"8021f5177f6126d9","name":"","property":"payload","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":1210,"y":200,"wires":[["4af6c987e04e44bc","37b41fb9320c9e8a"]]},{"id":"37b41fb9320c9e8a","type":"debug","z":"8021f5177f6126d9","name":"debug 5","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1340,"y":260,"wires":[]},{"id":"367f358db357e130","type":"debug","z":"8021f5177f6126d9","name":"debug 6","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1360,"y":120,"wires":[]},{"id":"a46187b14bd9fb94","type":"change","z":"685bfaf1e94471c7","name":"set unavailable","rules":[{"t":"set","p":"tmp_state","pt":"msg","to":"payload","tot":"msg","dc":true},{"t":"set","p":"payload.state","pt":"msg","to":"state","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":380,"y":320,"wires":[["c344f84a00032523"]]},{"id":"198f6f354b3b8fe4","type":"ha-api","z":"685bfaf1e94471c7","name":"get state","server":"79544c2b.6ccc64","version":1,"debugenabled":false,"protocol":"http","method":"get","path":"/api/states/{{payload}}","data":"","dataType":"jsonata","responseType":"json","outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"results"}],"x":200,"y":320,"wires":[["a46187b14bd9fb94"]]},{"id":"c344f84a00032523","type":"ha-api","z":"685bfaf1e94471c7","name":"set null","server":"79544c2b.6ccc64","version":1,"debugenabled":false,"protocol":"http","method":"post","path":"/api/states/{{payload.entity_id}}","data":"payload","dataType":"jsonata","responseType":"json","outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"results"}],"x":560,"y":320,"wires":[["03c9f469b8580746"]]},{"id":"03c9f469b8580746","type":"ha-api","z":"685bfaf1e94471c7","name":"set null","server":"79544c2b.6ccc64","version":1,"debugenabled":false,"protocol":"http","method":"post","path":"/api/states/{{tmp_state.entity_id}}","data":"tmp_state","dataType":"jsonata","responseType":"json","outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"results"}],"x":720,"y":320,"wires":[[]]},{"id":"d6912d204418c6e6","type":"subflow:dc6c7d82059d5798","z":"4f871e90.29a61","name":"","x":2860,"y":420,"wires":[[],[]]},{"id":"ec7a7c4fc1be7da4","type":"change","z":"4f871e90.29a61","name":"set home","rules":[{"t":"set","p":"action","pt":"msg","to":"home","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2620,"y":220,"wires":[["d6912d204418c6e6"]]},{"id":"03249c45bcec909b","type":"change","z":"4f871e90.29a61","name":"set away","rules":[{"t":"set","p":"action","pt":"msg","to":"away","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2620,"y":680,"wires":[["d6912d204418c6e6"]]},{"id":"e44783c4537014f3","type":"inject","z":"4f871e90.29a61","name":"force home","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1070,"y":160,"wires":[["7c870d60691b4d7f"]]},{"id":"332cfe3d60495256","type":"server-state-changed","z":"4f871e90.29a61","name":"home?","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["input_select.home_status"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"2","forType":"num","forUnits":"seconds","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":90,"y":420,"wires":[["d5d201c5e59b6752","20d9cf93f238d30f"]]},{"id":"5a415217dc8072e4","type":"switch","z":"4f871e90.29a61","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"home","vt":"str"},{"t":"eq","v":"away","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1000,"y":420,"wires":[["7c870d60691b4d7f"],["8cd848124fc3527c"]]},{"id":"f53fe7b2806d0f15","type":"api-current-state","z":"4f871e90.29a61","name":"guest mode?","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.guest_mode","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":650,"y":420,"wires":[[],["cfca5cecead45ab0"]]},{"id":"3a5517697f2c3002","type":"subflow:e920ad5e223ac1b7","z":"4f871e90.29a61","name":"","x":1660,"y":680,"wires":[["08f84c6d37343c7a"]]},{"id":"21db9927f8527c70","type":"inject","z":"4f871e90.29a61","name":"force away","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1060,"y":560,"wires":[["8cd848124fc3527c"]]},{"id":"8cd848124fc3527c","type":"change","z":"4f871e90.29a61","name":"","rules":[{"t":"set","p":"cachedStates","pt":"global","to":"[]","tot":"json"},{"t":"set","p":"cachedStates","pt":"flow","to":"[]","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":1260,"y":560,"wires":[["293ebfd2ebe5c2b8"]]},{"id":"b126bb40f2314417","type":"ha-api","z":"4f871e90.29a61","name":"set home zone","server":"79544c2b.6ccc64","version":1,"debugenabled":false,"protocol":"http","method":"post","path":"/api/states/zone.home","data":"payload","dataType":"jsonata","responseType":"json","outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"results"}],"x":1220,"y":980,"wires":[[]]},{"id":"c892329500580cfe","type":"ha-api","z":"4f871e90.29a61","name":"get home zone","server":"79544c2b.6ccc64","version":1,"debugenabled":false,"protocol":"http","method":"get","path":"/api/states/zone.home","data":"","dataType":"jsonata","responseType":"json","outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"results"}],"x":940,"y":980,"wires":[["69467176f04686f5"]]},{"id":"69467176f04686f5","type":"change","z":"4f871e90.29a61","name":"set radius","rules":[{"t":"set","p":"payload.attributes.radius","pt":"msg","to":"radius","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1080,"y":980,"wires":[["b126bb40f2314417"]]},{"id":"4f951d4b4a5b3b30","type":"change","z":"4f871e90.29a61","name":"set radius to 65m","rules":[{"t":"set","p":"radius","pt":"msg","to":"65","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":690,"y":1020,"wires":[["c892329500580cfe"]]},{"id":"bdd65751ecd411c8","type":"change","z":"4f871e90.29a61","name":"set radius to 25m","rules":[{"t":"set","p":"radius","pt":"msg","to":"25","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":690,"y":960,"wires":[["c892329500580cfe"]]},{"id":"36499af3d5b1a244","type":"switch","z":"4f871e90.29a61","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"home","vt":"str"},{"t":"eq","v":"away","vt":"str"},{"t":"eq","v":"en route","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":430,"y":420,"wires":[["f53fe7b2806d0f15","bdd65751ecd411c8"],["f53fe7b2806d0f15","bdd65751ecd411c8"],["4f951d4b4a5b3b30"]]},{"id":"7c870d60691b4d7f","type":"ha-get-entities","z":"4f871e90.29a61","name":"get locks","server":"79544c2b.6ccc64","version":1,"rules":[{"property":"entity_id","logic":"includes","value":"[\t  \"lock.front_door\",\t  \"lock.garage_entry_door\"\t]","valueType":"jsonata"}],"outputType":"array","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"payload","outputResultsCount":1,"x":1440,"y":160,"wires":[["e27c2859639d8c73"]]},{"id":"af00170a66afce57","type":"change","z":"4f871e90.29a61","name":"","rules":[{"t":"set","p":"payload.domain","pt":"msg","to":"lock","tot":"str"},{"t":"set","p":"payload.service","pt":"msg","to":"unlock","tot":"str"},{"t":"set","p":"payload.data","pt":"msg","to":"{\t   \"entity_id\": payload.entity_id\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1740,"y":160,"wires":[["b50c926c4d8db4d4"]]},{"id":"e27c2859639d8c73","type":"split","z":"4f871e90.29a61","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1610,"y":160,"wires":[["af00170a66afce57"]]},{"id":"fb18d7cebacd6994","type":"change","z":"4f871e90.29a61","name":"","rules":[{"t":"set","p":"entities","pt":"msg","to":"(\t    $append(entities, payload)\t)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":2040,"y":160,"wires":[["8b34a7a7a4f9b2ce"]]},{"id":"b50c926c4d8db4d4","type":"join","z":"4f871e90.29a61","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":1870,"y":160,"wires":[["fb18d7cebacd6994"]]},{"id":"8b34a7a7a4f9b2ce","type":"ha-get-entities","z":"4f871e90.29a61","name":"get garage door","server":"79544c2b.6ccc64","version":1,"rules":[{"property":"entity_id","logic":"includes","value":"[\t  \"cover.ratgdov25i_4b1c3b_door\"\t]","valueType":"jsonata"}],"outputType":"array","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"payload","outputResultsCount":1,"x":1460,"y":220,"wires":[["ad90b78ba0e12432"]]},{"id":"4acab81e93bba619","type":"change","z":"4f871e90.29a61","name":"","rules":[{"t":"set","p":"payload.domain","pt":"msg","to":"cover","tot":"str"},{"t":"set","p":"payload.service","pt":"msg","to":"open_cover","tot":"str"},{"t":"set","p":"payload.data","pt":"msg","to":"{\t   \"entity_id\": payload.entity_id\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1740,"y":220,"wires":[["6696339e69dcfe3b"]]},{"id":"ad90b78ba0e12432","type":"split","z":"4f871e90.29a61","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1610,"y":220,"wires":[["4acab81e93bba619"]]},{"id":"6696339e69dcfe3b","type":"join","z":"4f871e90.29a61","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":1870,"y":220,"wires":[["b980ac240b5fe750"]]},{"id":"b980ac240b5fe750","type":"change","z":"4f871e90.29a61","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"(\t    $append(entities, payload)\t)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":2230,"y":220,"wires":[["3f3963cff3716131"]]},{"id":"3f3963cff3716131","type":"function","z":"4f871e90.29a61","name":"push cached states","func":"// src/utils/utils.ts\nvar GLOBAL_CACHED_STATES_KEY = \"cachedStates\";\n\n// src/cache-states/push-cache-states.ts\nvar newStates = msg.payload;\nvar cachedStates = global.get(GLOBAL_CACHED_STATES_KEY) ?? [];\nvar filteredStates = cachedStates.filter((cachedState) => {\n    const cachedId = cachedState?.target?.entity_id ?? cachedState.data?.entity_id;\n    const cachedIds = Array.isArray(cachedId) ? cachedId : [cachedId];\n    return !newStates.find((newState) => {\n        return cachedIds.includes(newState.entity_id);\n    });\n});\nvar mergedStates = [...newStates, ...filteredStates];\nglobal.set(GLOBAL_CACHED_STATES_KEY, mergedStates);\nmsg.payload = mergedStates;\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2390,"y":220,"wires":[["ec7a7c4fc1be7da4"]]},{"id":"cfca5cecead45ab0","type":"change","z":"4f871e90.29a61","name":"","rules":[{"t":"set","p":"entities","pt":"msg","to":"[]","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":840,"y":420,"wires":[["5a415217dc8072e4"]]},{"id":"293ebfd2ebe5c2b8","type":"ha-get-entities","z":"4f871e90.29a61","name":"get locks","server":"79544c2b.6ccc64","version":1,"rules":[{"property":"entity_id","logic":"includes","value":"[\t  \"lock.front_door\",\t  \"lock.garage_entry_door\",\t  \"lock.back_door\"\t]","valueType":"jsonata"}],"outputType":"array","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"payload","outputResultsCount":1,"x":1440,"y":560,"wires":[["a87efff9938b8dac"]]},{"id":"619e4ee3ae827285","type":"change","z":"4f871e90.29a61","name":"","rules":[{"t":"set","p":"payload.domain","pt":"msg","to":"lock","tot":"str"},{"t":"set","p":"payload.service","pt":"msg","to":"lock","tot":"str"},{"t":"set","p":"payload.data","pt":"msg","to":"{\t   \"entity_id\": payload.entity_id\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1740,"y":560,"wires":[["6c87cfb7df98d685"]]},{"id":"a87efff9938b8dac","type":"split","z":"4f871e90.29a61","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1610,"y":560,"wires":[["619e4ee3ae827285"]]},{"id":"78e197d75299a904","type":"change","z":"4f871e90.29a61","name":"","rules":[{"t":"set","p":"entities","pt":"msg","to":"(\t    $append(entities, payload)\t)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":2040,"y":560,"wires":[["9fa04b923759685a"]]},{"id":"6c87cfb7df98d685","type":"join","z":"4f871e90.29a61","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":1870,"y":560,"wires":[["78e197d75299a904"]]},{"id":"9fa04b923759685a","type":"ha-get-entities","z":"4f871e90.29a61","name":"get garage door","server":"79544c2b.6ccc64","version":1,"rules":[{"condition":"state_object","property":"entity_id","logic":"includes","value":"[\t  \"cover.ratgdov25i_4b1c3b_door\"\t]","valueType":"jsonata"}],"outputType":"array","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"payload","outputResultsCount":1,"x":1460,"y":620,"wires":[["3f62d8da04c95edf"]]},{"id":"55403b84be6b5856","type":"change","z":"4f871e90.29a61","name":"","rules":[{"t":"set","p":"payload.domain","pt":"msg","to":"cover","tot":"str"},{"t":"set","p":"payload.service","pt":"msg","to":"close_cover","tot":"str"},{"t":"set","p":"payload.data","pt":"msg","to":"{\t   \"entity_id\": payload.entity_id\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1740,"y":620,"wires":[["8527a385b31f9b8d"]]},{"id":"3f62d8da04c95edf","type":"split","z":"4f871e90.29a61","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1610,"y":620,"wires":[["55403b84be6b5856"]]},{"id":"8527a385b31f9b8d","type":"join","z":"4f871e90.29a61","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":1870,"y":620,"wires":[["cbf834d9eafe2d6e"]]},{"id":"715a229a5e312dca","type":"function","z":"4f871e90.29a61","name":"push cached states","func":"// src/utils/utils.ts\nvar GLOBAL_CACHED_STATES_KEY = \"cachedStates\";\n\n// src/cache-states/push-cache-states.ts\nvar newStates = msg.payload;\nvar cachedStates = global.get(GLOBAL_CACHED_STATES_KEY) ?? [];\nvar filteredStates = cachedStates.filter((cachedState) => {\n    const cachedId = cachedState?.target?.entity_id ?? cachedState.data?.entity_id;\n    const cachedIds = Array.isArray(cachedId) ? cachedId : [cachedId];\n    return !newStates.find((newState) => {\n        return cachedIds.includes(newState.entity_id);\n    });\n});\nvar mergedStates = [...newStates, ...filteredStates];\nglobal.set(GLOBAL_CACHED_STATES_KEY, mergedStates);\nmsg.payload = mergedStates;\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2390,"y":680,"wires":[["03249c45bcec909b"]]},{"id":"cbf834d9eafe2d6e","type":"change","z":"4f871e90.29a61","name":"","rules":[{"t":"set","p":"entities","pt":"msg","to":"(\t    $append(entities, payload)\t)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":2040,"y":620,"wires":[["bdf838130e4e7a90"]]},{"id":"506c64c1609cfe65","type":"change","z":"4f871e90.29a61","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"(\t    $append(entities, payload)\t)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":2230,"y":680,"wires":[["715a229a5e312dca"]]},{"id":"bdf838130e4e7a90","type":"change","z":"4f871e90.29a61","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"[\"light\",\"switch\",\"fan\",\"lock\",\"cover\",\"climate\",\"media_player\"]","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":1470,"y":680,"wires":[["3a5517697f2c3002"]]},{"id":"08f84c6d37343c7a","type":"function","z":"4f871e90.29a61","name":"filter blacklisted entities","func":"// src/utils/utils.ts\nfunction getEntityDomain(entityId) {\n    const match = entityId.match(/^(.*)\\..*$/);\n    return match ? match[1] : entityId;\n}\nvar normalizeIncludes = (s1, s2) => {\n    return s1.toLowerCase().includes(s2.toLowerCase());\n};\nvar isBlacklisted = (entity_id, blacklisted) => {\n    return blacklisted.some((blacklistItem) => {\n        if (typeof blacklistItem === \"string\") {\n            return normalizeIncludes(entity_id, blacklistItem);\n        } else {\n            return blacklistItem.test(entity_id);\n        }\n    });\n};\nvar BLACKLISTED_ENTITIES = [\n    // car\n    \"son_of_toast\",\n    // grow lights\n    /.*grow.*/i,\n    // blinds\n    /.*blinds.*/i,\n    // air purifiers\n    /.*air_purifier.*/i,\n    // garage door\n    /switch.ratgdov25i_4b1c3b.*/i,\n    \"lock.ratgdov25i_4b1c3b_lock_remotes\",\n    // sonos\n    /.*sonos_beam.*/i,\n    // washer/dryer\n    \"washer_power\",\n    \"dryer_power\",\n    // water pump\n    \"switch.plant_water_pump_switch\",\n    // ESPresnce:\n    /espresense_.*/i\n];\nvar filterBlacklistedEntity = (e, blacklist = BLACKLISTED_ENTITIES) => {\n    let entity_id;\n    let state;\n    if (typeof e === \"string\") {\n        entity_id = e;\n        state = void 0;\n    } else {\n        entity_id = e.entity_id;\n        state = e.state;\n    }\n    const whitelisted = !isBlacklisted(entity_id, blacklist);\n    const inDomain = domains ? domains.includes(getEntityDomain(entity_id)) : true;\n    const isUnavailable = state === \"unavailable\" || state === \"unknown\";\n    return whitelisted && inDomain && !isUnavailable;\n};\nvar domains = [\"light\", \"switch\", \"fan\", \"climate\", \"lock\", \"cover\", \"media_player\"];\n\n// src/cache-states/filter-blacklisted-entities.ts\nvar message = msg;\nvar entities = Array.isArray(message.payload) ? message.payload : [message.payload];\nvar filteredEntities = entities.filter((e) => {\n    return filterBlacklistedEntity(e);\n});\nmsg.payload = filteredEntities;\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1870,"y":680,"wires":[["506c64c1609cfe65"]]},{"id":"d5d201c5e59b6752","type":"debug","z":"4f871e90.29a61","name":"debug 36","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":240,"y":280,"wires":[]},{"id":"ad3f451b286687f1","type":"change","z":"4f871e90.29a61","name":"clear cache","rules":[{"t":"set","p":"cachedStates","pt":"global","to":"{}","tot":"json","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":1230,"y":100,"wires":[[]]},{"id":"a002d0429878b211","type":"inject","z":"4f871e90.29a61","name":"force home","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1070,"y":100,"wires":[["ad3f451b286687f1"]]},{"id":"20d9cf93f238d30f","type":"function","z":"4f871e90.29a61","name":"home status","func":"\"use strict\";\nconst STABLE_PERIOD_MS = 5 * 60 * 1e3;\nconst DEBOUNCE_DELAY_MS = 30 * 1e3;\nconst message = msg;\nconst lastState = flow.get(\"home_status_last_state\") || null;\nconst lastChangeTime = flow.get(\"home_status_last_change_time\") || 0;\nconst pendingTimeout = flow.get(\"home_status_pending_timeout\") || null;\nconst currentState = message.payload;\nconst currentTime = Date.now();\nconst timeSinceLastChange = currentTime - lastChangeTime;\nfunction processStateChange() {\n    if (pendingTimeout) {\n        clearTimeout(pendingTimeout);\n        flow.set(\"home_status_pending_timeout\", null);\n    }\n    if (currentState !== lastState) {\n        flow.set(\"home_status_last_state\", currentState);\n        flow.set(\"home_status_last_change_time\", currentTime);\n        if (timeSinceLastChange > STABLE_PERIOD_MS) {\n            node.status({ fill: \"green\", shape: \"dot\", text: \"Immediate trigger\" });\n            return {\n                topic: \"home_status_change\",\n                payload: currentState,\n                immediate: true\n            };\n        } else {\n            node.status({ fill: \"yellow\", shape: \"ring\", text: \"Waiting 30s\" });\n            const timeout = setTimeout(() => {\n                const latestState = flow.get(\"home_status_last_state\");\n                if (latestState === currentState) {\n                    node.send({\n                        topic: \"home_status_change\",\n                        payload: latestState,\n                        delayed: true\n                    });\n                    node.status({\n                        fill: \"blue\",\n                        shape: \"dot\",\n                        text: \"Delayed trigger\"\n                    });\n                } else {\n                    node.status({\n                        fill: \"grey\",\n                        shape: \"ring\",\n                        text: \"State changed during wait\"\n                    });\n                }\n                flow.set(\"home_status_pending_timeout\", null);\n            }, DEBOUNCE_DELAY_MS);\n            flow.set(\"home_status_pending_timeout\", timeout);\n            return null;\n        }\n    } else {\n        node.status({ fill: \"grey\", shape: \"dot\", text: \"No change\" });\n        return null;\n    }\n}\nmsg = processStateChange();\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":420,"wires":[["36499af3d5b1a244"]]},{"id":"c5a28c2f56f4c191","type":"debug","z":"4f871e90.29a61","name":"debug 15","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1400,"y":40,"wires":[]},{"id":"e72aec74c9a990ff","type":"change","z":"4f871e90.29a61","name":"get cache","rules":[{"t":"set","p":"payload","pt":"msg","to":"cachedStates","tot":"global","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":1220,"y":40,"wires":[["c5a28c2f56f4c191"]]},{"id":"0f803d3c2b3ba32a","type":"inject","z":"4f871e90.29a61","name":"force home","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1070,"y":40,"wires":[["e72aec74c9a990ff"]]},{"id":"b764187b2bf86692","type":"api-call-service","z":"fbed070118aafd67","name":"set home","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"input_select.select_option","floorId":[],"areaId":[],"deviceId":[],"entityId":["input_select.home_status"],"labelId":[],"data":"{\"option\":\"home\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":false,"domain":"input_select","service":"select_option","x":1900,"y":400,"wires":[[]]},{"id":"3b04c7bd08ad3350","type":"geofence","z":"fbed070118aafd67","name":"inside home strip","mode":"circle","inside":"both","rad":374.1970582718112,"points":[],"centre":{"latitude":35.805082127758816,"longitude":-78.79333645105362},"floor":"","ceiling":"","worldmap":false,"outputs":1,"x":1430,"y":140,"wires":[["40b1f09721c5fdbc"]]},{"id":"2133948d2fb6b494","type":"server-state-changed","z":"fbed070118aafd67","name":"tesla going home?","server":"79544c2b.6ccc64","version":6,"outputs":2,"exposeAsEntityConfig":"","entities":{"entity":["device_tracker.son_of_toast_destination_location_tracker"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"home","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"1","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"tesla_payload","propertyType":"msg","value":"","valueType":"entityState"}],"x":410,"y":1100,"wires":[["cfc0e9e02322cff7"],[]]},{"id":"9006ee6da49f45c0","type":"api-call-service","z":"fbed070118aafd67","name":"set en route","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"input_select.select_option","floorId":[],"areaId":[],"deviceId":[],"entityId":["input_select.home_status"],"labelId":[],"data":"{\"option\":\"en route\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":false,"domain":"input_select","service":"select_option","x":1910,"y":1100,"wires":[[]]},{"id":"f1745276090e1c83","type":"change","z":"fbed070118aafd67","name":"set lat/lon","rules":[{"t":"set","p":"lat","pt":"msg","to":"data.attributes.latitude","tot":"msg"},{"t":"set","p":"lon","pt":"msg","to":"data.attributes.longitude","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1280,"y":140,"wires":[["3b04c7bd08ad3350"]]},{"id":"fc9815879580cc6a","type":"api-current-state","z":"fbed070118aafd67","name":"","server":"79544c2b.6ccc64","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"device_tracker.fff","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1090,"y":140,"wires":[["f1745276090e1c83"]]},{"id":"c63d62bada776177","type":"server-state-changed","z":"fbed070118aafd67","name":"","server":"79544c2b.6ccc64","version":6,"outputs":2,"exposeAsEntityConfig":"","entities":{"entity":["person.mike"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"home","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"2","forType":"num","forUnits":"seconds","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":440,"y":620,"wires":[["b764187b2bf86692"],["0c6f93b6d5a25bb5","bf35053764883c72"]]},{"id":"40b1f09721c5fdbc","type":"switch","z":"fbed070118aafd67","name":"","property":"location.inarea","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1570,"y":140,"wires":[["b764187b2bf86692"],[]]},{"id":"9d254f4ec4338e41","type":"api-call-service","z":"fbed070118aafd67","name":"set away","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"input_select.select_option","floorId":[],"areaId":[],"deviceId":[],"entityId":["input_select.home_status"],"labelId":[],"data":"{\"option\":\"away\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":false,"domain":"input_select","service":"select_option","x":1900,"y":760,"wires":[[]]},{"id":"035ed2afcb7d3be3","type":"api-current-state","z":"fbed070118aafd67","name":"en route?","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"en route","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_select.home_status","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":720,"y":140,"wires":[["4e10201374dec1c0","fc9815879580cc6a"],[]]},{"id":"903134dffbcf49cf","type":"switch","z":"fbed070118aafd67","name":"home status","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"home","vt":"str"},{"t":"eq","v":"away","vt":"str"},{"t":"eq","v":"en route","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":770,"y":1100,"wires":[[],["cfa5cc7974a215f6"],["cfa5cc7974a215f6"]]},{"id":"cfc0e9e02322cff7","type":"api-current-state","z":"fbed070118aafd67","name":"home?","server":"79544c2b.6ccc64","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_select.home_status","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":600,"y":1100,"wires":[["903134dffbcf49cf"]]},{"id":"cfa5cc7974a215f6","type":"switch","z":"fbed070118aafd67","name":"tesla destination","property":"tesla_payload","propertyType":"msg","rules":[{"t":"eq","v":"home","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":980,"y":1100,"wires":[["9006ee6da49f45c0"],["96e140f163889a06"]]},{"id":"96e140f163889a06","type":"subflow:c15b1459ec3be250","z":"fbed070118aafd67","name":"","x":1140,"y":1220,"wires":[[]]},{"id":"a19eed409595a8ab","type":"comment","z":"fbed070118aafd67","name":"route's changed from home to x","info":"","x":1190,"y":1260,"wires":[]},{"id":"0c6f93b6d5a25bb5","type":"api-current-state","z":"fbed070118aafd67","name":"","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"Babber","halt_if_type":"str","halt_if_compare":"is_not","entity_id":"sensor.fff_ssid","state_type":"str","blockInputOverrides":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"seconds","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":820,"y":780,"wires":[["07a2b43336b6640d"],[]]},{"id":"eef557a37abe6049","type":"server-state-changed","z":"fbed070118aafd67","name":"","server":"79544c2b.6ccc64","version":6,"outputs":2,"exposeAsEntityConfig":"","entities":{"entity":["device_tracker.son_of_toast_location_tracker"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"home","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"seconds","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":540,"y":460,"wires":[["b764187b2bf86692"],[]]},{"id":"bf35053764883c72","type":"delay","z":"fbed070118aafd67","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":580,"y":780,"wires":[["0c6f93b6d5a25bb5","24928e228fea6404","274ab394f4de17c4"]]},{"id":"24928e228fea6404","type":"api-current-state","z":"fbed070118aafd67","name":"","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"home","halt_if_type":"str","halt_if_compare":"is_not","entity_id":"device_tracker.son_of_toast_location_tracker","state_type":"str","blockInputOverrides":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"seconds","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":920,"y":860,"wires":[["07a2b43336b6640d"],[]]},{"id":"07a2b43336b6640d","type":"api-current-state","z":"fbed070118aafd67","name":"","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"home","halt_if_type":"str","halt_if_compare":"is_not","entity_id":"person.mike","state_type":"str","blockInputOverrides":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1340,"y":780,"wires":[["9d254f4ec4338e41"],[]]},{"id":"4e10201374dec1c0","type":"delay","z":"fbed070118aafd67","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":720,"y":40,"wires":[["035ed2afcb7d3be3"]]},{"id":"d39e9ccc6343b058","type":"server-state-changed","z":"fbed070118aafd67","name":"en route?","server":"79544c2b.6ccc64","version":6,"outputs":2,"exposeAsEntityConfig":"","entities":{"entity":["input_select.home_status"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"en route","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"seconds","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":380,"y":140,"wires":[["035ed2afcb7d3be3"],[]]},{"id":"d8a6686cdee925d3","type":"server-state-changed","z":"fbed070118aafd67","name":"","server":"79544c2b.6ccc64","version":6,"outputs":2,"exposeAsEntityConfig":"","entities":{"entity":["sensor.fff_ssid"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"Babber","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"seconds","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":440,"y":320,"wires":[["b764187b2bf86692"],[]]},{"id":"274ab394f4de17c4","type":"api-current-state","z":"fbed070118aafd67","name":"","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"home","halt_if_type":"str","halt_if_compare":"is_not","entity_id":"person.mike","state_type":"str","blockInputOverrides":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":820,"y":940,"wires":[["9d254f4ec4338e41"],[]]},{"id":"cc165a4970b40f6e","type":"light-transition","z":"a807a4834abd67fa","name":"","startRGB":"#ff0000","transitionRGB":"#ffc864","endRGB":"#ffd6aa","startMired":"","endMired":"","transitionTime":"30","transitionTimeUnits":"Minute","steps":"30","startBright":"1","endBright":"100","brightnessType":"Percent","transitionType":"Exponential","colorTransitionType":"Weighted","x":2960,"y":380,"wires":[["11b9cbb7c3856a5c","01e8205e3f784b9c"],[]]},{"id":"0422eb9fb09dc288","type":"ha-get-entities","z":"a807a4834abd67fa","name":"get wakeup lights","server":"79544c2b.6ccc64","version":1,"rules":[{"condition":"state_object","property":"entity_id","logic":"includes","value":"[\t    \"light.pineapple_light\",\t    \"light.rose_light\"\t]","valueType":"jsonata"}],"outputType":"array","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"payload","outputResultsCount":1,"x":4350,"y":140,"wires":[["0b1846f382cad98e"]]},{"id":"0b1846f382cad98e","type":"split","z":"a807a4834abd67fa","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":4490,"y":140,"wires":[["02e5b35bdaaf543d"]]},{"id":"02e5b35bdaaf543d","type":"api-call-service","z":"a807a4834abd67fa","name":"","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"light.turn_on","floorId":[],"areaId":[],"deviceId":[],"entityId":["{{payload.entity_id}}"],"labelId":[],"data":"{\t   \"brightness_pct\": transition.brightness_pct,\t   \"rgb_color\": transition.rgb_color\t}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":false,"domain":"light","service":"turn_on","x":4710,"y":140,"wires":[[]]},{"id":"f9ea29062fcf5907","type":"change","z":"a807a4834abd67fa","name":"","rules":[{"t":"set","p":"transition","pt":"msg","to":"payload","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":4150,"y":140,"wires":[["0422eb9fb09dc288"]]},{"id":"32104a6cfcd7d80c","type":"split","z":"a807a4834abd67fa","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":3730,"y":760,"wires":[["85075e6971f5ac08"]]},{"id":"b6372785647d335b","type":"server-state-changed","z":"a807a4834abd67fa","name":"","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":[],"substring":[],"regex":["input_datetime\\.(.*sleep.*)"]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is_not","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":660,"y":1240,"wires":[["356eb090fd692a91"]]},{"id":"7a9667c3be337043","type":"chronos-scheduler","z":"a807a4834abd67fa","name":"","config":"0f0bd6e74f18a17d","schedule":[{"trigger":{"type":"flow","value":"weekday_sleep","offset":0,"random":false},"output":{"type":"msg","property":{"name":"schedule","type":"str","value":"weekday_sleep"}}},{"trigger":{"type":"flow","value":"weekday_wakeup","offset":0,"random":false},"output":{"type":"msg","property":{"name":"schedule","type":"str","value":"weekday_wakeup"}}},{"trigger":{"type":"flow","value":"pre_weekday_wakeup","offset":0,"random":false},"output":{"type":"msg","property":{"name":"schedule","type":"str","value":"pre_weekday_wakeup"}}},{"trigger":{"type":"flow","value":"weekend_sleep","offset":0,"random":false},"output":{"type":"msg","property":{"name":"schedule","type":"str","value":"weekend_sleep"}}},{"trigger":{"type":"flow","value":"weekend_wakeup","offset":0,"random":false},"output":{"type":"msg","property":{"name":"schedule","type":"str","value":"weekend_wakeup"}}},{"trigger":{"type":"flow","value":"pre_weekend_wakeup","offset":0,"random":false},"output":{"type":"msg","property":{"name":"schedule","type":"str","value":"pre_weekend_wakeup"}}}],"disabled":false,"multiPort":false,"nextEventPort":false,"delayOnStart":true,"onStartDelay":"","outputs":1,"x":1580,"y":1340,"wires":[["53396dd24ab020c6"]]},{"id":"872a4dcbed026511","type":"function","z":"a807a4834abd67fa","name":"create schedule cron","func":"\"use strict\";\nfunction getEntityBasename(entityId) {\n    const match = entityId.match(/^.*\\.(.*)$/);\n    return match ? match[1] : entityId;\n}\nfunction getTimeComponents(time) {\n    let timeParts = time.split(\":\");\n    let [hours, mins, seconds] = timeParts.concat(Array(3 - timeParts.length).fill(\"00\")).map((x) => parseInt(x));\n    return [hours, mins, seconds];\n}\nfunction normalizeTime(time) {\n    let [hours, mins, seconds] = getTimeComponents(time);\n    return `${hours}:${mins}:${seconds}`;\n}\nfunction dateToTimeString(date) {\n    return date.toTimeString().split(\" \")[0];\n}\nfunction timeStringToDate(time) {\n    time = normalizeTime(time);\n    let [hours, mins, seconds] = getTimeComponents(time);\n    let date = /* @__PURE__ */ new Date();\n    date.setHours(hours);\n    date.setMinutes(mins);\n    date.setSeconds(seconds);\n    return date;\n}\nfunction extractTimeFromPayload(entityId, payload2) {\n    const entity = payload2.find((item) => item.entity_id === entityId);\n    return entity ? normalizeTime(entity.state) : \"00:00:00\";\n}\nfunction createChronosCronEntry(cronExpression) {\n    return {\n        type: \"crontab\",\n        value: cronExpression\n    };\n}\nfunction createWeekdayCronEntry(time) {\n    const [hours, minutes, seconds] = getTimeComponents(time);\n    return `${seconds} ${minutes} ${hours} * * 1-5`;\n}\nfunction createWeekendCronEntry(time) {\n    const [hours, minutes, seconds] = getTimeComponents(time);\n    return `${seconds} ${minutes} ${hours} * * 0,6`;\n}\nfunction createCronEntry(basename, time) {\n    return basename.includes(\"weekday\") ? createWeekdayCronEntry(time) : createWeekendCronEntry(time);\n}\nconst now = /* @__PURE__ */ new Date();\nconst offset = msg.offset || 30;\nconst payload = msg.payload.sort((a, b) => a.entity_id.localeCompare(b.entity_id));\nlet schedules = /* @__PURE__ */ new Map();\npayload.forEach((entity) => {\n    const basename = getEntityBasename(entity.entity_id);\n    let time = extractTimeFromPayload(entity.entity_id, payload);\n    schedules.set(basename, { time, cron: createCronEntry(basename, time) });\n    const scheduleTime = timeStringToDate(time);\n    if (basename.includes(\"wakeup\")) {\n        const offsetTime = new Date(scheduleTime.getTime());\n        offsetTime.setMinutes(scheduleTime.getMinutes() - offset);\n        if (now.getTime() >= offsetTime.getTime() && now.getTime() <= scheduleTime.getTime()) {\n            offsetTime.setMinutes(now.getMinutes() - scheduleTime.getMinutes());\n        }\n        time = dateToTimeString(offsetTime);\n        const preName = `pre_${basename}`;\n        schedules.set(preName, { time, cron: createCronEntry(preName, time) });\n    }\n});\nmsg.schedules = schedules;\nmsg.payload = Array.from(schedules).map(([key, { time, cron }]) => {\n    const cronEntry = createChronosCronEntry(cron);\n    flow.set(key, cronEntry);\n    return cronEntry;\n});\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1360,"y":1340,"wires":[["7a9667c3be337043"]]},{"id":"3734f28ccd07e7f3","type":"ha-get-entities","z":"a807a4834abd67fa","name":"get schedule entities","server":"79544c2b.6ccc64","version":1,"rules":[{"property":"entity_id","logic":"includes","value":"[\t  \"input_datetime.weekday_wakeup\",\t  \"input_datetime.weekend_wakeup\",\t  \t  \"input_datetime.weekday_sleep\",\t  \"input_datetime.weekend_sleep\"\t]","valueType":"jsonata","condition":"state_object"}],"outputType":"array","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"payload","outputResultsCount":1,"x":1100,"y":1340,"wires":[["872a4dcbed026511"]]},{"id":"37952235efc58d35","type":"inject","z":"a807a4834abd67fa","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"600","crontab":"","once":true,"onceDelay":"10","topic":"","payload":"","payloadType":"date","x":590,"y":1340,"wires":[["3734f28ccd07e7f3"]]},{"id":"0e2a4a615ea99b3c","type":"subflow:e920ad5e223ac1b7","z":"a807a4834abd67fa","name":"","x":3580,"y":760,"wires":[["32104a6cfcd7d80c"]]},{"id":"51ea59ad6934b44f","type":"change","z":"a807a4834abd67fa","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"[\"light\"]","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":3390,"y":760,"wires":[["0e2a4a615ea99b3c"]]},{"id":"356eb090fd692a91","type":"debounce-advanced","z":"a807a4834abd67fa","time":"0","timeunit":"s","debouncetype":"trailing","name":"","x":950,"y":1240,"wires":[["3734f28ccd07e7f3"]]},{"id":"8f74c5db4352bd5d","type":"server-state-changed","z":"a807a4834abd67fa","name":"","server":"79544c2b.6ccc64","version":6,"outputs":2,"exposeAsEntityConfig":"","entities":{"entity":["input_select.day_status"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"day","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":3010,"y":760,"wires":[["51ea59ad6934b44f"],[]]},{"id":"606d4155fa3f55bd","type":"api-call-service","z":"a807a4834abd67fa","name":"set day","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"input_select.select_option","floorId":[],"areaId":[],"deviceId":[],"entityId":["input_select.day_status"],"labelId":[],"data":"{\"option\":\"day\"}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":false,"domain":"input_select","service":"select_option","x":2960,"y":520,"wires":[[]]},{"id":"168806dc27809c82","type":"api-current-state","z":"a807a4834abd67fa","name":"daytime set?","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"day","halt_if_type":"str","halt_if_compare":"is_not","entity_id":"input_select.day_status","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":2450,"y":1100,"wires":[["e52aa73d70d47574"],[]]},{"id":"fad0b29006fab2cc","type":"server-state-changed","z":"a807a4834abd67fa","name":"","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":[],"substring":[],"regex":["input_datetime\\.(.*wakeup.*)"]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is_not","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":670,"y":1180,"wires":[["356eb090fd692a91"]]},{"id":"d16b41ebcedebc89","type":"api-current-state","z":"a807a4834abd67fa","name":"nighttime set?","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"night","halt_if_type":"str","halt_if_compare":"is_not","entity_id":"input_select.day_status","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":2460,"y":1560,"wires":[["9b3af325b18ed95a"],[]]},{"id":"2ff7629dbeee6675","type":"server-state-changed","z":"a807a4834abd67fa","name":"","server":"79544c2b.6ccc64","version":6,"outputs":2,"exposeAsEntityConfig":"","entities":{"entity":["input_select.day_status"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"night","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":3010,"y":1920,"wires":[["d8eb9ba5f9a4bd28"],[]]},{"id":"9b3af325b18ed95a","type":"api-call-service","z":"a807a4834abd67fa","name":"set night","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"input_select.select_option","floorId":[],"areaId":[],"deviceId":[],"entityId":["input_select.day_status"],"labelId":[],"data":"{\"option\": \"night\"}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":false,"domain":"input_select","service":"select_option","x":2920,"y":1860,"wires":[[]]},{"id":"e9059cbb24d20445","type":"join","z":"a807a4834abd67fa","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":3990,"y":760,"wires":[["afd75fd12e9a11e4"]]},{"id":"85075e6971f5ac08","type":"change","z":"a807a4834abd67fa","name":"","rules":[{"t":"set","p":"payload.domain","pt":"msg","to":"light","tot":"str"},{"t":"set","p":"payload.service","pt":"msg","to":"turn_on","tot":"str"},{"t":"set","p":"payload.data","pt":"msg","to":"{\t   \"entity_id\": payload.entity_id,\t   \"brightness_pct\":100,\t   \"kelvin\":3000\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":3860,"y":760,"wires":[["e9059cbb24d20445"]]},{"id":"bbed260afb0f59cb","type":"api-current-state","z":"a807a4834abd67fa","name":"home?","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"home","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_select.home_status","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":5080,"y":1340,"wires":[["915a6ad8ba5da771"],["fcef4072b3d808c5"]]},{"id":"915a6ad8ba5da771","type":"split","z":"a807a4834abd67fa","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":5250,"y":1200,"wires":[["c3cc139d3aa1325c"]]},{"id":"c3cc139d3aa1325c","type":"api-call-service","z":"a807a4834abd67fa","name":"","server":"79544c2b.6ccc64","version":7,"debugenabled":true,"action":"","floorId":[],"areaId":[],"deviceId":[],"entityId":[],"labelId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"all","blockInputOverrides":false,"domain":"","service":"","x":5410,"y":1200,"wires":[[]]},{"id":"fcef4072b3d808c5","type":"function","z":"a807a4834abd67fa","name":"merge cached states","func":"// src/utils/utils.ts\nvar GLOBAL_CACHED_STATES_KEY = \"cachedStates\";\nfunction getEntityBasename(entityId) {\n    const match = entityId.match(/^.*\\.(.*)$/);\n    return match ? match[1] : entityId;\n}\nvar createStatesMap = (states, basename = false) => {\n    return new Map(\n        states.filter((state) => state?.data?.entity_id != void 0).map((state) => {\n            const name = basename ? getEntityBasename(state.data.entity_id) : state.data.entity_id;\n            return [name, state];\n        })\n    );\n};\n\n// src/cache-states/merge-cached-states.ts\nvar cachedStates = global.get(GLOBAL_CACHED_STATES_KEY) ?? [];\nvar cachedStatesMap = createStatesMap(cachedStates);\nvar newStates = msg.payload;\nvar newStatesMap = createStatesMap(newStates);\nvar mergedStatesMap = new Map([...cachedStatesMap, ...newStatesMap]);\nvar mergedStates = Array.from(mergedStatesMap.values());\nglobal.set(GLOBAL_CACHED_STATES_KEY, mergedStates);\nmsg.payload = mergedStates;\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":5300,"y":1440,"wires":[[]]},{"id":"d8eb9ba5f9a4bd28","type":"api-current-state","z":"a807a4834abd67fa","name":"get scene","server":"79544c2b.6ccc64","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"scene.nighttime","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":3360,"y":1920,"wires":[["1848af0350bde8da"]]},{"id":"8c12f39274d6f891","type":"ha-api","z":"a807a4834abd67fa","name":"get scene states","server":"79544c2b.6ccc64","version":1,"debugenabled":false,"protocol":"http","method":"get","path":"/api/config/scene/config/{{payload}}","data":"","dataType":"jsonata","responseType":"json","outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"results"}],"x":3650,"y":1920,"wires":[["57ba98e05115a206"]]},{"id":"1848af0350bde8da","type":"change","z":"a807a4834abd67fa","name":"set scene id","rules":[{"t":"set","p":"payload","pt":"msg","to":"data.attributes.id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":3490,"y":1920,"wires":[["8c12f39274d6f891"]]},{"id":"57ba98e05115a206","type":"function","z":"a807a4834abd67fa","name":"merge scene cached states","func":"// src/utils/utils.ts\nvar GLOBAL_CACHED_STATES_KEY = \"cachedStates\";\nfunction getEntityBasename(entityId) {\n    const match = entityId.match(/^.*\\.(.*)$/);\n    return match ? match[1] : entityId;\n}\nfunction getEntityDomain(entityId) {\n    const match = entityId.match(/^(.*)\\..*$/);\n    return match ? match[1] : entityId;\n}\nvar setIfExists = (to, from, key) => {\n    const value = from[key];\n    if (value != null) {\n        to[key] = value;\n        return true;\n    } else {\n        return false;\n    }\n};\nvar lightAttributes = [\"brightness\"];\nvar fanAttributes = [\"percentage\"];\nvar climateAttributes = [\"preset_mode\"];\nvar domains = [\"light\", \"switch\", \"fan\", \"climate\", \"lock\", \"cover\", \"media_player\"];\nvar filterAttributes = function (domain, service, attributes) {\n    let data = {};\n    switch (domain) {\n        case \"light\": {\n            const colorMode = attributes[\"color_mode\"];\n            if (attributes[colorMode] != void 0) {\n                data[colorMode] = attributes[colorMode];\n            }\n            const colorModeColor = `${colorMode}_color`;\n            if (attributes[colorModeColor] != void 0) {\n                data[colorModeColor] = attributes[colorModeColor];\n            }\n            if (service === \"turn_off\") {\n                break;\n            }\n            lightAttributes.forEach((x) => setIfExists(data, attributes, x));\n            break;\n        }\n        case \"fan\": {\n            if (service === \"turn_off\") {\n                break;\n            }\n            fanAttributes.forEach((x) => setIfExists(data, attributes, x));\n            break;\n        }\n        case \"climate\": {\n            climateAttributes.forEach((x) => setIfExists(data, attributes, x));\n            break;\n        }\n    }\n    return data;\n};\nvar domainToService = function (entity, domain) {\n    switch (domain) {\n        case \"switch\":\n        case \"light\":\n        case \"fan\": {\n            return `turn_${entity.state}`;\n        }\n        case \"media_player\": {\n            switch (entity.state) {\n                case \"standby\":\n                case \"off\":\n                    return \"turn_off\";\n                case \"on\":\n                    return \"turn_on\";\n                case \"playing\":\n                    return \"media_play\";\n                case \"paused\":\n                    return \"media_pause\";\n                default:\n                    return \"turn_off\";\n            }\n        }\n        case \"lock\": {\n            switch (entity.state) {\n                case \"locked\":\n                    return \"lock\";\n                case \"unlocked\":\n                    return \"unlock\";\n            }\n            break;\n        }\n        case \"cover\": {\n            switch (entity.state) {\n                case \"open\":\n                    return \"open_cover\";\n                case \"closed\":\n                    return \"close_cover\";\n            }\n            break;\n        }\n        case \"climate\": {\n            return \"set_preset_mode\";\n        }\n    }\n    return void 0;\n};\nvar createServiceCall = (entity) => {\n    const domain = getEntityDomain(entity.entity_id);\n    const service = domainToService(entity, domain);\n    if (!domains.includes(domain) || service === void 0) {\n        return void 0;\n    }\n    return {\n        domain,\n        service,\n        data: {\n            entity_id: entity.entity_id,\n            // state: entity.state,\n            ...filterAttributes(domain, service, entity.attributes)\n        }\n    };\n};\nvar createStatesMap = (states, basename = false) => {\n    return new Map(\n        states.filter((state) => state?.data?.entity_id != void 0).map((state) => {\n            const name = basename ? getEntityBasename(state.data.entity_id) : state.data.entity_id;\n            return [name, state];\n        })\n    );\n};\n\n// src/cache-states/merge-scene-cached-states.ts\nvar cachedStates = global.get(GLOBAL_CACHED_STATES_KEY) ?? [];\nvar cachedStatesMap = createStatesMap(cachedStates);\nvar sceneStates = Object.entries(msg.payload.entities).map(([entity_id, state]) => {\n    return {\n        entity_id,\n        state: state.state,\n        attributes: {\n            ...state\n        }\n    };\n}).map(createServiceCall).filter((x) => x !== void 0);\nvar newStatesMap = createStatesMap(sceneStates);\nvar mergedStatesMap = new Map([...cachedStatesMap, ...newStatesMap]);\nvar mergedStates = Array.from(mergedStatesMap.values());\nglobal.set(GLOBAL_CACHED_STATES_KEY, mergedStates);\nmsg.payload = mergedStates;\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3860,"y":1920,"wires":[["691a7ee6eb2c2047"]]},{"id":"53396dd24ab020c6","type":"switch","z":"a807a4834abd67fa","name":"","property":"schedule","propertyType":"msg","rules":[{"t":"cont","v":"wakeup","vt":"str"},{"t":"cont","v":"sleep","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1830,"y":1340,"wires":[["63ee49f27f7b8b98","168806dc27809c82"],["07d4d09cf5fbc022","d16b41ebcedebc89"]]},{"id":"420e26d574befd2f","type":"ha-get-entities","z":"a807a4834abd67fa","name":"get thermostats","server":"79544c2b.6ccc64","version":1,"rules":[{"property":"entity_id","logic":"includes","value":"[\t  \"climate.upstairs\",\t  \"climate.downstairs\"\t]","valueType":"jsonata","condition":"state_object"}],"outputType":"array","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"payload","outputResultsCount":1,"x":3380,"y":840,"wires":[["198e7a9a960eaeca"]]},{"id":"53b3e32eb94220e6","type":"change","z":"a807a4834abd67fa","name":"","rules":[{"t":"set","p":"payload.domain","pt":"msg","to":"climate","tot":"str"},{"t":"set","p":"payload.service","pt":"msg","to":"set_preset_mode","tot":"str"},{"t":"set","p":"payload.data","pt":"msg","to":"{\t   \"entity_id\": payload.entity_id,\t   \"preset_mode\": \"home\"\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":3640,"y":840,"wires":[["3be692408d563d35"]]},{"id":"198e7a9a960eaeca","type":"split","z":"a807a4834abd67fa","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":3510,"y":840,"wires":[["53b3e32eb94220e6"]]},{"id":"cc0610baf2dc75b3","type":"ha-get-entities","z":"a807a4834abd67fa","name":"get thermostats","server":"79544c2b.6ccc64","version":1,"rules":[{"property":"entity_id","logic":"includes","value":"[\t  \"climate.upstairs\",\t  \"climate.downstairs\"\t]","valueType":"jsonata"}],"outputType":"array","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"payload","outputResultsCount":1,"x":3380,"y":2000,"wires":[["ecda687ea847da9e"]]},{"id":"363a5f4ab1d3aba3","type":"change","z":"a807a4834abd67fa","name":"","rules":[{"t":"set","p":"payload.domain","pt":"msg","to":"climate","tot":"str"},{"t":"set","p":"payload.service","pt":"msg","to":"set_preset_mode","tot":"str"},{"t":"set","p":"payload.data","pt":"msg","to":"{\t   \"entity_id\": payload.entity_id,\t   \"preset_mode\": \"sleep\"\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":3640,"y":2000,"wires":[["5c0528a25c5b67cd"]]},{"id":"ecda687ea847da9e","type":"split","z":"a807a4834abd67fa","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":3510,"y":2000,"wires":[["363a5f4ab1d3aba3"]]},{"id":"a6a9fc466b7096e1","type":"change","z":"a807a4834abd67fa","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"input_select.day_status","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2910,"y":1340,"wires":[["4095e7742a165050"]]},{"id":"b473c1adfa11a83a","type":"api-call-service","z":"a807a4834abd67fa","name":"","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"input_select.select_option","floorId":[],"areaId":[],"deviceId":[],"entityId":["{{payload.entity_id}}"],"labelId":[],"data":"{\"option\": day_status}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":false,"domain":"input_select","service":"select_option","x":3320,"y":1340,"wires":[[]]},{"id":"7b2756f1f87d530c","type":"change","z":"a807a4834abd67fa","name":"set night","rules":[{"t":"set","p":"day_status","pt":"msg","to":"night","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2880,"y":1280,"wires":[["a6a9fc466b7096e1"]]},{"id":"108b8c2c46b4b50e","type":"change","z":"a807a4834abd67fa","name":"set day","rules":[{"t":"set","p":"day_status","pt":"msg","to":"day","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2880,"y":1400,"wires":[["a6a9fc466b7096e1"]]},{"id":"4095e7742a165050","type":"subflow:c15b1459ec3be250","z":"a807a4834abd67fa","name":"","x":3100,"y":1340,"wires":[["b473c1adfa11a83a"]]},{"id":"3be692408d563d35","type":"join","z":"a807a4834abd67fa","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","useparts":true,"accumulate":"false","timeout":"","count":"","reduceRight":false,"x":3770,"y":840,"wires":[["9b6b75f1526c1e83"]]},{"id":"5c0528a25c5b67cd","type":"join","z":"a807a4834abd67fa","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":3770,"y":2000,"wires":[["f8ae1a047dc31b05"]]},{"id":"5b259a6231d4d47f","type":"change","z":"a807a4834abd67fa","name":"get cached States","rules":[{"t":"set","p":"payload","pt":"msg","to":"cachedStates","tot":"global"}],"action":"","property":"","from":"","to":"","reg":false,"x":3270,"y":2260,"wires":[["8539cd6cad734ec1"]]},{"id":"8539cd6cad734ec1","type":"split","z":"a807a4834abd67fa","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":3450,"y":2260,"wires":[["886134c605c52f11"]]},{"id":"886134c605c52f11","type":"api-call-service","z":"a807a4834abd67fa","name":"set home payload","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"floorId":[],"areaId":[],"deviceId":[],"entityId":[],"labelId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":false,"domain":"","service":"","x":3690,"y":2260,"wires":[[]]},{"id":"74903c5c98dc28fe","type":"inject","z":"a807a4834abd67fa","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":3020,"y":2260,"wires":[["5b259a6231d4d47f"]]},{"id":"e52aa73d70d47574","type":"switch","z":"a807a4834abd67fa","name":"","property":"schedule","propertyType":"msg","rules":[{"t":"regex","v":"^pre_","vt":"str","case":false},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":2790,"y":520,"wires":[["cc165a4970b40f6e"],["606d4155fa3f55bd"]]},{"id":"d433170f1e0e8ed9","type":"ha-get-entities","z":"a807a4834abd67fa","name":"get schedule entities","server":"79544c2b.6ccc64","version":1,"rules":[{"property":"entity_id","logic":"includes","value":"[\t  \"input_datetime.weekday_wakeup\",\t  \"input_datetime.weekend_wakeup\",\t  \t  \"input_datetime.weekday_sleep\",\t  \"input_datetime.weekend_sleep\"\t]","valueType":"jsonata"}],"outputType":"array","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"payload","outputResultsCount":1,"x":3400,"y":180,"wires":[["76883f7cb338fb52"]]},{"id":"76883f7cb338fb52","type":"function","z":"a807a4834abd67fa","name":"create schedule cron","func":"\"use strict\";\nfunction getEntityBasename(entityId) {\n    const match = entityId.match(/^.*\\.(.*)$/);\n    return match ? match[1] : entityId;\n}\nfunction getTimeComponents(time) {\n    let timeParts = time.split(\":\");\n    let [hours, mins, seconds] = timeParts.concat(Array(3 - timeParts.length).fill(\"00\")).map((x) => parseInt(x));\n    return [hours, mins, seconds];\n}\nfunction normalizeTime(time) {\n    let [hours, mins, seconds] = getTimeComponents(time);\n    return `${hours}:${mins}:${seconds}`;\n}\nfunction dateToTimeString(date) {\n    return date.toTimeString().split(\" \")[0];\n}\nfunction timeStringToDate(time) {\n    time = normalizeTime(time);\n    let [hours, mins, seconds] = getTimeComponents(time);\n    let date = /* @__PURE__ */ new Date();\n    date.setHours(hours);\n    date.setMinutes(mins);\n    date.setSeconds(seconds);\n    return date;\n}\nfunction extractTimeFromPayload(entityId, payload2) {\n    const entity = payload2.find((item) => item.entity_id === entityId);\n    return entity ? normalizeTime(entity.state) : \"00:00:00\";\n}\nfunction createChronosCronEntry(cronExpression) {\n    return {\n        type: \"crontab\",\n        value: cronExpression\n    };\n}\nfunction createWeekdayCronEntry(time) {\n    const [hours, minutes, seconds] = getTimeComponents(time);\n    return `${seconds} ${minutes} ${hours} * * 1-5`;\n}\nfunction createWeekendCronEntry(time) {\n    const [hours, minutes, seconds] = getTimeComponents(time);\n    return `${seconds} ${minutes} ${hours} * * 0,6`;\n}\nfunction createCronEntry(basename, time) {\n    return basename.includes(\"weekday\") ? createWeekdayCronEntry(time) : createWeekendCronEntry(time);\n}\nconst now = /* @__PURE__ */ new Date();\nconst offset = msg.offset || 30;\nconst payload = msg.payload.sort((a, b) => a.entity_id.localeCompare(b.entity_id));\nlet schedules = /* @__PURE__ */ new Map();\npayload.forEach((entity) => {\n    const basename = getEntityBasename(entity.entity_id);\n    let time = extractTimeFromPayload(entity.entity_id, payload);\n    schedules.set(basename, { time, cron: createCronEntry(basename, time) });\n    const dateTime = timeStringToDate(time);\n    if (basename.includes(\"wakeup\")) {\n        const offsetTime = new Date(dateTime.getTime());\n        offsetTime.setMinutes(dateTime.getMinutes() - offset);\n        if (offsetTime.getTime() < now.getTime()) {\n            offsetTime.setMinutes(now.getMinutes());\n            offsetTime.setSeconds(now.getSeconds() + 30);\n        }\n        if (offsetTime.getTime() >= dateTime.getTime()) {\n            offsetTime.setMinutes(dateTime.getMinutes());\n            offsetTime.setSeconds(dateTime.getSeconds() - 30);\n        }\n        time = dateToTimeString(offsetTime);\n        const preName = `pre_${basename}`;\n        schedules.set(preName, { time, cron: createCronEntry(preName, time) });\n    }\n});\nmsg.schedules = schedules;\nmsg.payload = Array.from(schedules).map(([key, { time, cron }]) => {\n    const cronEntry = createChronosCronEntry(cron);\n    flow.set(key, cronEntry);\n    return cronEntry;\n});\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3600,"y":180,"wires":[["8707143d8533922c"]]},{"id":"8707143d8533922c","type":"function","z":"a807a4834abd67fa","name":"inside preamble window","func":"\"use strict\";\nfunction getTimeComponents(time2) {\n    let timeParts = time2.split(\":\");\n    let [hours, mins, seconds] = timeParts.concat(Array(3 - timeParts.length).fill(\"00\")).map((x) => parseInt(x));\n    return [hours, mins, seconds];\n}\nfunction normalizeTime(time2) {\n    let [hours, mins, seconds] = getTimeComponents(time2);\n    return `${hours}:${mins}:${seconds}`;\n}\nfunction timeStringToDate(time2) {\n    time2 = normalizeTime(time2);\n    let [hours, mins, seconds] = getTimeComponents(time2);\n    let date = /* @__PURE__ */ new Date();\n    date.setHours(hours);\n    date.setMinutes(mins);\n    date.setSeconds(seconds);\n    return date;\n}\nconst schedules = msg.schedules;\nconst preScheduleName = msg.schedule;\nconst scheduleName = preScheduleName.replace(/^pre_/, \"\");\nconst schedule = schedules.get(scheduleName);\nconst preSchedule = schedules.get(preScheduleName);\nconst time = timeStringToDate(schedule.time);\nconst preTime = timeStringToDate(preSchedule.time);\nconst currentTime = /* @__PURE__ */ new Date();\nconst inPreambleWindow = currentTime >= preTime && currentTime < time;\nmsg.payload = inPreambleWindow;\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3810,"y":180,"wires":[["423e19e8b78d8a2d"]]},{"id":"423e19e8b78d8a2d","type":"switch","z":"a807a4834abd67fa","name":"","property":"payload","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":3990,"y":180,"wires":[["f9ea29062fcf5907"],["30af29b8ea474e61"]]},{"id":"30af29b8ea474e61","type":"change","z":"a807a4834abd67fa","name":"","rules":[{"t":"set","p":"transition","pt":"msg","to":"{\"duration\":1,\"units\":\"Second\",\"steps\":1}","tot":"json"},{"t":"set","p":"stop_transition","pt":"msg","to":"transition","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":4140,"y":220,"wires":[["cc165a4970b40f6e"]]},{"id":"11b9cbb7c3856a5c","type":"switch","z":"a807a4834abd67fa","name":"","property":"stop_transition","propertyType":"msg","rules":[{"t":"null"}],"checkall":"true","repair":false,"outputs":1,"x":2910,"y":240,"wires":[["ad359ee6b3eb8f32"]]},{"id":"07d4d09cf5fbc022","type":"debug","z":"a807a4834abd67fa","name":"debug 37","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1980,"y":1460,"wires":[]},{"id":"63ee49f27f7b8b98","type":"debug","z":"a807a4834abd67fa","name":"debug 38","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1980,"y":1220,"wires":[]},{"id":"4c5a50f162e45777","type":"subflow:e920ad5e223ac1b7","z":"a807a4834abd67fa","name":"","x":920,"y":2960,"wires":[["5d154d891c73053a","07b6a41fab2df991"]]},{"id":"e395b6f07c52671c","type":"inject","z":"a807a4834abd67fa","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"10","topic":"","payload":"","payloadType":"date","x":580,"y":2960,"wires":[["d577989ae6689041"]]},{"id":"5d154d891c73053a","type":"debug","z":"a807a4834abd67fa","name":"debug 44","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1120,"y":2960,"wires":[]},{"id":"d577989ae6689041","type":"change","z":"a807a4834abd67fa","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"[\"light\",\"switch\",\"fan\",\"lock\",\"cover\",\"climate\",\"media_player\"]","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":740,"y":2960,"wires":[["4c5a50f162e45777"]]},{"id":"7dd712474fc2f379","type":"http in","z":"a807a4834abd67fa","name":"","url":"/entities/","method":"get","upload":false,"swaggerDoc":"","x":600,"y":3060,"wires":[["d577989ae6689041"]]},{"id":"07b6a41fab2df991","type":"http response","z":"a807a4834abd67fa","name":"","statusCode":"200","headers":{},"x":1100,"y":3060,"wires":[]},{"id":"8137648e453ed0ff","type":"server-state-changed","z":"a807a4834abd67fa","name":"","server":"79544c2b.6ccc64","version":6,"outputs":2,"exposeAsEntityConfig":"","entities":{"entity":["sensor.lights_off_percentage"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"40","ifStateType":"num","ifStateOperator":"lt","outputOnlyOnStateChange":true,"for":"10","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":670,"y":1660,"wires":[["15688339b8c6395d"],["52236a075cbb5771"]]},{"id":"b0cc3bed71f1c8d5","type":"server-state-changed","z":"a807a4834abd67fa","name":"","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["scene.nighttime"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":630,"y":1520,"wires":[["53a7b1131c7355c9"]]},{"id":"53a7b1131c7355c9","type":"api-call-service","z":"a807a4834abd67fa","name":"set night","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"input_select.select_option","floorId":[],"areaId":[],"deviceId":[],"entityId":["input_select.day_status"],"labelId":[],"data":"{\"option\":\"night\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":false,"domain":"input_select","service":"select_option","x":1180,"y":1520,"wires":[[]]},{"id":"42fecf7052deebd5","type":"api-call-service","z":"a807a4834abd67fa","name":"set asleep","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"input_select.select_option","floorId":[],"areaId":[],"deviceId":[],"entityId":["input_select.awake_status"],"labelId":[],"data":"{\"option\":\"asleep\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":false,"domain":"input_select","service":"select_option","x":1190,"y":1620,"wires":[[]]},{"id":"15688339b8c6395d","type":"api-current-state","z":"a807a4834abd67fa","name":"is night?","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"night","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_select.day_status","state_type":"str","blockInputOverrides":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":980,"y":1620,"wires":[["42fecf7052deebd5"],[]]},{"id":"52236a075cbb5771","type":"api-current-state","z":"a807a4834abd67fa","name":"is night?","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"night","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_select.day_status","state_type":"str","blockInputOverrides":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":980,"y":1700,"wires":[["e24d8a60f573552b"],[]]},{"id":"e24d8a60f573552b","type":"api-call-service","z":"a807a4834abd67fa","name":"set awake","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"input_select.select_option","floorId":[],"areaId":[],"deviceId":[],"entityId":["input_select.awake_status"],"labelId":[],"data":"{\"option\":\"awake\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":false,"domain":"input_select","service":"select_option","x":1190,"y":1700,"wires":[[]]},{"id":"01e8205e3f784b9c","type":"debug","z":"a807a4834abd67fa","name":"debug 12","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3220,"y":380,"wires":[]},{"id":"aeb8bd410ba00682","type":"inject","z":"a807a4834abd67fa","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"10","topic":"","payload":"","payloadType":"date","x":2660,"y":1280,"wires":[["7b2756f1f87d530c"]]},{"id":"06b3d8f3beaee9fa","type":"inject","z":"a807a4834abd67fa","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"10","topic":"","payload":"","payloadType":"date","x":2660,"y":1400,"wires":[["108b8c2c46b4b50e"]]},{"id":"2b44d639215b4097","type":"server-state-changed","z":"a807a4834abd67fa","name":"","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["scene.daytime_2"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":630,"y":1460,"wires":[["a9e2365a6c5db716"]]},{"id":"a9e2365a6c5db716","type":"api-call-service","z":"a807a4834abd67fa","name":"set day","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"input_select.select_option","floorId":[],"areaId":[],"deviceId":[],"entityId":["input_select.day_status"],"labelId":[],"data":"{\"option\":\"day\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":false,"domain":"input_select","service":"select_option","x":1180,"y":1460,"wires":[[]]},{"id":"cc5b207c5b88f6da","type":"inject","z":"a807a4834abd67fa","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"10","topic":"","payload":"","payloadType":"date","x":2940,"y":700,"wires":[["51ea59ad6934b44f"]]},{"id":"ad359ee6b3eb8f32","type":"api-current-state","z":"a807a4834abd67fa","name":"daytime set?","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"day","halt_if_type":"str","halt_if_compare":"is_not","entity_id":"input_select.day_status","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":3070,"y":240,"wires":[["30af29b8ea474e61"],["d433170f1e0e8ed9"]]},{"id":"e7db7fb872b9b1a3","type":"server-state-changed","z":"a807a4834abd67fa","name":"daytime scene?","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["scene.daytime_2"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":2940,"y":820,"wires":[["c1a14bd3020d7443"]]},{"id":"c1a14bd3020d7443","type":"api-current-state","z":"a807a4834abd67fa","name":"is day?","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"day","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_select.day_status","state_type":"str","blockInputOverrides":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":3100,"y":820,"wires":[["51ea59ad6934b44f"],[]]},{"id":"a727a1ae82ebb076","type":"server-state-changed","z":"a807a4834abd67fa","name":"nighttime scene?","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["scene.nighttime"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":2940,"y":1980,"wires":[["d151caaeb77d1b71"]]},{"id":"d151caaeb77d1b71","type":"api-current-state","z":"a807a4834abd67fa","name":"is night?","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"night","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_select.day_status","state_type":"str","blockInputOverrides":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":3100,"y":1980,"wires":[["d8eb9ba5f9a4bd28"],[]]},{"id":"9e5fc0389e248778","type":"change","z":"a807a4834abd67fa","name":"","rules":[{"t":"set","p":"payload.domain","pt":"msg","to":"cover","tot":"str"},{"t":"set","p":"payload.service","pt":"msg","to":"set_cover_position","tot":"str"},{"t":"set","p":"payload.data","pt":"msg","to":"{\t   \"entity_id\": payload.entity_id,\t   \"position\": 3\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":3640,"y":920,"wires":[["26abe2480ee6d03e"]]},{"id":"eba440d3df2cc05b","type":"split","z":"a807a4834abd67fa","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":3510,"y":920,"wires":[["9e5fc0389e248778"]]},{"id":"c29bdf79ad7507b8","type":"change","z":"a807a4834abd67fa","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"(\t    $append(entities, payload)\t)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":4190,"y":920,"wires":[["1c8f57758fd2a09c"]]},{"id":"26abe2480ee6d03e","type":"join","z":"a807a4834abd67fa","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":3770,"y":920,"wires":[["c29bdf79ad7507b8"]]},{"id":"25f72f80fc63468b","type":"ha-get-entities","z":"a807a4834abd67fa","name":"get blinds","server":"79544c2b.6ccc64","version":1,"rules":[{"condition":"state_object","property":"entity_id","logic":"is","value":".*blinds.*","valueType":"re"},{"condition":"state_object","property":"entity_id","logic":"is","value":"cover\\..*","valueType":"re"}],"outputType":"array","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"payload","outputResultsCount":1,"x":3360,"y":920,"wires":[["eba440d3df2cc05b"]]},{"id":"afd75fd12e9a11e4","type":"change","z":"a807a4834abd67fa","name":"","rules":[{"t":"set","p":"entities","pt":"msg","to":"(\t    $append(entities, payload)\t)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":4180,"y":760,"wires":[["420e26d574befd2f"]]},{"id":"9b6b75f1526c1e83","type":"change","z":"a807a4834abd67fa","name":"","rules":[{"t":"set","p":"entities","pt":"msg","to":"(\t    $append(entities, payload)\t)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":4180,"y":840,"wires":[["25f72f80fc63468b"]]},{"id":"691a7ee6eb2c2047","type":"change","z":"a807a4834abd67fa","name":"","rules":[{"t":"set","p":"entities","pt":"msg","to":"(\t    $append(entities, payload)\t)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":4080,"y":1920,"wires":[["cc0610baf2dc75b3"]]},{"id":"9a5314a4b829d180","type":"change","z":"a807a4834abd67fa","name":"","rules":[{"t":"set","p":"payload.domain","pt":"msg","to":"cover","tot":"str"},{"t":"set","p":"payload.service","pt":"msg","to":"close_cover","tot":"str"},{"t":"set","p":"payload.data","pt":"msg","to":"{\t   \"entity_id\": payload.entity_id\t}","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":3640,"y":2080,"wires":[["76ae1bd97c2767f7"]]},{"id":"1e7305f8052440cd","type":"split","z":"a807a4834abd67fa","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":3510,"y":2080,"wires":[["9a5314a4b829d180"]]},{"id":"06061a14149e4abd","type":"change","z":"a807a4834abd67fa","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"(\t    $append(entities, payload)\t)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":4090,"y":2080,"wires":[["bbed260afb0f59cb"]]},{"id":"76ae1bd97c2767f7","type":"join","z":"a807a4834abd67fa","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":3770,"y":2080,"wires":[["06061a14149e4abd"]]},{"id":"98d5fed475708b38","type":"ha-get-entities","z":"a807a4834abd67fa","name":"get blinds","server":"79544c2b.6ccc64","version":1,"rules":[{"condition":"state_object","property":"entity_id","logic":"is","value":".*blinds.*","valueType":"re"},{"condition":"state_object","property":"entity_id","logic":"is","value":"cover\\..*","valueType":"re"}],"outputType":"array","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"payload","outputResultsCount":1,"x":3360,"y":2080,"wires":[["1e7305f8052440cd"]]},{"id":"f8ae1a047dc31b05","type":"change","z":"a807a4834abd67fa","name":"","rules":[{"t":"set","p":"entities","pt":"msg","to":"(\t    $append(entities, payload)\t)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":4080,"y":2000,"wires":[["98d5fed475708b38"]]},{"id":"1c8f57758fd2a09c","type":"api-current-state","z":"a807a4834abd67fa","name":"guest mode?","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.guest_mode","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":4490,"y":920,"wires":[["b2b315489cc8d2a7"],["bbed260afb0f59cb"]]},{"id":"b2b315489cc8d2a7","type":"function","z":"a807a4834abd67fa","name":"guest daytime","func":"// src/chronos/guest-daytime.ts\nvar entities = msg.payload;\nvar filteredEntities = entities.filter((entity) => {\n    const floor = entity.floor || [];\n    const areaId = entity.area_id;\n    return floor.includes(\"downstairs\") || areaId === \"master_bedroom\" || areaId === \"master_bathroom\" || areaId === \"bonus_room\";\n});\nmsg.payload = filteredEntities;\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":4720,"y":920,"wires":[["bbed260afb0f59cb"]]},{"id":"d9c19fe75da7c51f","type":"inject","z":"a807a4834abd67fa","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"10","topic":"","payload":"","payloadType":"date","x":3140,"y":920,"wires":[["25f72f80fc63468b"]]},{"id":"c29d7f40fa86f452","type":"server-state-changed","z":"a807a4834abd67fa","name":"","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["scene.nighttime"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":630,"y":2100,"wires":[["d9e5cde88d603392","3a4654996d83108b"]]},{"id":"d9e5cde88d603392","type":"api-current-state","z":"a807a4834abd67fa","name":"","server":"79544c2b.6ccc64","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_datetime.plants_global_schedule_end","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1180,"y":2100,"wires":[["c7094f4cb3601b75"]]},{"id":"d22ac4c1c222afd5","type":"function","z":"a807a4834abd67fa","name":"cache schedule entity","func":"// src/plants/cache-schedule-entity.ts\nvar weekdaySleepEntityId = \"input_datetime.weekday_sleep\";\nvar weekendSleepEntityId = \"input_datetime.weekend_sleep\";\nvar weekdayWakeEntityId = \"input_datetime.weekday_wakeup\";\nvar weekendWakeEntityId = \"input_datetime.weekend_wakeup\";\nvar sleepEntityId = \"sensor.sleep_time\";\nvar wakeupEntityId = \"sensor.wakeup_time\";\nvar now = /* @__PURE__ */ new Date();\nvar isWeekend = now.getDay() === 0 || now.getDay() === 6;\nvar cachedTimes = flow.get(\"cachedTimes\");\nif (cachedTimes == null) {\n    flow.set(\"cachedTimes\", {});\n    cachedTimes = flow.get(\"cachedTimes\");\n    node.status({ fill: \"blue\", shape: \"ring\", text: \"Cache init\" });\n}\nvar payload = msg.payload;\nvar dayStatus = msg.day_status;\nvar entityId = msg.data.entity_id;\nnode.status({ fill: \"blue\", shape: \"dot\", text: entityId });\nvar shouldSkip = (\n    // @ts-ignore\n    msg?.should_skip || dayStatus === \"night\" && entityId === sleepEntityId || dayStatus === \"day\" && entityId === wakeupEntityId\n);\nif (shouldSkip) {\n    msg.time_string = null;\n    msg.payload = null;\n    node.status({ fill: \"yellow\", shape: \"ring\", text: `Skip: ${entityId}` });\n} else {\n    if (entityId === sleepEntityId) {\n        entityId = isWeekend ? weekendSleepEntityId : weekdaySleepEntityId;\n    } else if (entityId === wakeupEntityId) {\n        entityId = isWeekend ? weekendWakeEntityId : weekdayWakeEntityId;\n    }\n    if (cachedTimes[entityId] == null) {\n        cachedTimes[entityId] = payload;\n    }\n    const timeString = now.getHours() + \":\" + now.getMinutes();\n    msg.time_string = timeString;\n    msg.payload = entityId;\n    node.status({\n        fill: \"green\",\n        shape: \"dot\",\n        text: `${entityId.split(\".\")[1]} (${timeString})`\n    });\n}\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1960,"y":2040,"wires":[["bbb991d033e03d82"]]},{"id":"e128a9e9b5d11eca","type":"api-call-service","z":"a807a4834abd67fa","name":"","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"input_datetime.set_datetime","floorId":[],"areaId":[],"deviceId":[],"entityId":["{{payload.entity_id}}"],"labelId":[],"data":"{\t    \"time\": payload.time\t}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":false,"domain":"input_datetime","service":"set_datetime","x":1440,"y":2500,"wires":[[]]},{"id":"bbb991d033e03d82","type":"api-call-service","z":"a807a4834abd67fa","name":"","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"input_datetime.set_datetime","floorId":[],"areaId":[],"deviceId":[],"entityId":["{{payload}}"],"labelId":[],"data":"{\t    \"time\": time_string\t}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":false,"domain":"input_datetime","service":"set_datetime","x":2260,"y":2040,"wires":[[]]},{"id":"a1094a433f301cdb","type":"inject","z":"a807a4834abd67fa","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"0","topic":"","payload":"","payloadType":"date","x":580,"y":2420,"wires":[["3a4654996d83108b","d9e5cde88d603392"]]},{"id":"3a4654996d83108b","type":"api-current-state","z":"a807a4834abd67fa","name":"","server":"79544c2b.6ccc64","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"sensor.sleep_time","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1090,"y":2040,"wires":[["c7094f4cb3601b75"]]},{"id":"6bc7f26c9c624e6c","type":"function","z":"a807a4834abd67fa","name":"pop schedule entity cache","func":"\"use strict\";\nlet cachedTimes = flow.get(\"cachedTimes\");\nif (cachedTimes == null) {\n    flow.set(\"cachedTimes\", {});\n    cachedTimes = flow.get(\"cachedTimes\");\n}\nconst times = Object.entries(cachedTimes).map(([entity_id, time]) => ({\n    entity_id,\n    time\n}));\n\nflow.set(\"cachedTimes\", {});\n\nmsg.payload = times;\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1000,"y":2500,"wires":[["dceb3b1ca55735a3"]]},{"id":"dceb3b1ca55735a3","type":"split","z":"a807a4834abd67fa","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1210,"y":2500,"wires":[[]]},{"id":"50e83f572d6f77d8","type":"inject","z":"a807a4834abd67fa","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"0","topic":"","payload":"","payloadType":"date","x":580,"y":2500,"wires":[["6bc7f26c9c624e6c"]]},{"id":"063b733bdb8f4891","type":"chronos-scheduler","z":"a807a4834abd67fa","name":"","config":"0f0bd6e74f18a17d","schedule":[{"trigger":{"type":"time","value":"12:00","offset":0,"random":false},"output":{"type":"msg","property":{"name":"payload","type":"str","value":""}}}],"disabled":false,"multiPort":false,"nextEventPort":false,"delayOnStart":true,"onStartDelay":"","outputs":1,"x":560,"y":2640,"wires":[["6bc7f26c9c624e6c"]]},{"id":"9182ef1b9f81c9be","type":"server-state-changed","z":"a807a4834abd67fa","name":"","server":"79544c2b.6ccc64","version":6,"outputs":2,"exposeAsEntityConfig":"","entities":{"entity":["input_select.day_status"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"night","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":650,"y":2040,"wires":[["3a4654996d83108b","d9e5cde88d603392"],[]]},{"id":"e90451d3ad897a9e","type":"server-state-changed","z":"a807a4834abd67fa","name":"","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["scene.daytime_2"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":630,"y":2300,"wires":[[]]},{"id":"398cc700eb51fc16","type":"api-current-state","z":"a807a4834abd67fa","name":"","server":"79544c2b.6ccc64","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"sensor.wakeup_time","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1090,"y":2240,"wires":[["c7094f4cb3601b75"]]},{"id":"0b38572c59895a8f","type":"server-state-changed","z":"a807a4834abd67fa","name":"","server":"79544c2b.6ccc64","version":6,"outputs":2,"exposeAsEntityConfig":"","entities":{"entity":["input_select.day_status"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"day","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":650,"y":2240,"wires":[["398cc700eb51fc16"],[]]},{"id":"8fc659ceb8fc9583","type":"api-current-state","z":"a807a4834abd67fa","name":"","server":"79544c2b.6ccc64","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_datetime.plants_global_schedule_start","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1180,"y":2300,"wires":[["c7094f4cb3601b75"]]},{"id":"2017325256318b95","type":"server-state-changed","z":"a807a4834abd67fa","name":"","server":"79544c2b.6ccc64","version":6,"outputs":2,"exposeAsEntityConfig":"","entities":{"entity":["input_select.day_status"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"day","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":650,"y":2560,"wires":[["6bc7f26c9c624e6c"],[]]},{"id":"c7094f4cb3601b75","type":"api-current-state","z":"a807a4834abd67fa","name":"","server":"79544c2b.6ccc64","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_select.day_status","state_type":"str","blockInputOverrides":true,"outputProperties":[{"property":"day_status","propertyType":"msg","value":"","valueType":"entityState"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1650,"y":2040,"wires":[["d22ac4c1c222afd5"]]},{"id":"ba379b6e6709e51a","type":"server-state-changed","z":"a807a4834abd67fa","name":"","server":"79544c2b.6ccc64","version":6,"outputs":2,"exposeAsEntityConfig":"","entities":{"entity":["input_select.awake_status"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"asleep","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"15","forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":660,"y":2820,"wires":[["9e8729ff4bb7b4b5","6c4c7b56b38ed216"],[]]},{"id":"9aa9f1a369a4d799","type":"api-call-service","z":"a807a4834abd67fa","name":"","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"cover.close_cover","floorId":[],"areaId":[],"deviceId":[],"entityId":["cover.ratgdov25i_4b1c3b_door"],"labelId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":true,"domain":"cover","service":"close_cover","x":1130,"y":2740,"wires":[[]]},{"id":"6c4c7b56b38ed216","type":"api-call-service","z":"a807a4834abd67fa","name":"","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"lock.lock","floorId":[],"areaId":[],"deviceId":[],"entityId":["lock.back_door","lock.front_door","lock.garage_entry_door"],"labelId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":true,"domain":"lock","service":"lock","x":920,"y":2820,"wires":[[]]},{"id":"9e8729ff4bb7b4b5","type":"api-current-state","z":"a807a4834abd67fa","name":"obstructed?","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.ratgdov25i_4b1c3b_obstruction","state_type":"str","blockInputOverrides":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":930,"y":2740,"wires":[["9aa9f1a369a4d799"],[]]},{"id":"29d109fb3bd0fa2d","type":"ha-get-entities","z":"88965fe6e95d05d9","name":"get devices","server":"79544c2b.6ccc64","version":1,"rules":[{"property":"entity_id","logic":"is","value":"(climate)\\..*","valueType":"re"}],"outputType":"array","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"payload","outputResultsCount":1,"x":1590,"y":160,"wires":[[]]},{"id":"8f4c1ad0cad49211","type":"function","z":"88965fe6e95d05d9","name":"function","func":"const PRECOOL_TIME = 2 * 60 * 60 * 1000;\nconst NOW = new Date();\nconst monthDayToDate = (monthDay) => {\n    return new Date(`${monthDay}, ${NOW.getFullYear()}`);\n};\nconst hourToDate = (hour) => {\n    return new Date(`Jan 1 ${hour}, ${NOW.getFullYear()}`);\n};\nconst inRange = (date, start, end) => {\n    return date >= start && date <= end;\n};\nclass DateInterval {\n    constructor(start, end) {\n        this.start = monthDayToDate(start);\n        this.end = monthDayToDate(end);\n        if (this.end.getTime() < this.start.getTime()) {\n            this.end.setFullYear(this.end.getFullYear() + 1);\n        }\n    }\n}\nclass ElectricInterval {\n    constructor(start, end, charge) {\n        this.start = hourToDate(start);\n        this.end = hourToDate(end);\n        this.charge = charge;\n    }\n    normalize(date) {\n        const month = date.getMonth();\n        const day = date.getDate();\n        this.start.setMonth(month, day);\n        this.end.setMonth(month, day);\n        if (this.end.getTime() < this.start.getTime()) {\n            if (this.start.getTime() <= date.getTime()) {\n                this.end.setDate(day + 1);\n            }\n            else {\n                this.start.setDate(day - 1);\n            }\n        }\n    }\n    inRange(date) {\n        this.normalize(date);\n        return inRange(date, this.start, this.end);\n    }\n    secondsUntilEnd(date) {\n        this.normalize(date);\n        return (this.end.getTime() - date.getTime()) / 1000;\n    }\n}\nclass Schedule {\n    constructor({ name, dates, on, off, precoolTemp }) {\n        this.name = name;\n        this.dates = dates;\n        this.on = on;\n        this.off = off;\n        this.precoolTemp = precoolTemp;\n    }\n    findDateInInterval(date) {\n        const pred = (v) => v.inRange(date);\n        const inDateRange = inRange(date, this.dates.start, this.dates.end);\n        if (inDateRange) {\n            let ix = this.off.findIndex(pred);\n            if (ix !== -1) {\n                const interval = this.off[ix];\n                return { status: false, interval };\n            }\n            ix = this.on.findIndex(pred);\n            if (ix !== -1) {\n                const interval = this.on[ix];\n                return { status: true, interval };\n            }\n        }\n        return undefined;\n    }\n}\nconst findDateInSchedules = (date, schedules) => {\n    schedules = schedules instanceof Array ? schedules : [schedules];\n    for (const schedule of schedules) {\n        const status = schedule.findDateInInterval(date);\n        if (status !== undefined) {\n            return {\n                schedule,\n                status,\n            };\n        }\n    }\n    return undefined;\n};\nconst createPrecoolPayload = (schedule, status, nextIsOn, delay) => {\n    const precool = !status && delay <= PRECOOL_TIME && nextIsOn;\n    const precoolTemp = precool ? schedule.precoolTemp : undefined;\n    return {\n        precool,\n        precoolTemp,\n    };\n};\nconst createPayload = (date, schedules) => {\n    const pack = (arr) => {\n        return arr.map((x) => String(Number(x))).join(\"\");\n    };\n    const { schedule, status } = findDateInSchedules(date, schedules);\n    const delay = status.interval.secondsUntilEnd(date) * 1000;\n    date.setTime(status.interval.end.getTime() + 1);\n    const nextTimestamp = date.getTime();\n    const { status: nextStatus } = findDateInSchedules(date, schedule);\n    const nextIsOn = nextStatus.status;\n    const { precool, precoolTemp } = createPrecoolPayload(schedule, status.status, nextIsOn, delay);\n    const action = pack([status.status, precool]);\n    const payload = {\n        status: status.status,\n        nextTimestamp,\n        delay,\n        action,\n        precoolTemp,\n    };\n    return payload;\n};\nconst summer = new Schedule({\n    name: \"summer\",\n    dates: new DateInterval(\"May 1\", \"Oct 31\"),\n    on: [new ElectricInterval(\"5:00 PM\", \"7:00 PM\", 0.4)],\n    off: [\n        new ElectricInterval(\"6:00 AM\", \"5:00 PM\", 0.08),\n        new ElectricInterval(\"7:00 PM\", \"10:00 PM\", 0.08),\n        new ElectricInterval(\"10:00 PM\", \"6:00 AM\", 0.05),\n    ],\n    precoolTemp: 21,\n});\nconst winter = new Schedule({\n    name: \"winter\",\n    dates: new DateInterval(\"Nov 1\", \"April 30\"),\n    on: [new ElectricInterval(\"6:00 AM\", \"8:00 AM\", 0.4)],\n    off: [\n        new ElectricInterval(\"8:00 AM\", \"10:00 PM\", 0.08),\n        new ElectricInterval(\"10:00 PM\", \"6:00 AM\", 0.05),\n    ],\n    precoolTemp: 20,\n});\nconst schedules = [summer, winter];\n//@ts-ignore\nconst message = msg;\nconst date = new Date(message.timestamp);\nmessage.payload = createPayload(date, schedules);\n//@ts-ignore\nreturn message;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":700,"y":320,"wires":[["5599af983679917e","a3e1d5e974ef2f9e"]]},{"id":"7e32d3ee149a5bcf","type":"split","z":"88965fe6e95d05d9","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":2330,"y":480,"wires":[["82095936896de520"]]},{"id":"82095936896de520","type":"api-call-service","z":"88965fe6e95d05d9","name":"","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"climate.set_temperature","floorId":[],"areaId":[],"deviceId":[],"entityId":["{{payload.entity_id}}"],"labelId":[],"data":"{    \"target_temp_high\": 21,    \"target_temp_low\": 21}","dataType":"jsonata","mergeContext":"","mustacheAltTags":true,"outputProperties":[],"queue":"none","blockInputOverrides":false,"domain":"climate","service":"set_temperature","x":2490,"y":480,"wires":[["47923c89f24581f9"]]},{"id":"27b72db16ecd895d","type":"ha-get-entities","z":"88965fe6e95d05d9","name":"get devices","server":"79544c2b.6ccc64","version":1,"rules":[{"property":"entity_id","logic":"is","value":"(climate)\\..*","valueType":"re"}],"outputType":"array","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"payload","outputResultsCount":1,"x":1590,"y":480,"wires":[[]]},{"id":"d43c8739497083c1","type":"change","z":"88965fe6e95d05d9","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"entities","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2200,"y":480,"wires":[["7e32d3ee149a5bcf"]]},{"id":"4a4171f8412b9df4","type":"change","z":"88965fe6e95d05d9","name":"get cached States","rules":[{"t":"set","p":"payload","pt":"msg","to":"cachedStates","tot":"flow"},{"t":"set","p":"precool","pt":"flow","to":"false","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":1610,"y":320,"wires":[["1aec35e03f0ae9c1"]]},{"id":"1aec35e03f0ae9c1","type":"split","z":"88965fe6e95d05d9","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1750,"y":320,"wires":[["fe9a03f0107ed842"]]},{"id":"fe9a03f0107ed842","type":"api-call-service","z":"88965fe6e95d05d9","name":"","server":"79544c2b.6ccc64","version":7,"debugenabled":true,"floorId":[],"areaId":[],"deviceId":[],"entityId":[],"labelId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":false,"domain":"","service":"","x":1870,"y":320,"wires":[["a20e7b3f6c9d57ca"]]},{"id":"9e88a065df8e3796","type":"split","z":"88965fe6e95d05d9","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":2330,"y":160,"wires":[["5b639a893df11ddc"]]},{"id":"5b639a893df11ddc","type":"api-call-service","z":"88965fe6e95d05d9","name":"","server":"79544c2b.6ccc64","version":7,"debugenabled":true,"floorId":[],"areaId":[],"deviceId":[],"entityId":[],"labelId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":false,"domain":"","service":"","x":2450,"y":160,"wires":[["47923c89f24581f9"]]},{"id":"2b8bc96ae475524e","type":"state-machine","z":"88965fe6e95d05d9","name":"","triggerProperty":"payload.action","triggerPropertyType":"msg","stateProperty":"state","statePropertyType":"msg","initialDelay":"0","persistOnReload":false,"outputStateChangeOnly":true,"throwException":false,"states":["start","off","off - precool","on"],"transitions":[{"name":"00","from":"start","to":"off"},{"name":"01","from":"start","to":"off - precool"},{"name":"10","from":"start","to":"on"},{"name":"01","from":"off","to":"off - precool"},{"name":"00","from":"off - precool","to":"off"},{"name":"10","from":"off - precool","to":"on"},{"name":"00","from":"on","to":"off"},{"name":"01","from":"on","to":"off - precool"},{"name":"10","from":"off","to":"on"}],"x":1160,"y":320,"wires":[["80e32670d669551d"]]},{"id":"5599af983679917e","type":"debug","z":"88965fe6e95d05d9","name":"debug 7","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":840,"y":480,"wires":[]},{"id":"80e32670d669551d","type":"switch","z":"88965fe6e95d05d9","name":"","property":"state","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"},{"t":"eq","v":"off","vt":"str"},{"t":"eq","v":"off - precool","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":1370,"y":320,"wires":[["29d109fb3bd0fa2d"],["4a4171f8412b9df4"],["804bec7b259619c8"]]},{"id":"09aa544b07d56c88","type":"change","z":"88965fe6e95d05d9","name":"set cache","rules":[{"t":"set","p":"cachedStates","pt":"flow","to":"cachedStates","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2100,"y":320,"wires":[["47923c89f24581f9"]]},{"id":"47923c89f24581f9","type":"change","z":"88965fe6e95d05d9","name":"","rules":[{"t":"set","p":"prevState","pt":"flow","to":"state","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2630,"y":320,"wires":[[]]},{"id":"7588d2d0b659a868","type":"switch","z":"88965fe6e95d05d9","name":"precool?","property":"prevState","propertyType":"flow","rules":[{"t":"eq","v":"off - precool","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1920,"y":220,"wires":[[],["09aa544b07d56c88"]]},{"id":"a20e7b3f6c9d57ca","type":"change","z":"88965fe6e95d05d9","name":"clear cache","rules":[{"t":"set","p":"cachedStates","pt":"flow","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2110,"y":380,"wires":[[]]},{"id":"4f01f533bdf30b2e","type":"change","z":"88965fe6e95d05d9","name":"set precool temp","rules":[{"t":"set","p":"precoolTemp","pt":"msg","to":"payload.precoolTemp","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1430,"y":480,"wires":[["27b72db16ecd895d"]]},{"id":"832c67c9b37d2552","type":"debug","z":"88965fe6e95d05d9","name":"debug 8","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1960,"y":560,"wires":[]},{"id":"565ce11da2ae2e1a","type":"debug","z":"88965fe6e95d05d9","name":"debug 9","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1920,"y":100,"wires":[]},{"id":"0065245d4829dfbc","type":"change","z":"88965fe6e95d05d9","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2200,"y":540,"wires":[["5821f310b86ba3e1"]]},{"id":"804bec7b259619c8","type":"api-current-state","z":"88965fe6e95d05d9","name":"away?","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.home_away","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1270,"y":480,"wires":[[],["4f01f533bdf30b2e"]]},{"id":"5821f310b86ba3e1","type":"api-call-service","z":"88965fe6e95d05d9","name":"","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"notify.mobile_app_fff","floorId":[],"areaId":[],"deviceId":[],"entityId":[],"labelId":[],"data":"{\"message\":\"Precooling house!\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","blockInputOverrides":false,"domain":"notify","service":"mobile_app_fff","x":2700,"y":540,"wires":[[]]},{"id":"7fe5249d26bd9cf6","type":"delay","z":"88965fe6e95d05d9","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"allowrate":false,"outputs":1,"x":530,"y":320,"wires":[["8f4c1ad0cad49211"]]},{"id":"a3e1d5e974ef2f9e","type":"change","z":"88965fe6e95d05d9","name":"","rules":[{"t":"set","p":"delay","pt":"msg","to":"payload.delay","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":840,"y":320,"wires":[[]]},{"id":"e343273777364775","type":"ha-get-entities","z":"e921812388e8a474","name":"get grow lights","server":"79544c2b.6ccc64","version":1,"rules":[{"condition":"state_object","property":"entity_id","logic":"is","value":"(switch|light)\\.(.*grow.*)","valueType":"re"}],"outputType":"array","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"payload","outputResultsCount":1,"x":1380,"y":540,"wires":[["8baf517e98f7f1a1"]]},{"id":"0586f7809d493ecd","type":"inject","z":"e921812388e8a474","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"60","crontab":"","once":false,"onceDelay":"0","topic":"","payload":"","payloadType":"date","x":270,"y":540,"wires":[["9ab36e40ecfb8ab5"]]},{"id":"930c98a0c6018ddd","type":"ha-get-entities","z":"e921812388e8a474","name":"get schedule entities","server":"79544c2b.6ccc64","version":1,"rules":[{"condition":"state_object","property":"entity_id","logic":"includes","value":"[\t   \"input_datetime.plants_global_schedule_start\",\t   \"input_datetime.plants_global_schedule_end\",\t   \"sensor.bedroom_plants_schedule_start\",\t   \"sensor.bedroom_plants_schedule_end\"\t]","valueType":"jsonata"}],"outputType":"array","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"schedule_entities","outputResultsCount":1,"x":1040,"y":540,"wires":[["e343273777364775","1229c1c9727b2e45"]]},{"id":"6be3b9b34426c428","type":"server-state-changed","z":"e921812388e8a474","name":"","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":[],"substring":[],"regex":["input_datetime\\.(plants_global_schedule_.*)"]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is_not","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":400,"y":440,"wires":[["9ab36e40ecfb8ab5"]]},{"id":"7445c17272b0e29f","type":"server-state-changed","z":"e921812388e8a474","name":"","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["sensor.sleep_time"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is_not","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":320,"y":380,"wires":[["9ab36e40ecfb8ab5"]]},{"id":"04f8709ebd6588c0","type":"function","z":"e921812388e8a474","name":"set static state","func":"let staticPlantStates = flow.get(\"staticPlantStates\");\n\nif (staticPlantStates == null) {\n    flow.set(\"staticPlantStates\", {});\n    staticPlantStates = flow.get(\"staticPlantStates\");\n}\n\nconst payload = msg.payload;\n\nstaticPlantStates[payload.entity_id] = payload.state;\n\nmsg.staticPlantStates = staticPlantStates;\n\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1660,"y":740,"wires":[[]]},{"id":"cb403dfea00a765a","type":"change","z":"e921812388e8a474","name":"clear static plant states","rules":[{"t":"set","p":"payload","pt":"msg","to":"staticPlantStates","tot":"flow","dc":true},{"t":"set","p":"staticPlantStates","pt":"flow","to":"{}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":1370,"y":1160,"wires":[["669077227af50c35"]]},{"id":"7f2e888fef955d9b","type":"api-current-state","z":"e921812388e8a474","name":"get current state","server":"79544c2b.6ccc64","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"{{payload.entity_id}}","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":500,"y":740,"wires":[["bbeabf5e13fa3d11"]]},{"id":"62997068e300d11d","type":"switch","z":"e921812388e8a474","name":"set by me?","property":"payload.context.user_id","propertyType":"msg","rules":[{"t":"eq","v":"37ad8b6092fd4b34a702e536f2802ce0","vt":"str"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":1210,"y":740,"wires":[["5e7694a974a66cd0"],["5e7694a974a66cd0"]]},{"id":"259a4cbfd56ca52a","type":"inject","z":"e921812388e8a474","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"0","topic":"","payload":"","payloadType":"date","x":260,"y":1160,"wires":[["cb403dfea00a765a"]]},{"id":"9ab36e40ecfb8ab5","type":"debounce-advanced","z":"e921812388e8a474","time":"15","timeunit":"s","debouncetype":"trailing","name":"","x":750,"y":540,"wires":[["2f73425d194d82fa"]]},{"id":"55cc6da07fad2d5e","type":"server-state-changed","z":"e921812388e8a474","name":"","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["sensor.wakeup_time"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is_not","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":320,"y":320,"wires":[["9ab36e40ecfb8ab5"]]},{"id":"819bbcfc0b6c7f77","type":"server-state-changed","z":"e921812388e8a474","name":"","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["input_datetime.plants_global_schedule_end"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"}],"x":400,"y":1280,"wires":[["23209358b1d69537"]]},{"id":"23209358b1d69537","type":"api-current-state","z":"e921812388e8a474","name":"get current state","server":"79544c2b.6ccc64","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"{{payload.entity_id}}","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":780,"y":1280,"wires":[["c89f5d63aa0c97ec"]]},{"id":"c89f5d63aa0c97ec","type":"switch","z":"e921812388e8a474","name":"set by me?","property":"data.context.user_id","propertyType":"msg","rules":[{"t":"eq","v":"37ad8b6092fd4b34a702e536f2802ce0","vt":"str"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":930,"y":1280,"wires":[["5ba4be7bf6c67b18","a9e2849052153cc1"],["5ba4be7bf6c67b18","a9e2849052153cc1"]]},{"id":"8baf517e98f7f1a1","type":"function","z":"e921812388e8a474","name":"schedule","func":"\"use strict\";\nfunction getEntityBasename(entityId) {\n    const match = entityId.match(/^.*\\.(.*)$/);\n    return match ? match[1] : entityId;\n}\nfunction getTimeComponents(time) {\n    let timeParts = time.split(\":\");\n    let [hours, mins, seconds] = timeParts.concat(Array(3 - timeParts.length).fill(\"00\")).map((x) => parseInt(x));\n    return [hours, mins, seconds];\n}\nfunction normalizeTime(time) {\n    let [hours, mins, seconds] = getTimeComponents(time);\n    return `${hours}:${mins}:${seconds}`;\n}\nfunction timeStringToDate(time) {\n    time = normalizeTime(time);\n    let [hours, mins, seconds] = getTimeComponents(time);\n    let date = /* @__PURE__ */ new Date();\n    date.setHours(hours);\n    date.setMinutes(mins);\n    date.setSeconds(seconds);\n    return date;\n}\nfunction compareTime(time1, time2, withDay = false) {\n    let t1 = time1.getHours() * 3600 + time1.getMinutes() * 60 + time1.getSeconds();\n    let t2 = time2.getHours() * 3600 + time2.getMinutes() * 60 + time2.getSeconds();\n    if (withDay) {\n        t1 += time1.getDate() * 86400;\n        t2 += time2.getDate() * 86400;\n    }\n    return t1 === t2 ? 0 : t1 > t2 ? 1 : -1;\n}\nfunction isTimeInRange(current, start, end) {\n    return compareTime(current, start, true) >= 0 && compareTime(current, end, true) <= 0;\n}\nconst serviceToActionCall = (call) => {\n    if ((call == null ? void 0 : call.action) != null) {\n        return call;\n    }\n    const serviceCall = call;\n    const out = {\n        ...serviceCall,\n        action: `${serviceCall.domain}.${serviceCall.service}`,\n        target: {\n            entity_id: serviceCall.data.entity_id\n        }\n    };\n    delete out.domain;\n    delete out.service;\n    return out;\n};\nconst groupActions = (actions) => {\n    const grouped = actions.reduce((acc, cur) => {\n        const { action, data, target } = cur;\n        const dataCopy = { ...data };\n        delete dataCopy.entity_id;\n        const key = `${action}-${JSON.stringify(dataCopy)}`;\n        if (!acc[key]) {\n            acc[key] = {\n                action,\n                data: dataCopy,\n                target: {\n                    entity_id: /* @__PURE__ */ new Set([target.entity_id])\n                }\n            };\n        } else {\n            acc[key].target.entity_id.add(target.entity_id);\n        }\n        return acc;\n    }, {});\n    return Object.values(grouped).map((x) => {\n        x.target.entity_id = Array.from(x.target.entity_id);\n        return x;\n    });\n};\nconst createStatesObject = (states, basename = false) => {\n    return states.reduce((acc, state) => {\n        if ((state == null ? void 0 : state.entity_id) != void 0) {\n            const name = basename ? getEntityBasename(state.entity_id) : state.entity_id;\n            acc[name] = state;\n        }\n        return acc;\n    }, {});\n};\nfunction determineEntityStatus(entity, now2, msg2, schedules2, staticPlantStates2) {\n    if (staticPlantStates2[entity.entity_id] != null) {\n        return null;\n    }\n    const matchingSchedules = schedules2.filter(\n        (schedule) => schedule.entities.some((pattern) => pattern.test(entity.entity_id))\n    );\n    if (matchingSchedules.length === 0) {\n        return null;\n    }\n    const matchingSchedule = matchingSchedules[0];\n    return {\n        state: isTimeInRange(now2, matchingSchedule.start, matchingSchedule.end) ? \"on\" : \"off\",\n        schedule: matchingSchedule\n    };\n}\nconst schedules = flow.get(\"schedules\") ?? [];\nconst staticPlantStates = flow.get(\"staticPlantStates\") ?? {};\nconst message = msg;\nconst now = /* @__PURE__ */ new Date();\nconst entities = (Array.isArray(message.payload) ? message.payload : [message.payload]).filter((entity) => (entity == null ? void 0 : entity.entity_id) && entity.state !== \"unavailable\");\nconst scheduleEntities = createStatesObject(msg.schedule_entities, true);\nconst normalizedSchedules = schedules.map((schedule) => {\n    const { name, entities: entities2, start, end, precedence } = schedule;\n    const startOverride = scheduleEntities == null ? void 0 : scheduleEntities[`${name}_schedule_start`];\n    const endOverride = scheduleEntities == null ? void 0 : scheduleEntities[`${name}_schedule_end`];\n    const startTimeString = startOverride ? startOverride.state : start;\n    const endTimeString = endOverride ? endOverride.state : end;\n    const startTime = timeStringToDate(startTimeString);\n    const endTime = timeStringToDate(endTimeString);\n    startTime.setDate(now.getDate());\n    endTime.setDate(now.getDate());\n    if (compareTime(startTime, endTime) >= 0) {\n        if (compareTime(now, endTime) < 1) {\n            startTime.setDate(startTime.getDate() - 1);\n        } else {\n            endTime.setDate(endTime.getDate() + 1);\n        }\n    } else if (compareTime(now, endTime) > 1) {\n        startTime.setDate(startTime.getDate() + 1);\n    }\n    return {\n        name,\n        entities: entities2.map((entity) => new RegExp(entity)),\n        start: startTime,\n        end: endTime,\n        startTime: startTime.toLocaleDateString(\"en-US\", {\n            hour: \"2-digit\",\n            minute: \"2-digit\",\n            hour12: false\n        }),\n        endTime: endTime.toLocaleDateString(\"en-US\", {\n            hour: \"2-digit\",\n            minute: \"2-digit\",\n            hour12: false\n        }),\n        precedence\n    };\n}).sort((a, b) => b.precedence - a.precedence);\nconst serviceActions = entities.map((entity) => {\n    const status = determineEntityStatus(\n        entity,\n        now,\n        message,\n        normalizedSchedules,\n        staticPlantStates\n    );\n    if (status === null || entity.state === status.state) return null;\n    return {\n        domain: \"homeassistant\",\n        service: `turn_${status.state}`,\n        data: { entity_id: entity.entity_id }\n    };\n}).filter(Boolean).map(serviceToActionCall);\nmsg.payload = groupActions(serviceActions);\nmsg.actions = serviceActions;\nmsg.normalizedSchedules = normalizedSchedules;\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1580,"y":540,"wires":[["1190837e30334ab6"]]},{"id":"1190837e30334ab6","type":"split","z":"e921812388e8a474","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","property":"payload","x":1770,"y":540,"wires":[["f448608c2d25da0e"]]},{"id":"08e95645f23e1721","type":"server-state-changed","z":"e921812388e8a474","name":"grow lights changed?","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":[],"substring":[],"regex":["(switch|light)\\.(.*grow.*)"]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"}],"x":280,"y":740,"wires":[["7f2e888fef955d9b"]]},{"id":"977e5b55c8f5bbc6","type":"subflow:e920ad5e223ac1b7","z":"e921812388e8a474","name":"","x":700,"y":840,"wires":[["3cbb13d1da946813"]]},{"id":"3cbb13d1da946813","type":"function","z":"e921812388e8a474","name":"filter blacklisted entities","func":"\"use strict\";\nconst normalizeIncludes = (s1, s2) => {\n    return s1.toLowerCase().includes(s2.toLowerCase());\n};\nconst isBlacklisted = (entity_id, blacklisted) => {\n    return blacklisted.some((blacklistItem) => {\n        if (typeof blacklistItem === \"string\") {\n            return normalizeIncludes(entity_id, blacklistItem);\n        } else {\n            return blacklistItem.test(entity_id);\n        }\n    });\n};\nconst blacklistedEntities = [\n    // car\n    \"son_of_toast\",\n    // blinds\n    /.*blinds.*/i,\n    // air purifiers\n    /.*air_purifier.*/i,\n    // garage door\n    /switch.ratgdov25i_4b1c3b.*/i,\n    \"lock.ratgdov25i_4b1c3b_lock_remotes\",\n    // sonos\n    /.*sonos_beam.*/i,\n    // washer/dryer\n    \"washer_power\",\n    \"dryer_power\",\n    // water pump\n    \"switch.plant_water_pump_switch\",\n    // ESPresnce:\n    /espresense_.*/i\n];\nconst message = msg;\nconst blacklist = msg.blacklist ?? blacklistedEntities;\nconst entities = message.payload.filter((e) => {\n    const { entity_id, state } = e;\n    const whitelisted = !isBlacklisted(entity_id, blacklist);\n    return whitelisted && state !== \"unavailable\";\n});\nmsg.payload = entities;\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":910,"y":840,"wires":[["f96d89b194d73357"]]},{"id":"4841cf48c35bb836","type":"change","z":"e921812388e8a474","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"[\"light\",\"switch\",\"fan\",\"cover\"]","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":520,"y":840,"wires":[["977e5b55c8f5bbc6"]]},{"id":"f96d89b194d73357","type":"split","z":"e921812388e8a474","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1070,"y":840,"wires":[["62997068e300d11d"]]},{"id":"666a7e9d9edc91e9","type":"inject","z":"e921812388e8a474","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"0","topic":"","payload":"","payloadType":"date","x":260,"y":840,"wires":[["4841cf48c35bb836"]]},{"id":"bbeabf5e13fa3d11","type":"change","z":"e921812388e8a474","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"data","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":660,"y":740,"wires":[["62997068e300d11d"]]},{"id":"1229c1c9727b2e45","type":"ha-get-entities","z":"e921812388e8a474","name":"get grow lights","server":"79544c2b.6ccc64","version":1,"rules":[{"condition":"state_object","property":"entity_id","logic":"is","value":"light.penguin_light","valueType":"re"}],"outputType":"array","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"payload","outputResultsCount":1,"x":1380,"y":480,"wires":[["8baf517e98f7f1a1"]]},{"id":"63b01377bff19c49","type":"split","z":"e921812388e8a474","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1690,"y":1160,"wires":[["789ec62053dd3045"]]},{"id":"669077227af50c35","type":"change","z":"e921812388e8a474","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"$keys(msg.payload)","tot":"jsonata","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":1560,"y":1160,"wires":[["63b01377bff19c49"]]},{"id":"789ec62053dd3045","type":"subflow:bfb9a6c8a64bb052","z":"e921812388e8a474","name":"","x":1850,"y":1160,"wires":[[]]},{"id":"2f73425d194d82fa","type":"function","z":"e921812388e8a474","name":"schedules","func":"\"use strict\";\nconst schedules = [\n    {\n        name: \"plants_global\",\n        entities: [\"(switch|light)\\\\.(.*grow.*)\"],\n        start: \"06:00\",\n        end: \"23:00\",\n        precedence: 1\n    },\n    {\n        name: \"bedroom_plants\",\n        entities: [\"(switch|light)\\\\.(.*bedroom.*grow.*)\"],\n        start: \"09:00\",\n        end: \"23:00\",\n        precedence: 2\n    },\n    {\n        name: \"hey\",\n        entities: [\"light.penguin_light\"],\n        start: \"09:00\",\n        end: \"18:45\",\n        precedence: 3\n    }\n];\nflow.set(\"schedules\", schedules);\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":890,"y":420,"wires":[["930c98a0c6018ddd"]]},{"id":"03ec310213854f4d","type":"inject","z":"e921812388e8a474","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"0","topic":"","payload":"","payloadType":"date","x":880,"y":320,"wires":[["2f73425d194d82fa"]]},{"id":"97f7acddab5f19f1","type":"change","z":"e921812388e8a474","name":"get static plant states","rules":[{"t":"set","p":"payload","pt":"msg","to":"staticPlantStates","tot":"flow","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":540,"y":1000,"wires":[["c799ba4f0f651eb4"]]},{"id":"b3e2510deaaaf2b5","type":"inject","z":"e921812388e8a474","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"0","topic":"","payload":"","payloadType":"date","x":260,"y":1000,"wires":[["97f7acddab5f19f1"]]},{"id":"c799ba4f0f651eb4","type":"debug","z":"e921812388e8a474","name":"debug 3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":780,"y":1000,"wires":[]},{"id":"5d1718196b621774","type":"change","z":"e921812388e8a474","name":"get static plant states","rules":[{"t":"set","p":"payload","pt":"msg","to":"cachedTimes","tot":"flow","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":540,"y":1500,"wires":[["79484c62262d3ba9"]]},{"id":"f2bf8b1eb0ac4fb6","type":"inject","z":"e921812388e8a474","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"0","topic":"","payload":"","payloadType":"date","x":260,"y":1500,"wires":[["5d1718196b621774"]]},{"id":"79484c62262d3ba9","type":"debug","z":"e921812388e8a474","name":"debug 13","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":780,"y":1500,"wires":[]},{"id":"f448608c2d25da0e","type":"subflow:8021f5177f6126d9","z":"e921812388e8a474","name":"","x":2050,"y":540,"wires":[[]]},{"id":"b9fc6e9e2ba833fe","type":"api-call-service","z":"e921812388e8a474","name":"","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"homeassistant.toggle","floorId":[],"areaId":[],"deviceId":[],"entityId":["switch.master_bedroom_bird_of_paradise_grow_light_switch"],"labelId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":true,"domain":"homeassistant","service":"toggle","x":480,"y":640,"wires":[[]]},{"id":"02af285a0f760f15","type":"inject","z":"e921812388e8a474","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":"0","topic":"","payload":"","payloadType":"date","x":260,"y":640,"wires":[["b9fc6e9e2ba833fe"]]},{"id":"aeaed2222adc34ae","type":"server-state-changed","z":"e921812388e8a474","name":"daytime/home change?","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["input_select.day_status","scene.daytime_2","scene.nighttime","input_select.home_status"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":280,"y":1360,"wires":[["5ba4be7bf6c67b18","a9e2849052153cc1"]]},{"id":"5e7694a974a66cd0","type":"switch","z":"e921812388e8a474","name":"","property":"payload.state","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"},{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1430,"y":740,"wires":[["04f8709ebd6588c0"],["04f8709ebd6588c0"]]},{"id":"5ba4be7bf6c67b18","type":"debounce-advanced","z":"e921812388e8a474","time":"15","timeunit":"s","debouncetype":"trailing","name":"","x":1190,"y":1360,"wires":[["cb403dfea00a765a"]]},{"id":"a9e2849052153cc1","type":"debounce-advanced","z":"e921812388e8a474","time":"2","timeunit":"s","debouncetype":"trailing","name":"","x":1190,"y":1320,"wires":[["cb403dfea00a765a"]]},{"id":"31853e7a6d040d2b","type":"chronos-scheduler","z":"4b8fb0bd081363a3","name":"","config":"0f0bd6e74f18a17d","schedule":[{"trigger":{"type":"sun","value":"sunsetStart","offset":0,"random":false},"output":{"type":"msg","property":{"name":"payload","type":"bool","value":"true"}}}],"disabled":false,"multiPort":false,"nextEventPort":false,"delayOnStart":true,"onStartDelay":"","outputs":1,"x":160,"y":280,"wires":[["89fed415bb170597"]]},{"id":"89fed415bb170597","type":"ha-get-entities","z":"4b8fb0bd081363a3","name":"","server":"79544c2b.6ccc64","version":1,"rules":[{"property":"entity_id","logic":"is","value":".*blinds.*","valueType":"re","condition":"state_object"},{"property":"entity_id","logic":"is","value":"cover\\..*","valueType":"re","condition":"state_object"}],"outputType":"array","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"payload","outputResultsCount":1,"x":450,"y":280,"wires":[["2281cbd434841302"]]},{"id":"6734451dbbae0bd2","type":"api-call-service","z":"4b8fb0bd081363a3","name":"","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"cover.close_cover","floorId":[],"areaId":[],"deviceId":[],"entityId":["{{payload.entity_id}}"],"labelId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":false,"domain":"cover","service":"close_cover","x":810,"y":280,"wires":[[]]},{"id":"4a7b2ccaba187485","type":"inject","z":"4b8fb0bd081363a3","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":180,"y":180,"wires":[["89fed415bb170597"]]},{"id":"2281cbd434841302","type":"split","z":"4b8fb0bd081363a3","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":570,"y":280,"wires":[["6734451dbbae0bd2"]]},{"id":"3e3f40e154dc0d86","type":"api-call-service","z":"2c89cfc34655fd37","name":"","server":"79544c2b.6ccc64","version":7,"debugenabled":true,"action":"switch.turn_off","floorId":[],"areaId":[],"deviceId":[],"entityId":["{{payload}}"],"labelId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":false,"domain":"switch","service":"turn_off","x":820,"y":200,"wires":[[]]},{"id":"febe7fea143196b2","type":"server-state-changed","z":"2c89cfc34655fd37","name":"bathroom fans","server":"79544c2b.6ccc64","version":6,"outputs":2,"exposeAsEntityConfig":"","entities":{"entity":["switch.master_bathroom_fan","switch.guest_bathroom_fan","switch.downstairs_bathroom_fan"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"seconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"triggerId"}],"x":280,"y":200,"wires":[["ad1d7fca9525a090"],[]]},{"id":"7074c12d20da3e14","type":"server-state-changed","z":"2c89cfc34655fd37","name":"","server":"79544c2b.6ccc64","version":6,"outputs":2,"exposeAsEntityConfig":"","entities":{"entity":["sensor.lumi_lumi_weather_humidity"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"num","ifState":"60","ifStateType":"num","ifStateOperator":"gte","outputOnlyOnStateChange":false,"for":"1","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"triggerId"}],"x":390,"y":340,"wires":[["aa7e7599e51d4995"],[]]},{"id":"da19f84ff7643e73","type":"server-state-changed","z":"2c89cfc34655fd37","name":"","server":"79544c2b.6ccc64","version":6,"outputs":2,"exposeAsEntityConfig":"","entities":{"entity":["sensor.lumi_lumi_weather_humidity_2"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"num","ifState":"60","ifStateType":"num","ifStateOperator":"gte","outputOnlyOnStateChange":false,"for":"1","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"triggerId"}],"x":400,"y":440,"wires":[["46ae84e9a2771ad5"],[]]},{"id":"aa7e7599e51d4995","type":"api-call-service","z":"2c89cfc34655fd37","name":"","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"switch.turn_on","floorId":[],"areaId":[],"deviceId":[],"entityId":["switch.master_bathroom_fan"],"labelId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":false,"domain":"switch","service":"turn_on","x":820,"y":340,"wires":[[]]},{"id":"46ae84e9a2771ad5","type":"api-call-service","z":"2c89cfc34655fd37","name":"","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"switch.turn_on","floorId":[],"areaId":[],"deviceId":[],"entityId":["switch.guest_bathroom_fan"],"labelId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":false,"domain":"switch","service":"turn_on","x":820,"y":440,"wires":[[]]},{"id":"ad1d7fca9525a090","type":"trigger","z":"2c89cfc34655fd37","name":"","op1":"","op2":"","op1type":"nul","op2type":"payl","duration":"15","extend":true,"overrideDelay":false,"units":"min","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":530,"y":200,"wires":[["3e3f40e154dc0d86"]]},{"id":"a9fc19d16aeb2604","type":"server-state-changed","z":"f5468ca00e94e761","name":"in living room?","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["binary_sensor.living_room_fp2_presence_sensor_1"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"state","propertyType":"msg","value":"","valueType":"entityState"}],"x":300,"y":780,"wires":[["8db64b5100cf562c"]]},{"id":"0513abe7be784354","type":"api-current-state","z":"f5468ca00e94e761","name":"","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"playing","halt_if_type":"str","halt_if_compare":"is","entity_id":"{{payload}}","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1170,"y":720,"wires":[["b18bf663de6e75f8"],[]]},{"id":"b18bf663de6e75f8","type":"api-call-service","z":"f5468ca00e94e761","name":"","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"media_player.media_pause","floorId":[],"areaId":[],"deviceId":[],"entityId":["{{payload}}"],"labelId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":false,"domain":"media_player","service":"media_pause","x":1530,"y":720,"wires":[[]]},{"id":"0623eda4603e934c","type":"api-call-service","z":"f5468ca00e94e761","name":"","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"media_player.media_play","floorId":[],"areaId":[],"deviceId":[],"entityId":["{{payload}}"],"labelId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":false,"domain":"media_player","service":"media_play","x":1530,"y":840,"wires":[[]]},{"id":"864e360888886cc6","type":"api-current-state","z":"f5468ca00e94e761","name":"","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"paused","halt_if_type":"str","halt_if_compare":"is","entity_id":"{{payload}}","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1170,"y":840,"wires":[["0623eda4603e934c"],[]]},{"id":"8db64b5100cf562c","type":"change","z":"f5468ca00e94e761","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"[\"media_player.living_room_apple_tv\"]","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":640,"y":780,"wires":[["4014ccda493c2d3f"]]},{"id":"4014ccda493c2d3f","type":"split","z":"f5468ca00e94e761","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":770,"y":780,"wires":[["01cf083a8a9823a0"]]},{"id":"01cf083a8a9823a0","type":"switch","z":"f5468ca00e94e761","name":"","property":"state","propertyType":"msg","rules":[{"t":"eq","v":"off","vt":"str"},{"t":"eq","v":"on","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":930,"y":780,"wires":[["0513abe7be784354"],["864e360888886cc6"]]},{"id":"13f8826377a58ba0","type":"change","z":"f5468ca00e94e761","name":"","rules":[{"t":"set","p":"entities","pt":"msg","to":"[\"light.laundry_room_light\"]","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":620,"y":980,"wires":[["e7d05177b52666a0"]]},{"id":"105e2d16b9d3b606","type":"server-state-changed","z":"f5468ca00e94e761","name":"laundry room motion?","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["binary_sensor.laundry_room_motion_sensor_occupancy"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"milliseconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"laundry_room","valueType":"str"}],"x":320,"y":980,"wires":[["13f8826377a58ba0"]]},{"id":"e7d05177b52666a0","type":"subflow:173c5faccfb73051","z":"f5468ca00e94e761","name":"","x":850,"y":980,"wires":[]},{"id":"cb60c10532399262","type":"change","z":"f5468ca00e94e761","name":"","rules":[{"t":"set","p":"entities","pt":"msg","to":"[\"light.office_ceiling_light\",\"switch.desk_grow_light_switch_3\"]","tot":"json"},{"t":"set","p":"payload","pt":"msg","to":"off","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":620,"y":1100,"wires":[["83a8bc9439fcaef2"]]},{"id":"fa08d2d52dc07091","type":"server-state-changed","z":"f5468ca00e94e761","name":"office motion?","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["binary_sensor.office_fp2_presence_sensor_1"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"milliseconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":290,"y":1100,"wires":[[]]},{"id":"83a8bc9439fcaef2","type":"subflow:173c5faccfb73051","z":"f5468ca00e94e761","name":"","x":850,"y":1100,"wires":[]},{"id":"6962787d50ac97e7","type":"subflow:173c5faccfb73051","z":"f5468ca00e94e761","name":"","x":1150,"y":1420,"wires":[]},{"id":"2f42c6895aaf2794","type":"change","z":"f5468ca00e94e761","name":"","rules":[{"t":"set","p":"entities","pt":"msg","to":"[\"light.upstairs_hallway_lights\",\"light.flower_lamp\"]","tot":"json"},{"t":"set","p":"topic","pt":"msg","to":"upstairs_hall","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":1420,"wires":[["6962787d50ac97e7"]]},{"id":"badbdf75bf855c65","type":"server-state-changed","z":"f5468ca00e94e761","name":"upstairs hallway motion?","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["binary_sensor.upstairs_hall_motion_sensor_occupancy"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"milliseconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"upstairs_hall","valueType":"str"}],"x":330,"y":1420,"wires":[["8dc271a6a9f2ada9"]]},{"id":"0a6d7a72e642158d","type":"inject","z":"f5468ca00e94e761","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":300,"y":220,"wires":[["9f38acb29cf120e7"]]},{"id":"9f38acb29cf120e7","type":"change","z":"f5468ca00e94e761","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"item_type\":\"area\",\"area\":\"bonus_room\"}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":550,"y":220,"wires":[["54694ef13ddf55ed"]]},{"id":"54694ef13ddf55ed","type":"subflow:b0e3e1c3c40d9540","z":"f5468ca00e94e761","name":"","x":790,"y":220,"wires":[["7c6c092e7a31b118"]]},{"id":"7c6c092e7a31b118","type":"split","z":"f5468ca00e94e761","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1000,"y":220,"wires":[["22de19daf3c5e957"]]},{"id":"90431b2a05fc452c","type":"join","z":"f5468ca00e94e761","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","useparts":true,"accumulate":true,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"","reduceFixup":"","x":1390,"y":220,"wires":[["5134c06c2b04abfd"]]},{"id":"55653f952629f321","type":"function","z":"f5468ca00e94e761","name":"function 1","func":"const transformFunc = async (t, { color, brightness_pct }) => {\n    const payload = {\n        rgb_color: color.valueOf(),\n        brightness_pct: brightness_pct.valueOf(),\n    };\n\n    node.send({\n        payload,\n    });\n\n    // sleep for 1 minute:\n    node.status({\n        fill: \"yellow\",\n        shape: \"dot\",\n        text: \"sleeping...\",\n    });\n\n    await new Promise((resolve) => setTimeout(resolve, 60000));\n};\n\nconst tmp = new keyframesTs.CSSKeyframesAnimation({\n    duration: \"100ms\",\n});\n\ntmp.fromVars(\n    [\n        {\n            brightness_pct: 0,\n            color: \"1000k\",\n        },\n        {\n            brightness_pct: 100,\n            color: \"3500k\",\n        },\n    ],\n    transformFunc\n);\n\ntmp.play();\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[{"var":"cronosjs","module":"cronosjs"},{"var":"keyframesTs","module":"keyframes.ts"}],"x":500,"y":100,"wires":[["3d5c5e31a3e9b837"]]},{"id":"6b9ea3ebbda7b89d","type":"inject","z":"f5468ca00e94e761","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":300,"y":100,"wires":[["55653f952629f321"]]},{"id":"3d5c5e31a3e9b837","type":"debug","z":"f5468ca00e94e761","name":"debug 39","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":720,"y":100,"wires":[]},{"id":"5134c06c2b04abfd","type":"debug","z":"f5468ca00e94e761","name":"debug 1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1620,"y":220,"wires":[]},{"id":"22de19daf3c5e957","type":"ha-get-entities","z":"f5468ca00e94e761","name":"","server":"79544c2b.6ccc64","version":1,"rules":[{"condition":"state_object","property":"entity_id","logic":"is","value":"payload","valueType":"msg"}],"outputType":"random","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"payload","outputResultsCount":1,"x":1190,"y":220,"wires":[["90431b2a05fc452c"]]},{"id":"b318488703f63220","type":"subflow:173c5faccfb73051","z":"f5468ca00e94e761","name":"","x":1470,"y":1660,"wires":[]},{"id":"c5c058fa98a8448e","type":"server-state-changed","z":"f5468ca00e94e761","name":"plant room motion?","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["binary_sensor.plant_room_motion_sensor_occupancy"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"milliseconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"state","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"plant_room","valueType":"str"}],"x":310,"y":1660,"wires":[["05c1aa5f3fb0c1aa"]]},{"id":"de424fcba575a736","type":"subflow:b0e3e1c3c40d9540","z":"f5468ca00e94e761","name":"","x":1030,"y":1660,"wires":[["ea4ad330fd832ec1"]]},{"id":"05c1aa5f3fb0c1aa","type":"change","z":"f5468ca00e94e761","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"item_type\":\"area\",\"area\":\"plant_room\"}","tot":"json"},{"t":"set","p":"domains","pt":"msg","to":"[\"light\"]","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":1660,"wires":[["de424fcba575a736"]]},{"id":"805023e75fb61a78","type":"server-state-changed","z":"f5468ca00e94e761","name":"bonus room motion?","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["binary_sensor.bonus_room_motion_sensor_occupancy"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"milliseconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"state","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"bonus_room","valueType":"str"}],"x":320,"y":1900,"wires":[["7a6ed0d5609b7d22"]]},{"id":"750cb3052ce8f991","type":"subflow:b0e3e1c3c40d9540","z":"f5468ca00e94e761","name":"","x":1030,"y":1900,"wires":[["4a8ec37a8e1f6a4d"]]},{"id":"dbac8c7b84b121f6","type":"change","z":"f5468ca00e94e761","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"item_type\":\"area\",\"area\":\"bonus_room\"}","tot":"json"},{"t":"set","p":"domains","pt":"msg","to":"[\"light\"]","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":1900,"wires":[["750cb3052ce8f991"]]},{"id":"bb62d6afe393b895","type":"subflow:173c5faccfb73051","z":"f5468ca00e94e761","name":"","x":1470,"y":1900,"wires":[]},{"id":"ea4ad330fd832ec1","type":"change","z":"f5468ca00e94e761","name":"","rules":[{"t":"set","p":"entities","pt":"msg","to":"payload","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"state","tot":"msg"},{"t":"set","p":"entities","pt":"msg","to":"$append(entities, [\"switch.grow_light_bookshelf_1_switch\"])","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1200,"y":1660,"wires":[["b318488703f63220"]]},{"id":"4a8ec37a8e1f6a4d","type":"change","z":"f5468ca00e94e761","name":"","rules":[{"t":"set","p":"entities","pt":"msg","to":"payload","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"state","tot":"msg"},{"t":"set","p":"entities","pt":"msg","to":"$append(\t   entities,\t   [\t       \"switch.bonus_room_grow_light_switch_6\",\t       \"switch.bonus_room_grow_light_switch_2\"\t   ]\t)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1200,"y":1900,"wires":[["bb62d6afe393b895"]]},{"id":"38bb81977878d3a4","type":"server-state-changed","z":"f5468ca00e94e761","name":"stairwell motion?","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["binary_sensor.stairwell_motion_sensor_occupancy_2"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"milliseconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"upstairs_hall","valueType":"str"}],"x":300,"y":1480,"wires":[["8dc271a6a9f2ada9"]]},{"id":"898c6074de049758","type":"server-state-changed","z":"f5468ca00e94e761","name":"masther bathroom motion?","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["binary_sensor.master_bathroom_motion_sensor_occupancy"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"milliseconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"state","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"master_bathroom","valueType":"str"}],"x":340,"y":2480,"wires":[["5eb251458563e0a3"]]},{"id":"fc38355f2794c1e4","type":"subflow:b0e3e1c3c40d9540","z":"f5468ca00e94e761","name":"","x":1030,"y":2480,"wires":[["b063d85a5b0e9b6e"]]},{"id":"a27d914ff9e0d53e","type":"change","z":"f5468ca00e94e761","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"item_type\":\"area\",\"area\":\"master_bathroom\"}","tot":"json"},{"t":"set","p":"domains","pt":"msg","to":"[\"light\"]","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":2480,"wires":[["fc38355f2794c1e4"]]},{"id":"74c10506c3795d55","type":"subflow:173c5faccfb73051","z":"f5468ca00e94e761","name":"","x":1650,"y":2480,"wires":[]},{"id":"b063d85a5b0e9b6e","type":"change","z":"f5468ca00e94e761","name":"","rules":[{"t":"set","p":"entities","pt":"msg","to":"payload","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"state","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1200,"y":2480,"wires":[["74c10506c3795d55"]]},{"id":"5eb251458563e0a3","type":"api-current-state","z":"f5468ca00e94e761","name":"daytime set?","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"day","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_select.day_status","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":610,"y":2480,"wires":[["a27d914ff9e0d53e"],["2d18f7b06e29a9b9"]]},{"id":"2d18f7b06e29a9b9","type":"change","z":"f5468ca00e94e761","name":"","rules":[{"t":"set","p":"entities","pt":"msg","to":"[\"light.master_bathroom_chili_pepper_lights\"]","tot":"json"},{"t":"set","p":"payload","pt":"msg","to":"state","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":2560,"wires":[["74c10506c3795d55"]]},{"id":"2d4934e4a4bbd97a","type":"server-state-changed","z":"f5468ca00e94e761","name":"plant room motion?","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["binary_sensor.plant_room_motion_sensor_2"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"milliseconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"state","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"plant_room","valueType":"str"}],"x":310,"y":1720,"wires":[["05c1aa5f3fb0c1aa"]]},{"id":"35fdd35a8578533a","type":"server-state-changed","z":"f5468ca00e94e761","name":"guest bedroom room motion?","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["binary_sensor.guest_bedroom_motion_sensor"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"milliseconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"state","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"guest_bedroom","valueType":"str"}],"x":340,"y":2120,"wires":[["14e5d41491f0f40a"]]},{"id":"b8f24fe555583a7e","type":"subflow:b0e3e1c3c40d9540","z":"f5468ca00e94e761","name":"","x":1190,"y":2120,"wires":[["22dec103fb5cb5a4"]]},{"id":"e8c9e92602c6c4af","type":"change","z":"f5468ca00e94e761","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"item_type\":\"area\",\"area\":\"guest_bedroom\"}","tot":"json"},{"t":"set","p":"domains","pt":"msg","to":"[\"light\"]","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":1020,"y":2120,"wires":[["b8f24fe555583a7e"]]},{"id":"7e38b16a582f0666","type":"subflow:173c5faccfb73051","z":"f5468ca00e94e761","name":"","x":1590,"y":2120,"wires":[]},{"id":"22dec103fb5cb5a4","type":"change","z":"f5468ca00e94e761","name":"","rules":[{"t":"set","p":"entities","pt":"msg","to":"payload","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"state","tot":"msg"},{"t":"set","p":"entities","pt":"msg","to":"$append(\t   entities,\t   [\t       \"switch.bonus_room_grow_light_switch_6\",\t       \"switch.bonus_room_grow_light_switch_2\"\t   ]\t)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1360,"y":2120,"wires":[["7e38b16a582f0666"]]},{"id":"fd23f298dd52e8ac","type":"server-state-changed","z":"f5468ca00e94e761","name":"masther bathroom motion?","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["binary_sensor.master_bathroom_motion_sensor_2"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"milliseconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"state","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"master_bathroom","valueType":"str"}],"x":340,"y":2540,"wires":[["5eb251458563e0a3"]]},{"id":"24f7def55c14922c","type":"ha-get-entities","z":"f5468ca00e94e761","name":"","server":"79544c2b.6ccc64","version":1,"rules":[{"condition":"state_object","property":"attributes.device_class","logic":"is","value":"motion","valueType":"str"}],"outputType":"array","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"payload","outputResultsCount":1,"x":1050,"y":420,"wires":[["0f76751d6b580706"]]},{"id":"bc659da1d7e3e9a6","type":"ha-get-entities","z":"f5468ca00e94e761","name":"","server":"79544c2b.6ccc64","version":1,"rules":[{"condition":"state_object","property":"attributes.device_class","logic":"is","value":"occupancy","valueType":"str"}],"outputType":"array","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"payload","outputResultsCount":1,"x":1050,"y":480,"wires":[["0f76751d6b580706"]]},{"id":"0f76751d6b580706","type":"split","z":"f5468ca00e94e761","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1210,"y":420,"wires":[["94209148c5b7f146"]]},{"id":"3e6974509cc74c81","type":"subflow:685bfaf1e94471c7","z":"f5468ca00e94e761","name":"set unknown","x":1670,"y":420,"wires":[["21e0fa9e2b81f120"]]},{"id":"94209148c5b7f146","type":"change","z":"f5468ca00e94e761","name":"","rules":[{"t":"set","p":"state","pt":"msg","to":"unknown","tot":"str"},{"t":"set","p":"tmpState","pt":"msg","to":"payload.state","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"payload.entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1520,"y":420,"wires":[["3e6974509cc74c81"]]},{"id":"21e0fa9e2b81f120","type":"change","z":"f5468ca00e94e761","name":"","rules":[{"t":"set","p":"state","pt":"msg","to":"tmpState","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"payload.entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1880,"y":420,"wires":[["1b71d88988b2ee9b"]]},{"id":"1b71d88988b2ee9b","type":"subflow:685bfaf1e94471c7","z":"f5468ca00e94e761","name":"set original","x":2030,"y":420,"wires":[[]]},{"id":"3860856df13d02e0","type":"server-state-changed","z":"f5468ca00e94e761","name":"bonus room motion?","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["binary_sensor.bonus_room_motion_sensor_2"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"milliseconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"state","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"bonus_room","valueType":"str"}],"x":320,"y":1960,"wires":[["7a6ed0d5609b7d22"]]},{"id":"b43bd237aef771c8","type":"api-current-state","z":"f5468ca00e94e761","name":"home?","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"home","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_select.home_status","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":640,"y":420,"wires":[["7baf3d68b3eab36b"],[]]},{"id":"94bf4cffcdf80f08","type":"server-state-changed","z":"f5468ca00e94e761","name":"daytime/home change?","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["input_select.day_status","scene.daytime_2","scene.nighttime","input_select.home_status"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"1","forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":320,"y":420,"wires":[["b43bd237aef771c8"]]},{"id":"80ab31165559da0b","type":"api-current-state","z":"f5468ca00e94e761","name":"daytime set?","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"day","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_select.day_status","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":810,"y":2120,"wires":[["e8c9e92602c6c4af"],[]]},{"id":"8dc271a6a9f2ada9","type":"api-current-state","z":"f5468ca00e94e761","name":"daytime set?","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"day","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_select.day_status","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":610,"y":1420,"wires":[["2f42c6895aaf2794"],[]]},{"id":"7baf3d68b3eab36b","type":"debounce-advanced","z":"f5468ca00e94e761","time":"2","timeunit":"s","debouncetype":"trailing","name":"","x":810,"y":420,"wires":[["24f7def55c14922c","bc659da1d7e3e9a6"]]},{"id":"7c4206023c5b17f7","type":"ha-get-entities","z":"f5468ca00e94e761","name":"","server":"79544c2b.6ccc64","version":1,"rules":[{"condition":"state_object","property":"entity_id","logic":"is","value":"binary_sensor.downstairs_bathroom_motion_sensor_2","valueType":"str"}],"outputType":"array","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"payload","outputResultsCount":1,"x":1050,"y":360,"wires":[["0f76751d6b580706"]]},{"id":"fb6be089f081b8b3","type":"switch","z":"f5468ca00e94e761","name":"","property":"payload.state","propertyType":"msg","rules":[{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1350,"y":520,"wires":[["94209148c5b7f146"]]},{"id":"73cff6090395df46","type":"server-state-changed","z":"f5468ca00e94e761","name":"guest bathroom motion?","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["binary_sensor.guest_bathroom_motion_sensor"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"milliseconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"state","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"guest_bathroom","valueType":"str"}],"x":330,"y":2260,"wires":[["1692ab23efd92bd4"]]},{"id":"66eba871e6ffcf61","type":"subflow:b0e3e1c3c40d9540","z":"f5468ca00e94e761","name":"","x":1030,"y":2260,"wires":[["d695506679f17975"]]},{"id":"0f57f54766384243","type":"change","z":"f5468ca00e94e761","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"item_type\":\"area\",\"area\":\"guest_bathroom\"}","tot":"json"},{"t":"set","p":"domains","pt":"msg","to":"[\"light\"]","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":2260,"wires":[["66eba871e6ffcf61"]]},{"id":"4fc9e2c157979f62","type":"subflow:173c5faccfb73051","z":"f5468ca00e94e761","name":"","x":1650,"y":2260,"wires":[]},{"id":"d695506679f17975","type":"change","z":"f5468ca00e94e761","name":"","rules":[{"t":"set","p":"entities","pt":"msg","to":"payload","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"state","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1200,"y":2260,"wires":[["4fc9e2c157979f62"]]},{"id":"1692ab23efd92bd4","type":"api-current-state","z":"f5468ca00e94e761","name":"daytime set?","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"day","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_select.day_status","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":610,"y":2260,"wires":[["0f57f54766384243"],["41d9764be60926e2"]]},{"id":"41d9764be60926e2","type":"change","z":"f5468ca00e94e761","name":"","rules":[{"t":"set","p":"entities","pt":"msg","to":"[\"light.guest_bathroom_peppa_pig_lights\"]","tot":"json"},{"t":"set","p":"payload","pt":"msg","to":"state","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":2340,"wires":[["4fc9e2c157979f62"]]},{"id":"7f4e5e93963c058c","type":"subflow:173c5faccfb73051","z":"f5468ca00e94e761","name":"","x":1650,"y":1240,"wires":[]},{"id":"850d40af73656046","type":"change","z":"f5468ca00e94e761","name":"","rules":[{"t":"set","p":"entities","pt":"msg","to":"[\"light.downstairs_bathroom_chili_pepper_lights\"]","tot":"json"},{"t":"set","p":"payload","pt":"msg","to":"state","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":1320,"wires":[["7f4e5e93963c058c"]]},{"id":"1c2a29c97ac1c75b","type":"api-current-state","z":"f5468ca00e94e761","name":"daytime set?","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"day","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_select.day_status","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":610,"y":1240,"wires":[["e2a0a1a1e0dbe7a7"],["850d40af73656046"]]},{"id":"5b4ca4a35f590d41","type":"server-state-changed","z":"f5468ca00e94e761","name":"downstairs bathroom motion?","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["binary_sensor.downstairs_bathroom_motion_sensor_occupancy"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"milliseconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"state","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"downstairs_bathroom","valueType":"str"}],"x":340,"y":1240,"wires":[["1c2a29c97ac1c75b"]]},{"id":"61dc59d1d7d8efd6","type":"server-state-changed","z":"f5468ca00e94e761","name":"downstairs bathroom motion?","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["binary_sensor.downstairs_bathroom_motion_sensor_2"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"milliseconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"state","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"downstairs_bathroom","valueType":"str"}],"x":340,"y":1300,"wires":[["1c2a29c97ac1c75b"]]},{"id":"bde2504fa4adcca3","type":"server-state-changed","z":"f5468ca00e94e761","name":"garage motion?","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["binary_sensor.garage_motion_sensor"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"milliseconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"state","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"garage","valueType":"str"}],"x":300,"y":2760,"wires":[["2e8a6c6e2c549847"]]},{"id":"a2bfa65fd0b28b4b","type":"subflow:b0e3e1c3c40d9540","z":"f5468ca00e94e761","name":"","x":1030,"y":2760,"wires":[["06bd9c4c1a37300d"]]},{"id":"2e8a6c6e2c549847","type":"change","z":"f5468ca00e94e761","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"item_type\":\"area\",\"area\":\"garage\"}","tot":"json"},{"t":"set","p":"domains","pt":"msg","to":"[\"light\"]","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":2760,"wires":[["a2bfa65fd0b28b4b"]]},{"id":"15b3ce77b691cec0","type":"subflow:173c5faccfb73051","z":"f5468ca00e94e761","name":"","x":1450,"y":2760,"wires":[]},{"id":"06bd9c4c1a37300d","type":"change","z":"f5468ca00e94e761","name":"","rules":[{"t":"set","p":"entities","pt":"msg","to":"payload","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"state","tot":"msg"},{"t":"set","p":"entities","pt":"msg","to":"$append(\t   entities,\t   [\t       \"switch.bonus_room_grow_light_switch_6\",\t       \"switch.bonus_room_grow_light_switch_2\"\t   ]\t)","tot":"jsonata"},{"t":"set","p":"coolDown","pt":"msg","to":"1800","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1200,"y":2760,"wires":[["15b3ce77b691cec0"]]},{"id":"e2a0a1a1e0dbe7a7","type":"change","z":"f5468ca00e94e761","name":"","rules":[{"t":"set","p":"entities","pt":"msg","to":"[\"light.downstairs_bathroom_light\"]","tot":"json"},{"t":"set","p":"payload","pt":"msg","to":"state","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":1240,"wires":[["7f4e5e93963c058c"]]},{"id":"7a6ed0d5609b7d22","type":"api-current-state","z":"f5468ca00e94e761","name":"daytime set?","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"day","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_select.day_status","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":610,"y":1900,"wires":[["dbac8c7b84b121f6"],["999e2d0544d44cb8"]]},{"id":"999e2d0544d44cb8","type":"change","z":"f5468ca00e94e761","name":"","rules":[{"t":"set","p":"entities","pt":"msg","to":"[\"light.hey_lamp_2_2\"]","tot":"json"},{"t":"set","p":"payload","pt":"msg","to":"state","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":2000,"wires":[[]]},{"id":"76000737aa014a12","type":"inject","z":"f5468ca00e94e761","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":300,"y":520,"wires":[["28edd8deb79fda75","7c4206023c5b17f7","24f7def55c14922c","bc659da1d7e3e9a6"]]},{"id":"14e5d41491f0f40a","type":"api-current-state","z":"f5468ca00e94e761","name":"guest mode?","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.guest_mode","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":"","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":610,"y":2120,"wires":[[],["80ab31165559da0b"]]},{"id":"418ea3834788dede","type":"server-state-changed","z":"f5468ca00e94e761","name":"garage motion?","server":"79544c2b.6ccc64","version":6,"outputs":1,"exposeAsEntityConfig":"","entities":{"entity":["binary_sensor.ratgdov25i_4b1c3b_motion"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"milliseconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"state","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"garage","valueType":"str"}],"x":300,"y":2820,"wires":[["2e8a6c6e2c549847"]]},{"id":"28edd8deb79fda75","type":"ha-get-entities","z":"f5468ca00e94e761","name":"","server":"79544c2b.6ccc64","version":1,"rules":[{"condition":"state_object","property":"entity_id","logic":"is","value":"binary_sensor.downstairs_bathroom_motion_sensor_occupancy","valueType":"str"}],"outputType":"array","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"payload","outputResultsCount":1,"x":1050,"y":320,"wires":[["0f76751d6b580706"]]},{"id":"9b723d99a73d643f","type":"function","z":"e05fae85092ccf96","name":"battery","func":"// src/batteries/battery.ts\nvar LOW_BATTERY_THRESHOLD = 30;\nvar CRITICAL_BATTERY_THRESHOLD = 15;\nvar message = msg;\nvar entities = Array.isArray(message.payload) ? message.payload : [message.payload];\nvar uniqueEntities = /* @__PURE__ */ new Map();\nentities.forEach((entity) => {\n    if (!uniqueEntities.has(entity.entity_id)) {\n        uniqueEntities.set(entity.entity_id, entity);\n    }\n});\nentities = Array.from(uniqueEntities.values());\nfunction getBatteryState(entity) {\n    if (entity.entity_id.includes(\"battery\") && !isNaN(Number(entity.state))) {\n        return Number(entity.state);\n    }\n    if (\"battery_level\" in entity.attributes && !isNaN(Number(entity.attributes.battery_level))) {\n        return Number(entity.attributes.battery_level);\n    }\n    return null;\n}\nfunction isBatteryEntity(entity) {\n    if (entity.entity_id.startsWith(\"device_tracker.\")) {\n        return false;\n    }\n    return getBatteryState(entity) !== null;\n}\nvar batteryEntities = entities.filter(isBatteryEntity).map((entity) => {\n    const batteryState = getBatteryState(entity);\n    return {\n        entity_id: entity.entity_id,\n        friendly_name: entity.attributes.friendly_name || entity.entity_id,\n        state: batteryState,\n        // Include all other original keys\n        ...entity\n    };\n});\nbatteryEntities.sort((a, b) => {\n    return (a.state || 0) - (b.state || 0);\n});\nvar lowBatteries = batteryEntities.filter(\n    (e) => (\n        // @ts-ignore\n        e.state !== null && e.state < LOW_BATTERY_THRESHOLD\n    )\n);\nif (lowBatteries.length === 0) {\n    msg = null;\n} else {\n    let notificationTitle = \"Home Assistant Battery Report\";\n    let notificationMessage = \"\";\n    const criticalBatteries = lowBatteries.filter(\n        // @ts-ignore\n        (e) => e.state < CRITICAL_BATTERY_THRESHOLD\n    );\n    if (criticalBatteries.length > 0) {\n        notificationTitle = \"\\u26A0\\uFE0F Critical Battery Levels\";\n        notificationMessage = criticalBatteries.map((e) => `${e.friendly_name}: ${e.state}%`).join(\"\\n\");\n    } else {\n        notificationTitle = \"\\u{1F50B} Low Battery Levels\";\n        notificationMessage = lowBatteries.map((e) => `${e.friendly_name}: ${e.state}%`).join(\"\\n\");\n    }\n    msg.payload = {\n        batteryEntities,\n        notification: {\n            title: notificationTitle,\n            message: notificationMessage,\n            data: {\n                push: {\n                    category: \"battery-alert\"\n                },\n                entity_id: batteryEntities.map((e) => e.entity_id)\n            }\n        }\n    };\n    msg.batteryReport = {\n        entities: batteryEntities,\n        total: batteryEntities.length,\n        lowCount: lowBatteries.length\n    };\n}\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1500,"y":620,"wires":[["2fb01d9414c204a1","ea3fdabd24162ddd"]]},{"id":"46594b4ce131bbbe","type":"change","z":"e05fae85092ccf96","name":"","rules":[{"t":"set","p":"entities","pt":"msg","to":"(\t    $append(entities, payload)\t)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1240,"y":620,"wires":[["e957eaacdb372e46"]]},{"id":"6431543b247f3603","type":"change","z":"e05fae85092ccf96","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"(\t    $append(entities, payload)\t)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1250,"y":740,"wires":[["9b723d99a73d643f"]]},{"id":"e957eaacdb372e46","type":"ha-get-entities","z":"e05fae85092ccf96","name":"","server":"79544c2b.6ccc64","version":1,"rules":[{"condition":"state_object","property":"attributes.battery_level","logic":"lte","value":"100","valueType":"num"}],"outputType":"array","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"payload","outputResultsCount":1,"x":1090,"y":680,"wires":[["333a0454d456bc35"]]},{"id":"17022a0fd8649b80","type":"ha-get-entities","z":"e05fae85092ccf96","name":"","server":"79544c2b.6ccc64","version":1,"rules":[{"condition":"state_object","property":"attributes.battery_quantity","logic":"is_not","value":"","valueType":"num"}],"outputType":"array","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"payload","outputResultsCount":1,"x":1090,"y":740,"wires":[["6431543b247f3603"]]},{"id":"764b23e0c30d1f49","type":"ha-get-entities","z":"e05fae85092ccf96","name":"","server":"79544c2b.6ccc64","version":1,"rules":[{"condition":"state_object","property":"attributes.battery_voltage","logic":"is_not","value":"","valueType":"num"}],"outputType":"array","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"payload","outputResultsCount":1,"x":1090,"y":620,"wires":[["46594b4ce131bbbe"]]},{"id":"333a0454d456bc35","type":"change","z":"e05fae85092ccf96","name":"","rules":[{"t":"set","p":"entities","pt":"msg","to":"(\t    $append(entities, payload)\t)","tot":"jsonata"}],"action":"","property":"","from":"","to":"","reg":false,"x":1240,"y":680,"wires":[["17022a0fd8649b80"]]},{"id":"2fb01d9414c204a1","type":"api-call-service","z":"e05fae85092ccf96","name":"","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"notify.mobile_app_fff","floorId":[],"areaId":[],"deviceId":[],"entityId":[],"labelId":[],"data":"payload.notification","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":true,"domain":"notify","service":"mobile_app_fff","x":1760,"y":620,"wires":[[]]},{"id":"ea3fdabd24162ddd","type":"api-call-service","z":"e05fae85092ccf96","name":"","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"notify.persistent_notification","floorId":[],"areaId":[],"deviceId":[],"entityId":[],"labelId":[],"data":"payload.notification","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":true,"domain":"notify","service":"persistent_notification","x":1780,"y":680,"wires":[[]]},{"id":"00339627bed34a06","type":"inject","z":"e05fae85092ccf96","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":480,"y":480,"wires":[["764b23e0c30d1f49"]]},{"id":"2017cf8766765cf0","type":"api-current-state","z":"e05fae85092ccf96","name":"is day?","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"day","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_select.day_status","state_type":"str","blockInputOverrides":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":760,"y":560,"wires":[["84b72693940051d8"],[]]},{"id":"0b15b97106131979","type":"server-state-changed","z":"e05fae85092ccf96","name":"","server":"79544c2b.6ccc64","version":6,"outputs":2,"exposeAsEntityConfig":"","entities":{"entity":["input_select.day_status"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"day","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":550,"y":560,"wires":[["2017cf8766765cf0"],[]]},{"id":"84b72693940051d8","type":"debounce-advanced","z":"e05fae85092ccf96","time":"1","timeunit":"m","debouncetype":"trailing","name":"","x":870,"y":560,"wires":[["764b23e0c30d1f49"]]},{"id":"96698ebdea9ee816","type":"server-state-changed","z":"f8ef387edcc58dc1","name":"piano vibrating?","server":"79544c2b.6ccc64","version":6,"outputs":2,"exposeAsEntityConfig":"","entities":{"entity":["binary_sensor.piano_vibration_sensor_motion"],"substring":[],"regex":[]},"outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"seconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":590,"y":540,"wires":[[],[]]},{"id":"7a763ae5cc33baf9","type":"api-call-service","z":"f8ef387edcc58dc1","name":"","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"light.turn_on","floorId":[],"areaId":[],"deviceId":[],"entityId":["light.hanging_light","light.kitchen_pendants"],"labelId":[],"data":"{\"rgb_color\": [181, 22, 22], \"effect\": \"effect_colorloop\"}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":false,"domain":"light","service":"turn_on","x":1560,"y":460,"wires":[["89f8150f5748a5e4"]]},{"id":"89f8150f5748a5e4","type":"debug","z":"f8ef387edcc58dc1","name":"debug 32","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1930,"y":460,"wires":[]},{"id":"55ba921fb66b2a8c","type":"inject","z":"f8ef387edcc58dc1","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":590,"y":460,"wires":[["5bace482cd823ac3"]]},{"id":"5bace482cd823ac3","type":"ha-get-entities","z":"f8ef387edcc58dc1","name":"","server":"79544c2b.6ccc64","version":1,"rules":[{"property":"entity_id","logic":"includes","value":"[\t    \"light.hanging_light\",\t    \"switch.hanging_light_grow_light_1_switch\",\t    \"light.kitchen_pendants\"\t]","valueType":"jsonata"}],"outputType":"array","outputEmptyResults":false,"outputLocationType":"msg","outputLocation":"payload","outputResultsCount":1,"x":840,"y":460,"wires":[[]]},{"id":"ba7454d8be7cfe9c","type":"api-call-service","z":"f8ef387edcc58dc1","name":"","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"floorId":[],"areaId":[],"deviceId":[],"entityId":[],"labelId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":false,"domain":"","service":"","x":1560,"y":860,"wires":[["c1743b3489cb263e"]]},{"id":"61670e0ae14f7aa7","type":"split","z":"f8ef387edcc58dc1","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1410,"y":860,"wires":[["ba7454d8be7cfe9c"]]},{"id":"37518190ced6fc96","type":"api-call-service","z":"f8ef387edcc58dc1","name":"","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"action":"switch.turn_off","floorId":[],"areaId":[],"deviceId":[],"entityId":["switch.hanging_light_grow_light_1_switch"],"labelId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":false,"domain":"switch","service":"turn_off","x":1570,"y":520,"wires":[[]]},{"id":"d049429562841c64","type":"switch","z":"f8ef387edcc58dc1","name":"","property":"cachedStates","propertyType":"flow","rules":[{"t":"null"}],"checkall":"true","repair":false,"outputs":1,"x":1140,"y":460,"wires":[["c5fd197a0217f533"]]},{"id":"c5fd197a0217f533","type":"change","z":"f8ef387edcc58dc1","name":"","rules":[{"t":"set","p":"cachedStates","pt":"flow","to":"cachedStates","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1320,"y":460,"wires":[["7a763ae5cc33baf9","37518190ced6fc96"]]},{"id":"5a8393c24cc2478e","type":"switch","z":"f8ef387edcc58dc1","name":"","property":"cachedStates","propertyType":"flow","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":1100,"y":860,"wires":[["6fd5b6376a20bdf6"]]},{"id":"6fd5b6376a20bdf6","type":"change","z":"f8ef387edcc58dc1","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"cachedStates","tot":"flow"},{"t":"set","p":"cachedStates","pt":"flow","to":"null","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":1260,"y":860,"wires":[["61670e0ae14f7aa7"]]},{"id":"c1743b3489cb263e","type":"debug","z":"f8ef387edcc58dc1","name":"debug 33","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1930,"y":860,"wires":[]},{"id":"d23c25b99a2a2e5a","type":"debounce-advanced","z":"f8ef387edcc58dc1","time":"10","timeunit":"s","debouncetype":"trailing","name":"","x":780,"y":860,"wires":[["d6e47df1d49b691b"]]},{"id":"d6e47df1d49b691b","type":"api-current-state","z":"f8ef387edcc58dc1","name":"still off?","server":"79544c2b.6ccc64","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.piano_vibration_sensor_motion","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":890,"y":860,"wires":[["5a8393c24cc2478e"],[]]},{"id":"fe01bd41da475b5e","type":"http in","z":"6337f535d7b8e1f2","name":"","url":"/remote/","method":"post","upload":false,"swaggerDoc":"","x":290,"y":380,"wires":[["e2cb1e6a7e2044f7"]]},{"id":"54e5212f31f8ee50","type":"api-current-state","z":"6337f535d7b8e1f2","name":"get entity attributes","server":"79544c2b.6ccc64","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"{{payload.target.entity_attributes_id}}","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload.entity_attributes","propertyType":"msg","value":"","valueType":"entityState"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":830,"y":380,"wires":[["93322dbb82acb24c"]]},{"id":"e2cb1e6a7e2044f7","type":"function","z":"6337f535d7b8e1f2","name":"get entity attributes id","func":"\"use strict\";\nfunction getEntityBasename(entityId2) {\n    const match = entityId2.match(/^.*\\.(.*)$/);\n    return match ? match[1] : entityId2;\n}\nconst entityId = msg.payload.target.entity_id;\nconst basename = getEntityBasename(entityId);\nconst entityAttributesId = `input_text.${basename}_attributes`;\nconst entityStateId = `input_text.${basename}_state`;\nmsg.payload.target.entity_attributes_id = entityAttributesId;\nmsg.payload.target.entity_state_id = entityStateId;\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":600,"y":380,"wires":[["54e5212f31f8ee50"]]},{"id":"97447b6fc2c005a8","type":"debug","z":"6337f535d7b8e1f2","name":"debug 23","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1720,"y":140,"wires":[]},{"id":"059a374f75100241","type":"http response","z":"6337f535d7b8e1f2","name":"","statusCode":"200","headers":{},"x":2940,"y":380,"wires":[]},{"id":"93322dbb82acb24c","type":"api-current-state","z":"6337f535d7b8e1f2","name":"get entity state","server":"79544c2b.6ccc64","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"{{payload.target.entity_state_id}}","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload.entity_state","propertyType":"msg","value":"","valueType":"entityState"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1040,"y":380,"wires":[["ba17a7bee754d74a","274deb9de88f8cd7"]]},{"id":"ba17a7bee754d74a","type":"function","z":"6337f535d7b8e1f2","name":"create service call","func":"\"use strict\";\nfunction mapRange(value, fromMin, fromMax, toMin, toMax) {\n    return (value - fromMin) * (toMax - toMin) / (fromMax - fromMin) + toMin;\n}\nconst parseFloatIfString = (value) => {\n    return typeof value === \"string\" ? parseFloat(value) : value;\n};\nconst DEFAULT_REMOTE_DATA = {\n    num_repeats: 1,\n    delay_secs: 0.5,\n    hold_secs: 0\n};\nvar LightCommand = /* @__PURE__ */ ((LightCommand2) => {\n    LightCommand2[\"TURN_ON\"] = \"turn_on\";\n    LightCommand2[\"TURN_OFF\"] = \"turn_off\";\n    LightCommand2[\"BRIGHTNESS_UP\"] = \"increase_brightness\";\n    LightCommand2[\"BRIGHTNESS_DOWN\"] = \"decrease_brightness\";\n    LightCommand2[\"TEMPERATURE_UP\"] = \"increase_color_temp\";\n    LightCommand2[\"TEMPERATURE_DOWN\"] = \"decrease_color_temp\";\n    return LightCommand2;\n})(LightCommand || {});\nvar FanCommand = /* @__PURE__ */ ((FanCommand2) => {\n    FanCommand2[\"TURN_ON\"] = \"turn_on\";\n    FanCommand2[\"TURN_OFF\"] = \"turn_off\";\n    FanCommand2[\"INCREASE_SPEED\"] = \"increase_speed\";\n    FanCommand2[\"DECREASE_SPEED\"] = \"decrease_speed\";\n    FanCommand2[\"OSCILLATE_ON\"] = \"oscillate_on\";\n    FanCommand2[\"OSCILLATE_OFF\"] = \"oscillate_off\";\n    FanCommand2[\"SET_PRESET_MODE\"] = \"set_preset_mode\";\n    return FanCommand2;\n})(FanCommand || {});\nconst MIN_LEVEL = 1;\nconst MIN_PERCENTAGE = 0;\nconst MAX_PERCENTAGE = 100;\nconst MIN_COLOR_TEMP = 154;\nconst MAX_COLOR_TEMP = 500;\nconst MIN_UNIT = 0;\nconst MAX_UNIT = 1;\nconst MIN_BINARY = 0;\nconst MAX_BINARY = 255;\nconst MIN_STEP = -1;\nconst MAX_STEP = 1;\nfunction mapInputBrightness(payload, maxLevel) {\n    const { data: data2 } = payload;\n    const [brightnessString, minBrightness, maxBrightness] = (() => {\n        if (data2.brightness) {\n            return [data2.brightness, MIN_BINARY, MAX_BINARY];\n        } else if (data2.brightness_pct) {\n            return [data2.brightness_pct, MIN_PERCENTAGE, MAX_PERCENTAGE];\n        } else if (data2.brightness_step) {\n            return [data2.brightness_step, MIN_STEP, MAX_STEP];\n        } else {\n            return [void 0, MIN_UNIT, MAX_UNIT];\n        }\n    })();\n    const brightness = parseFloatIfString(brightnessString);\n    return mapRange(brightness, minBrightness, maxBrightness, MIN_LEVEL, maxLevel);\n}\nfunction isLightServiceCallPayload(payload) {\n    return payload.domain === \"light\";\n}\nfunction isFanServiceCallPayload(payload) {\n    return payload.domain === \"fan\";\n}\nfunction getLightPayloadValues(payload, commandType) {\n    let maxLevel;\n    let currentValue;\n    let mappedInputValue;\n    if (commandType == \"brightness\") {\n        maxLevel = parseFloatIfString(payload.entity_attributes.brightness_levels);\n        mappedInputValue = mapInputBrightness(payload, maxLevel);\n        currentValue = parseFloatIfString(payload.entity_state.brightness);\n    } else if (commandType === \"color_temp\") {\n        maxLevel = parseFloatIfString(payload.entity_attributes.color_temp_levels);\n        mappedInputValue = parseFloatIfString(payload.data.color_temp);\n        mappedInputValue = mapRange(\n            mappedInputValue,\n            MIN_COLOR_TEMP,\n            MAX_COLOR_TEMP,\n            MIN_LEVEL,\n            maxLevel\n        );\n        currentValue = parseFloatIfString(payload.entity_state.color_temp);\n    }\n    return { maxLevel, currentValue, mappedInputValue };\n}\nfunction getFanPayloadValues(payload, commandType) {\n    let maxLevel;\n    let currentValue;\n    let mappedInputValue;\n    if (commandType == \"speed\") {\n        maxLevel = parseFloatIfString(payload.entity_attributes.speed_levels);\n        mappedInputValue = mapRange(\n            parseFloatIfString(payload.data.percentage),\n            MIN_PERCENTAGE,\n            MAX_PERCENTAGE,\n            MIN_LEVEL,\n            maxLevel\n        );\n        currentValue = parseFloatIfString(payload.entity_state.speed);\n    }\n    return { maxLevel, currentValue, mappedInputValue };\n}\nfunction calcPayloadAttributeState(payload, commandType) {\n    const DEFAULT_PAYLOAD = {\n        currentValue: void 0,\n        reverseMappedInputValue: void 0,\n        delta: void 0,\n        percentage: void 0\n    };\n    const { maxLevel, currentValue, mappedInputValue } = (() => {\n        if (isLightServiceCallPayload(payload)) {\n            return getLightPayloadValues(payload, commandType);\n        } else if (isFanServiceCallPayload(payload)) {\n            return getFanPayloadValues(payload, commandType);\n        }\n    })();\n    if (mappedInputValue == void 0) {\n        return DEFAULT_PAYLOAD;\n    }\n    const currentMappedValue = mapRange(\n        currentValue,\n        MIN_UNIT,\n        MAX_UNIT,\n        MIN_LEVEL,\n        maxLevel\n    );\n    const reverseMappedInputValue = mapRange(\n        mappedInputValue,\n        MIN_LEVEL,\n        maxLevel,\n        MIN_UNIT,\n        MAX_UNIT\n    );\n    const delta = Math.round(mappedInputValue - currentMappedValue);\n    const percentage = mappedInputValue / maxLevel;\n    return {\n        currentValue,\n        reverseMappedInputValue,\n        delta,\n        percentage\n    };\n}\nfunction createOnServiceCall$1(payload) {\n    let serviceCalls = [];\n    const { controller_id, device } = payload.target;\n    const { entity_state: entity_state2, data: data2 } = payload;\n    const {\n        currentValue: currentBrightness,\n        reverseMappedInputValue: reverseMappedInputBrightness,\n        delta: brightnessDelta,\n        percentage: brightnessPercentage\n    } = calcPayloadAttributeState(payload, \"brightness\");\n    if (currentBrightness === 0 || entity_state2.state === \"off\") {\n        serviceCalls.push({\n            service: \"send_command\",\n            domain: \"remote\",\n            target: {\n                entity_id: controller_id\n            },\n            data: {\n                ...DEFAULT_REMOTE_DATA,\n                device,\n                command: LightCommand.TURN_ON\n            }\n        });\n    } else if (brightnessPercentage === 0) {\n        return createOffServiceCall$1(payload);\n    }\n    if (reverseMappedInputBrightness != void 0 && !Number.isNaN(reverseMappedInputBrightness)) {\n        const brightnessDirection = brightnessDelta > 0 ? LightCommand.BRIGHTNESS_UP : LightCommand.BRIGHTNESS_DOWN;\n        entity_state2.brightness = reverseMappedInputBrightness;\n        serviceCalls.push({\n            service: \"send_command\",\n            domain: \"remote\",\n            target: {\n                entity_id: controller_id\n            },\n            data: {\n                ...DEFAULT_REMOTE_DATA,\n                num_repeats: Math.abs(brightnessDelta),\n                device,\n                command: brightnessDirection\n            }\n        });\n    }\n    const {\n        currentValue: currentColorTemp,\n        reverseMappedInputValue: reverseMappedInputColorTemp,\n        delta: colorTempDelta\n    } = calcPayloadAttributeState(payload, \"color_temp\");\n    if (reverseMappedInputColorTemp != void 0 && !Number.isNaN(reverseMappedInputColorTemp)) {\n        const colorTempDirection = colorTempDelta > 0 ? LightCommand.TEMPERATURE_DOWN : LightCommand.TEMPERATURE_UP;\n        entity_state2.color_temp = reverseMappedInputColorTemp;\n        serviceCalls.push({\n            service: \"send_command\",\n            domain: \"remote\",\n            target: {\n                entity_id: controller_id\n            },\n            data: {\n                ...DEFAULT_REMOTE_DATA,\n                num_repeats: Math.abs(colorTempDelta),\n                device,\n                command: colorTempDirection\n            }\n        });\n    }\n    entity_state2.state = \"on\";\n    return serviceCalls;\n}\nfunction createOffServiceCall$1(payload) {\n    const { controller_id, device } = payload.target;\n    const { entity_state: entity_state2 } = payload;\n    entity_state2.state = \"off\";\n    return [\n        {\n            service: \"send_command\",\n            domain: \"remote\",\n            target: {\n                entity_id: controller_id\n            },\n            data: {\n                ...DEFAULT_REMOTE_DATA,\n                device,\n                command: LightCommand.TURN_OFF\n            }\n        }\n    ];\n}\nfunction createToggleServiceCall$1(payload) {\n    const { entity_state: entity_state2 } = payload;\n    const newState = entity_state2.state === \"off\" ? \"on\" : \"off\";\n    const serviceCall = entity_state2.state === \"off\" ? createOnServiceCall$1(payload) : createOffServiceCall$1(payload);\n    entity_state2.state = newState;\n    return serviceCall;\n}\nfunction createServiceCall$1(payload) {\n    switch (payload.service) {\n        case \"turn_on\":\n            return createOnServiceCall$1(payload);\n        case \"turn_off\":\n            return createOffServiceCall$1(payload);\n        case \"toggle\":\n            return createToggleServiceCall$1(payload);\n        default:\n            return void 0;\n    }\n}\nfunction createOnServiceCall(payload) {\n    let serviceCalls = [];\n    const { controller_id, device } = payload.target;\n    const { entity_state: entity_state2 } = payload;\n    const {\n        currentValue: currentSpeed,\n        reverseMappedInputValue: reverseMappedInputSpeed,\n        delta: speedDelta,\n        percentage: speedPercentage\n    } = calcPayloadAttributeState(payload, \"speed\");\n    if (currentSpeed === 0 || entity_state2.state === \"off\") {\n        serviceCalls.push({\n            service: \"send_command\",\n            domain: \"remote\",\n            target: {\n                entity_id: controller_id\n            },\n            data: {\n                ...DEFAULT_REMOTE_DATA,\n                device,\n                command: FanCommand.TURN_ON\n            }\n        });\n    } else if (speedPercentage === 0) {\n        return createOffServiceCall(payload);\n    }\n    if (reverseMappedInputSpeed != void 0) {\n        const speedDirection = speedDelta > 0 ? FanCommand.INCREASE_SPEED : FanCommand.DECREASE_SPEED;\n        entity_state2.speed = reverseMappedInputSpeed;\n        serviceCalls.push({\n            service: \"send_command\",\n            domain: \"remote\",\n            target: {\n                entity_id: controller_id\n            },\n            data: {\n                ...DEFAULT_REMOTE_DATA,\n                num_repeats: Math.abs(speedDelta),\n                device,\n                command: speedDirection\n            }\n        });\n    }\n    entity_state2.state = \"on\";\n    return serviceCalls;\n}\nfunction createOffServiceCall(payload) {\n    const { controller_id, device } = payload.target;\n    const { entity_state: entity_state2 } = payload;\n    entity_state2.state = \"off\";\n    return [\n        {\n            service: \"send_command\",\n            domain: \"remote\",\n            target: {\n                entity_id: controller_id\n            },\n            data: {\n                ...DEFAULT_REMOTE_DATA,\n                device,\n                command: FanCommand.TURN_OFF\n            }\n        }\n    ];\n}\nfunction createToggleServiceCall(payload) {\n    const { entity_state: entity_state2 } = payload;\n    const newState = entity_state2.state === \"off\" ? \"on\" : \"off\";\n    const serviceCall = entity_state2.state === \"off\" ? createOnServiceCall(payload) : createOffServiceCall(payload);\n    entity_state2.state = newState;\n    return serviceCall;\n}\nfunction setPresetModeServiceCall(payload) {\n    const { controller_id, device } = payload.target;\n    const { data: data2 } = payload;\n    return [\n        {\n            service: \"send_command\",\n            domain: \"remote\",\n            target: {\n                entity_id: controller_id\n            },\n            data: {\n                ...DEFAULT_REMOTE_DATA,\n                device,\n                command: data2.preset_mode\n            }\n        }\n    ];\n}\nfunction oscillateServiceCall(payload) {\n    const { controller_id, device } = payload.target;\n    const { data: data2, entity_state: entity_state2 } = payload;\n    entity_state2.oscillating = data2.oscillating;\n    return [\n        {\n            service: \"send_command\",\n            domain: \"remote\",\n            target: {\n                entity_id: controller_id\n            },\n            data: {\n                ...DEFAULT_REMOTE_DATA,\n                device,\n                command: data2.oscillating ? FanCommand.OSCILLATE_ON : FanCommand.OSCILLATE_OFF\n            }\n        }\n    ];\n}\nfunction increaseSpeedServiceCall(payload) {\n    const { controller_id, device } = payload.target;\n    const { data: data2 } = payload;\n    return [\n        {\n            service: \"send_command\",\n            domain: \"remote\",\n            target: {\n                entity_id: controller_id\n            },\n            data: {\n                ...DEFAULT_REMOTE_DATA,\n                device,\n                command: FanCommand.INCREASE_SPEED,\n                num_repeats: data2.percentage_step\n            }\n        }\n    ];\n}\nfunction decreaseSpeedServiceCall(payload) {\n    const { controller_id, device } = payload.target;\n    const { data: data2 } = payload;\n    return [\n        {\n            service: \"send_command\",\n            domain: \"remote\",\n            target: {\n                entity_id: controller_id\n            },\n            data: {\n                ...DEFAULT_REMOTE_DATA,\n                device,\n                command: FanCommand.DECREASE_SPEED,\n                num_repeats: data2.percentage_step\n            }\n        }\n    ];\n}\nfunction createServiceCall(payload) {\n    switch (payload.service) {\n        case \"turn_on\":\n            return createOnServiceCall(payload);\n        case \"turn_off\":\n            return createOffServiceCall(payload);\n        case \"toggle\":\n            return createToggleServiceCall(payload);\n        case \"set_preset_mode\":\n            return setPresetModeServiceCall(payload);\n        case \"oscillate\":\n            return oscillateServiceCall(payload);\n        case \"increase_speed\":\n            return increaseSpeedServiceCall(payload);\n        case \"decrease_speed\":\n            return decreaseSpeedServiceCall(payload);\n        default:\n            return void 0;\n    }\n}\nconst entity_attributes = JSON.parse(msg.payload.entity_attributes);\nconst entity_state = JSON.parse(msg.payload.entity_state);\nconst { domain, service, target, data } = msg.payload;\nmsg.payload = (() => {\n    const remoteServiceCallPayload = {\n        domain,\n        service,\n        target,\n        data,\n        entity_state,\n        entity_attributes\n    };\n    switch (domain) {\n        case \"light\":\n            return createServiceCall$1(\n                remoteServiceCallPayload\n            );\n        case \"fan\":\n            return createServiceCall(\n                remoteServiceCallPayload\n            );\n        default:\n            return [];\n    }\n})();\nmsg.entity_state = JSON.stringify(entity_state);\nmsg.entity_state_id = target.entity_state_id;\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1450,"y":380,"wires":[["3fb04e972820029e","97447b6fc2c005a8"]]},{"id":"3072696b544e79b2","type":"api-call-service","z":"6337f535d7b8e1f2","name":"","server":"79544c2b.6ccc64","version":7,"debugenabled":false,"floorId":[],"areaId":[],"deviceId":[],"entityId":[],"labelId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","blockInputOverrides":false,"domain":"","service":"","x":2190,"y":380,"wires":[["66500db66c8720ec"]]},{"id":"d47901bddac291f5","type":"ha-api","z":"6337f535d7b8e1f2","name":"set entity state","server":"79544c2b.6ccc64","version":1,"debugenabled":false,"protocol":"http","method":"post","path":"/api/states/{{payload.entity_id}}","data":"payload","dataType":"jsonata","responseType":"json","outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"results"}],"x":2800,"y":380,"wires":[["059a374f75100241"]]},{"id":"fc615b54a684209d","type":"ha-api","z":"6337f535d7b8e1f2","name":"get entity state","server":"79544c2b.6ccc64","version":1,"debugenabled":false,"protocol":"http","method":"get","path":"/api/states/{{entity_state_id}}","data":"","dataType":"jsonata","responseType":"json","outputProperties":[{"property":"new_payload","propertyType":"msg","value":"","valueType":"results"}],"x":2520,"y":380,"wires":[["63b47b4ef98ed9b2"]]},{"id":"63b47b4ef98ed9b2","type":"change","z":"6337f535d7b8e1f2","name":"set state","rules":[{"t":"set","p":"new_payload.state","pt":"msg","to":"entity_state","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"new_payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2660,"y":380,"wires":[["d47901bddac291f5"]]},{"id":"9e85c5455ca04b9a","type":"split","z":"6337f535d7b8e1f2","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1870,"y":380,"wires":[["de7e5f9dfecc408b"]]},{"id":"274deb9de88f8cd7","type":"debug","z":"6337f535d7b8e1f2","name":"debug 24","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1220,"y":600,"wires":[]},{"id":"3fb04e972820029e","type":"delay","z":"6337f535d7b8e1f2","name":"","pauseType":"delay","timeout":"0.1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1690,"y":380,"wires":[["9e85c5455ca04b9a"]]},{"id":"de7e5f9dfecc408b","type":"delay","z":"6337f535d7b8e1f2","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":2030,"y":380,"wires":[["3072696b544e79b2"]]},{"id":"66500db66c8720ec","type":"join","z":"6337f535d7b8e1f2","name":"","mode":"auto","build":"object","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":2350,"y":380,"wires":[["fc615b54a684209d"]]}]